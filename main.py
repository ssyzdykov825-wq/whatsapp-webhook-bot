import os
import requests
from flask import Flask, request, jsonify
from openai import OpenAI

app = Flask(__name__)
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

WHATSAPP_API_URL = "https://waba-v2.360dialog.io/messages"
WHATSAPP_API_KEY = os.environ.get("WHATSAPP_API_KEY")

HEADERS = {
    "Content-Type": "application/json",
    "D360-API-KEY": WHATSAPP_API_KEY
}

# –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—ç—Ç–∞–ø —Å–∫—Ä–∏–ø—Ç–∞)
user_states = {}

# –®–∞–≥–∏ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–¥–∞–∂
sales_script = [
    "–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ! –ú–µ–Ω Healvix –∫–æ–º–ø–∞–Ω–∏—è—Å—ã–Ω–∞–Ω –ê–π–¥–æ—Å–ø—ã–Ω. –°—ñ–∑ ”©—Ç—ñ–Ω—ñ–º “õ–∞–ª–¥—ã—Ä“ì–∞–Ω –µ–¥—ñ“£—ñ–∑ ‚Äî 1-2 –º–∏–Ω—É—Ç —Å”©–π–ª–µ—Å—É–≥–µ —ã“£“ì–∞–π–ª—ã –º–∞?",
    "”®—Ç—ñ–Ω—ñ–º–¥—ñ ”©–∑—ñ“£—ñ–∑ “Ø—à—ñ–Ω “õ–∞–ª–¥—ã—Ä–¥—ã“£—ã–∑ –±–∞, ”ô–ª–¥–µ –∂–∞“õ—ã–Ω–¥–∞—Ä—ã“£—ã–∑“ì–∞ –º–∞? “ö–∞–Ω–¥–∞–π –±–µ–ª–≥—ñ–ª–µ—Ä –º–∞–∑–∞–ª–∞–π–¥—ã ‚Äî –∫”©–∑–¥—ñ“£ —à–∞—Ä—à–∞—É—ã, –±“±–ª—ã“£“ì—ã—Ä –∫”©—Ä—É, –∫”©—Ä—É “õ–∞–±—ñ–ª–µ—Ç—ñ–Ω—ñ“£ —Ç”©–º–µ–Ω–¥–µ—É—ñ?",
    "–ò”ô, —ç–∫—Ä–∞–Ω, —Å—Ç—Ä–µ—Å—Å, –∂–∞—Å –µ—Ä–µ–∫—à–µ–ª—ñ–∫—Ç–µ—Ä—ñ ‚Äî –±“±–ª–∞—Ä–¥—ã“£ –±”ô—Ä—ñ –∫”©–∑–≥–µ –∞—É—ã—Ä–ª—ã“õ —Ç“Ø—Å—ñ—Ä–µ–¥—ñ. –ë—ñ—Ä–∞“õ –±–∞—Å—Ç–∞–ø“õ—ã –±–µ–ª–≥—ñ–ª–µ—Ä–¥—ñ –µ–ª–µ–º–µ—É ‚Äî –∫–µ–π—ñ–Ω “Ø–ª–∫–µ–Ω –ø—Ä–æ–±–ª–µ–º–∞“ì–∞ –∞–π–Ω–∞–ª—É—ã –º“Ø–º–∫—ñ–Ω.",
    "–ö”©—Ä—É “õ–∞–±—ñ–ª–µ—Ç—ñ–Ω –∂–æ“ì–∞–ª—Ç—É ‚Äî –∂–∞–π “ì–∞–Ω–∞ —ã“£“ì–∞–π—Å—ã–∑–¥—ã“õ –µ–º–µ—Å. –ë“±–ª ‚Äî –∫—ñ—Ç–∞–ø –æ“õ–∏ –∞–ª–º–∞—É, –∫”©–ª—ñ–∫ –∂“Ø—Ä–≥—ñ–∑–µ –∞–ª–º–∞—É, –∂–∞“õ—ã–Ω–¥–∞—Ä—ã“£—ã–∑–¥—ã –∞–Ω—ã“õ –∫”©—Ä–µ –∞–ª–º–∞—É. –°—ñ–∑ –¥“±—Ä—ã—Å “õ–∞–¥–∞–º –∂–∞—Å–∞–¥—ã“£—ã–∑.",
    "Healvix ‚Äî –±“±–ª –∫”©–∑–¥—ñ —Ç–∞–±–∏“ì–∏ –∂–æ–ª–º–µ–Ω “õ–æ—Ä“ì–∞–π—Ç—ã–Ω –∂”ô–Ω–µ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä–µ—Ç—ñ–Ω –∫–µ—à–µ–Ω. “ö“±—Ä–∞–º—ã–Ω–¥–∞ —á–µ—Ä–Ω–∏–∫–∞, –ª—é—Ç–µ–∏–Ω, –í –¥”ô—Ä—É–º–µ–Ω–¥–µ—Ä—ñ –±–∞—Ä.",
    "“ö–∞–∑—ñ—Ä —Å—ñ–∑–¥—ñ“£ ”©—Ç—ñ–Ω—ñ–º—ñ“£—ñ–∑ –±–æ–π—ã–Ω—à–∞ –∞—Ä–Ω–∞–π—ã –∂–µ“£—ñ–ª–¥—ñ–∫ –±–∞—Ä. –ñ–µ—Ç–∫—ñ–∑—É —Ç–µ–≥—ñ–Ω, —Ç”©–ª–µ–º ‚Äî –∞–ª“ì–∞–Ω –∫–µ–∑–¥–µ. “ö–∞–ª–∞–π—Å—ã–∑: –±—ñ—Ä –∞–π–ª—ã“õ –∫—É—Ä—Å –ø–∞, ”ô–ª–¥–µ —Ç–æ–ª—ã“õ –Ω”ô—Ç–∏–∂–µ “Ø—à—ñ–Ω 2‚Äì3 –∞–π“ì–∞ –∞–ª–∞–º—ã–∑ –±–∞?",
    "–û–Ω–¥–∞ –∫–µ–ª—ñ—Å—Ç—ñ–∫, —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç—ã —Ä”ô—Å—ñ–º–¥–µ–π—ñ–∫. –ê—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑, –º–µ–∫–µ–Ω–∂–∞–π –∂”ô–Ω–µ –±–∞–π–ª–∞–Ω—ã—Å –Ω”©–º—ñ—Ä—ñ“£—ñ–∑–¥—ñ –∂—ñ–±–µ—Ä—Å–µ“£—ñ–∑ –±–æ–ª–¥—ã. –ö—É—Ä—å–µ—Ä –∂–µ—Ç–∫—ñ–∑–µ–¥—ñ, —Ç”©–ª–µ–º ‚Äî –∞–ª“ì–∞–Ω –∫–µ–∑–¥–µ.",
    "–¢–∞–ø—Å—ã—Ä—ã—Å “õ–∞–±—ã–ª–¥–∞–Ω–¥—ã! –ñ–∞“õ—ã–Ω –∫“Ø–Ω–¥–µ—Ä—ñ —Å—ñ–∑–±–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å–∞–º—ã–∑. –ö”©—Ä—É “õ–∞–±—ñ–ª–µ—Ç—ñ“£—ñ–∑–≥–µ –±“Ø–≥—ñ–Ω–Ω–µ–Ω –±–∞—Å—Ç–∞–ø “õ–∞–º“õ–æ—Ä–ª—ã“õ –∂–∞—Å–∞“ì–∞–Ω—ã“£—ã–∑ –¥“±—Ä—ã—Å —à–µ—à—ñ–º. –ö“Ø–Ω—ñ“£—ñ–∑ —Å”ô—Ç—Ç—ñ ”©—Ç—Å—ñ–Ω!"
]

# –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è
objection_responses = {
    "“õ—ã–º–±–∞—Ç": "–¢“Ø—Å—ñ–Ω–µ–º—ñ–Ω, –±—ñ—Ä–∞“õ –∫”©—Ä—É ‚Äî –∫–µ–π—ñ–Ω–≥–µ “õ–∞–ª–¥—ã—Ä—É“ì–∞ –±–æ–ª–º–∞–π—Ç—ã–Ω –Ω”ô—Ä—Å–µ. “ö–∞–∑—ñ—Ä –±—ñ—Ä “õ–∞–ø—Ç–∞–º–∞–º–µ–Ω –±–∞—Å—Ç–∞–ø –∫”©—Ä—É–≥–µ –±–æ–ª–∞–¥—ã. –¢”ô—É–µ–∫–µ–ª –∂–æ“õ.",
    "–æ–π–ª–∞–Ω–∞–º": "”ò—Ä–∏–Ω–µ. –ë—ñ—Ä–∞“õ –¥”ô–ª “õ–∞–∑—ñ—Ä –∞–ª–¥—ã–Ω –∞–ª—É ‚Äî –µ“£ —Ç–∏—ñ–º–¥—ñ –∂–æ–ª. –ö–µ–π—ñ–Ω –∫”©—Ä—É–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É ”ô–ª–¥–µ“õ–∞–π–¥–∞ “õ–∏—ã–Ω.",
    "–æ–Ω—à–∞ –∂–∞–º–∞–Ω –µ–º–µ—Å": "–î”ô–ª –æ—Å—ã–Ω–¥–∞–π –∫–µ–∑–µ“£ ‚Äî –∞–ª–¥—ã–Ω –∞–ª—É“ì–∞ —Ç–∞–ø—Ç—ã—Ä–º–∞—Å —É–∞“õ—ã—Ç. Healvix ‚Äî –±“±–ª –∫”©–∑–≥–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω –∫“Ø–Ω–¥–µ–ª—ñ–∫—Ç—ñ –∫“Ø—Ç—ñ–º —Å–∏—è“õ—Ç—ã.",
    "—Å–µ–Ω–±–µ–π–º—ñ–Ω": "–ö–ª–∏–µ–Ω—Ç—Ç–µ—Ä–¥—ñ“£ 80%-–¥–∞–Ω –∞—Å—Ç–∞–º—ã –∫”©–∑—ñ–Ω—ñ“£ –¥–µ–º–∞–ª—ã–ø, –∫”©—Ä—É—ñ–Ω—ñ“£ –∂–∞“õ—Å–∞—Ä“ì–∞–Ω—ã–Ω –±–∞–π“õ–∞–ø –æ—Ç—ã—Ä. Healvix ‚Äî –±“±–ª –Ω–∞“õ—Ç—ã –Ω”ô—Ç–∏–∂–µ “Ø—à—ñ–Ω."
}

def send_whatsapp_message(recipient_phone, message_text):
    payload = {
        "messaging_product": "whatsapp",
        "to": recipient_phone,
        "type": "text",
        "text": {"body": message_text}
    }
    response = requests.post(WHATSAPP_API_URL, headers=HEADERS, json=payload)
    print(f"üì§ –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {response.status_code} {response.text}")
    return response

@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.get_json()
    print("üì© –í—Ö–æ–¥—è—â–∏–π JSON:", data)

    try:
        messages = data["entry"][0]["changes"][0]["value"].get("messages")
        if messages:
            user_message = messages[0]["text"]["body"].lower()
            user_phone = messages[0]["from"]
            print(f"üí¨ {user_phone}: {user_message}")

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è
            for keyword, response in objection_responses.items():
                if keyword in user_message:
                    send_whatsapp_message(user_phone, response)
                    return jsonify({"status": "ok"}), 200

            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
            step = user_states.get(user_phone, 0)

            if step < len(sales_script):
                send_whatsapp_message(user_phone, sales_script[step])
                user_states[user_phone] = step + 1
            else:
                send_whatsapp_message(user_phone, "“ö–æ—Å—ã–º—à–∞ —Å“±—Ä–∞“õ—Ç–∞—Ä—ã“£—ã–∑ –±–æ–ª—Å–∞, –∂–∞–∑—ã“£—ã–∑!")
    except Exception as e:
        print(f"‚ùå GPT “õ–∞—Ç–µ—Å—ñ: {e}")
        send_whatsapp_message(user_phone, "–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, —É–∞“õ—ã—Ç—à–∞ “õ–∞—Ç–µ —à—ã“õ—Ç—ã. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ “õ–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.")

    return jsonify({"status": "ok"}), 200

@app.route('/', methods=['GET'])
def home():
    return "–ë–æ—Ç —ñ—Å–∫–µ “õ–æ—Å—ã–ª–¥—ã!", 200

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
