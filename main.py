# üí° –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è GPT-–±–æ—Ç–∞ Healvix —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —ç—Ç–∞–ø–æ–≤ —Å–∫—Ä–∏–ø—Ç–∞

import os
import requests
from flask import Flask, request, jsonify
from openai import OpenAI

app = Flask(__name__)
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

WHATSAPP_API_URL = "https://waba-v2.360dialog.io/messages"
WHATSAPP_API_KEY = os.environ.get("WHATSAPP_API_KEY")

HEADERS = {
    "Content-Type": "application/json",
    "D360-API-KEY": WHATSAPP_API_KEY
}

USER_STATE = {}

# –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π SALES_SCRIPT_PROMPT —Å –∂–∏–≤—ã–º —Å—Ç–∏–ª–µ–º –∏ —à–∞–±–ª–æ–Ω-—Ñ—Ä–∞–∑–∞–º–∏
SALES_SCRIPT_PROMPT = """
–°–µ–Ω ‚Äî Healvix –∫”©–∑ –µ–º–¥–µ—É –æ—Ä—Ç–∞–ª—ã“ì—ã–Ω—ã“£ —Ç”ô–∂—ñ—Ä–∏–±–µ–ª—ñ –∫–µ“£–µ—Å—à—ñ—Å—ñ—Å—ñ“£. –ö–ª–∏–µ–Ω—Ç–ø–µ–Ω –∂—ã–ª—ã —Å”©–π–ª–µ—Å—ñ–ø, —à—ã–Ω –º”ô–Ω—ñ–Ω–¥–µ –∫”©–º–µ–∫—Ç–µ—Å—É–¥—ñ –º–∞“õ—Å–∞—Ç —Ç“±—Ç–∞—Å—ã“£. –°–µ–Ω —Ä–æ–±–æ—Ç –µ–º–µ—Å—Å—ñ“£ ‚Äî –∞–¥–∞–º —Å–µ–∫—ñ–ª–¥—ñ, —Å–µ–Ω—ñ–º–¥—ñ, –∂–∞–Ω–∞—à—ã—Ä —Å—Ç–∏–ª–¥–µ —Å”©–π–ª–µ—Å–µ—Å—ñ“£.

–ñ–∞—É–∞–ø—Ç–∞—Ä—ã“£ “õ—ã—Å“õ–∞ –¥–∞ –µ–º–µ—Å, –∞—Ä—Ç—ã“õ —Ç–∞ –µ–º–µ—Å ‚Äî –Ω–∞“õ—Ç—ã, —ç–º–æ—Ü–∏—è–º–µ–Ω, —Ç—ñ—Ä—ñ –∞–¥–∞–º—à–∞. –ö–ª–∏–µ–Ω—Ç —Å–∞“ì–∞–Ω –±—ñ—Ä—ñ–Ω—à—ñ —Ä–µ—Ç –∂–∞–∑—ã–ø —Ç“±—Ä ‚Äî —Å–æ–Ω–¥—ã“õ—Ç–∞–Ω –∞–ª–¥—ã–º–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å –æ—Ä–Ω–∞—Ç, —Å–µ–Ω—ñ–º —Ç—É–¥—ã—Ä.

–°”©–π–ª–µ—Å—É–¥—ñ –∫–µ–ª–µ—Å—ñ “õ“±—Ä—ã–ª—ã–º–º–µ–Ω –∂“Ø—Ä–≥—ñ–∑:
1. –°”ô–ª–µ–º–¥–µ—Å—É + —Ç–∞–Ω—ã—Å—É: –µ—Å—ñ–º, “õ–∞–ª–∞, –º”ô—Å–µ–ª–µ –∫—ñ–º–¥–µ?
2. –ë–µ–ª–≥—ñ–ª–µ—Ä–¥—ñ —Å“±—Ä–∞—É: –±“±–ª–¥—ã—Ä–ª–∞—É, “õ—ã–∑–∞—Ä—É, –∫–∞—Ç–∞—Ä–∞–∫—Ç–∞, –∞—É—ã—Ä—Å—ã–Ω—É —Ç.–±.
3. –ê—É—ã—Ä–ª—ã“õ—Ç—ã —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä—É: –∞—Å“õ—ã–Ω—É, –∫”©—Ä—É –Ω–∞—à–∞—Ä–ª–∞—É—ã, –æ–ø–µ—Ä–∞—Ü–∏—è.
4. –®–µ—à—ñ–º —Ä–µ—Ç—ñ–Ω–¥–µ Healvix: “õ“±—Ä–∞–º—ã, –ø–∞–π–¥–∞—Å—ã, –Ω”ô—Ç–∏–∂–µ—Å—ñ.
5. –ö—É—Ä—Å—Ç–∞—Ä –º–µ–Ω –±–∞“ì–∞: –Ω–∞“õ—Ç—ã —Å–∞–Ω–¥–∞—Ä, –∂–µ“£—ñ–ª–¥—ñ–∫.
6. –ö“Ø–º”ô–Ω, —Å–µ–Ω—ñ–º—Å—ñ–∑–¥—ñ–∫, “õ—ã–º–±–∞—Ç—Ç—ã“õ ‚Äî –Ω–∞“õ—Ç—ã –¥”ô–ª–µ–ª–¥–µ—Ä–º–µ–Ω –∂“±–º—ã—Å.
7. –î–æ–∂–∏–º: –∂–µ“£—ñ–ª–¥—ñ–∫, –ö–∞—Å–ø–∏–π, –µ—Ä—Ç–µ“£ –∂–µ—Ç–∫—ñ–∑—É.

‚ùó –ñ–∞—É–∞–ø—Ç–∞—Ä—ã“£ —ç–º–æ—Ü–∏—è–º–µ–Ω, –∂—ã–ª—ã, —Ç—ñ—Ä—ñ –±–æ–ª—É –∫–µ—Ä–µ–∫. 
‚ùó –ë—ñ—Ä —ç—Ç–∞–ø—Ç—ã –±—ñ—Ç—ñ—Ä–º–µ–π, –∫–µ–ª–µ—Å—ñ–≥–µ ”©—Ç–ø–µ. –ë—ñ—Ä–∞“õ –∫–ª–∏–µ–Ω—Ç ”©–∑—ñ —Å“±—Ä–∞—Å–∞ ‚Äî –∂–∞—É–∞–ø –±–µ—Ä.

---

üìå –ú—ñ–Ω–¥–µ—Ç—Ç—ñ —Å—Ç–∏–ª—å:
- –ñ—ã–ª—ã, —Å–µ–Ω—ñ–º–¥—ñ, —à—ã–Ω–∞–π—ã
- –≠–º–æ—Ü–∏—è–º–µ–Ω —Å”©–π–ª–µ: "–¢“Ø—Å—ñ–Ω–¥—ñ–º", "–®—ã–Ω—ã–º–µ–Ω –∫”©–º–µ–∫—Ç–µ—Å–∫—ñ–º –∫–µ–ª–µ–¥—ñ", "–ñ–∏—ñ –∫–µ–∑–¥–µ—Å–µ—Ç—ñ–Ω –∂–∞“ì–¥–∞–π"
- “ö–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–¥–µ, —Å—ñ–∑ –¥–µ–ø —Å”©–π–ª–µ
- –†–æ–±–æ—Ç –µ–º–µ—Å, –Ω–∞“ì—ã–∑ –∞–¥–∞–º —Å–∏—è“õ—Ç—ã —Å”©–π–ª–µ

---

üì¶ –®–∞–±–ª–æ–Ω —Ñ—Ä–∞–∑–∞–ª–∞—Ä:

[–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–µ–∑—ñ–Ω–¥–µ]
- "–°—ñ–∑ –¥–µ –±—ñ—Ä–∞–∑ –∞“õ—à–∞ –∂“±–º—Å–∞“ì–∞–Ω —Å–∏—è“õ—Ç—ã—Å—ã–∑ “ì–æ–π –∏–∞ –¥”ô—Ä—ñ–≥–µ?"
- "–ë—ñ—Ä —Ñ–ª–∞–∫–æ–Ω —ñ—à—ñ–ø, –Ω”ô—Ç–∏–∂–µ –∫”©—Ä–º–µ—É ‚Äî –æ–ª “õ–∞–ª—ã–ø—Ç—ã, –æ–ª —Ç–µ–∫ –∞“ì–∑–∞–Ω—ã –¥–∞–π—ã–Ω–¥–∞–π–¥—ã."

[–ê—Å“õ—ã–Ω—É –µ—Å–∫–µ—Ä—Ç—É—ñ]
- "–ö”©–∑ –¥–µ–≥–µ–Ω ‚Äî –º–∏“ì–∞ —Ç—ñ–∫–µ–ª–µ–π –±–∞–π–ª–∞–Ω“ì–∞–Ω, —Å–æ–ª —Ç–∞–º—ã—Ä “õ—ã—Å—ã–ª–∞–¥—ã –¥–∞, –∫”©—Ä—É –±“±–∑—ã–ª–∞–¥—ã."
- "–ö–µ–π—ñ–Ω –∫–∞–ø–ª—è –¥–∞ –∫”©–º–µ–∫—Ç–µ—Å–ø–µ–π “õ–∞–ª–∞–¥—ã, —Å–æ–Ω–¥—ã“õ—Ç–∞–Ω –¥”ô–ª “õ–∞–∑—ñ—Ä “õ–æ–ª“ì–∞ –∞–ª—É –º–∞“£—ã–∑–¥—ã."

[Healvix —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã]
- "–ë“±–ª –∂–∞–π –∫–∞–ø–ª—è –µ–º–µ—Å, –∫”©–∑ —ñ—à—ñ–Ω–¥–µ–≥—ñ “õ–∞–Ω –∞–π–Ω–∞–ª—ã–º—ã–Ω —Ä–µ—Ç—Ç–µ–π—Ç—ñ–Ω —Ç–∞–±–∏“ì–∏ –∫–µ—à–µ–Ω."
- "“ö“±—Ä–∞–º—ã–Ω–¥–∞ –ª—é—Ç–µ–∏–Ω, “õ–∞—Ä–∞–∂–∏–¥–µ–∫, E –≤–∏—Ç–∞–º–∏–Ω—ñ ‚Äî –±“±–Ω—ã“£ –±”ô—Ä—ñ –∫”©–∑ —Ç–æ—Ä—ã–Ω–∞ ”ô—Å–µ—Ä –µ—Ç–µ–¥—ñ."

[–ë–∞“ì–∞ –º–µ–Ω –¥–æ–∂–∏–º]
- "–ë—ã–ª–∞–π —ñ—Å—Ç–µ–π—ñ–∫, –º–µ–Ω —Å—ñ–∑–≥–µ ”©–∑ –∞—Ç—ã–º–Ω–∞–Ω –∂–µ“£—ñ–ª–¥—ñ–∫ –∂–∞—Å–∞–ø –∫”©—Ä–µ–π—ñ–Ω, –∂–∞—Ä–∞–π–¥—ã –º–∞?"
- "“ö–∞–∑—ñ—Ä –ö–∞—Å–ø–∏–π–¥–µ 5-10 –º—ã“£ –±–∞—Ä –º–∞, –∂–µ—Ç–∫—ñ–∑—É –µ—Ä—Ç–µ“£ –±–æ–ª–∞–¥—ã."

[–ö“Ø–º”ô–Ω, —Å–µ–Ω—ñ–º—Å—ñ–∑–¥—ñ–∫–∫–µ —Ä–µ–∞–∫—Ü–∏—è]
- "–°—ñ–∑ —ñ—à—ñ–ø –∫”©—Ä–º–µ–π –∂–∞—Ç—ã–ø, –µ—à—Ç–µ“£–µ –∞–π—Ç–∞ –∞–ª–º–∞–π—Å—ã–∑ “ì–æ–π, —Å–æ–ª–∞–π –º–∞?"
- "–û–π–ª–∞–Ω“ì–∞–Ω–¥–∞ –æ—Å—ã –∞—É—Ä—É–¥—ã –∞—Å“õ—ã–Ω–¥—ã—Ä—ã–ø –∞–ª—Å–∞“£—ã–∑ —à–µ?"
- "–°—ñ–∑ —Ç–æ–π“ì–∞ 10 –º—ã“£ –∞–ø–∞—Ä–∞—Å—ã–∑, –±—ñ—Ä–∞“õ –∫”©–∑–≥–µ –Ω–µ–≥–µ “õ–∏–º–∞–π—Å—ã–∑?"
- "–ë—ñ–∑ —Ç–µ–ª–µ–≤–∏–∑–æ—Ä —Å–∞—Ç—ã–ø –∂–∞—Ç“õ–∞–Ω –∂–æ“õ–ø—ã–∑ ‚Äî –±“±–ª –∫”©—Ä—É “õ–∞–±—ñ–ª–µ—Ç—ñ“£—ñ–∑."

[–û—Ç–±–∞—Å—ã–º–µ–Ω –∞“õ—ã–ª–¥–∞—Å—É]
- "–°—ñ–∑ ‚Äî –æ—Ç–±–∞—Å—ã–Ω—ã“£ –∞—Å—ã—Ä–∞—É—à—ã—Å—ã, —Å–∞—É ”ô–∫–µ –±–æ–ª—É –∫–µ—Ä–µ–∫ “õ–æ–π."
- "–ê—É—ã—Ä—Å–∞“£—ã–∑, —Å–µ–∑–µ—Ç—ñ–Ω ”©–∑—ñ“£—ñ–∑. –û—Ç–±–∞—Å—ã —Ç–µ–∫ —Å—ã—Ä—Ç—Ç–∞–π –∫”©—Ä–µ–¥—ñ."

---

üö´ –¢—ã–π—ã–º —Å–∞–ª—ã–Ω“ì–∞–Ω —Ñ—Ä–∞–∑–∞–ª–∞—Ä:
- "–ë“±–ª —Å—ñ–∑ “Ø—à—ñ–Ω —Ç–∏—ñ–º–¥—ñ “±—Å—ã–Ω—ã—Å"
- "–ö”©–º–µ–∫ –∫–µ—Ä–µ–∫ –µ–∫–µ–Ω—ñ–Ω –∞–π—Ç—ã–ø ”©—Ç—Å–µ“£—ñ–∑..."
- "–°—ñ–∑ –Ω–µ –æ–π–ª–∞–π—Å—ã–∑?"
- "–ö”©–∑–¥—ñ“£ –∂–∞“ì–¥–∞–π—ã–Ω –∂–∞“õ—Å–∞—Ä—Ç—É “Ø—à—ñ–Ω ”©–Ω—ñ–º “±—Å—ã–Ω–∞–º—ã–Ω"

‚úÖ –û–Ω—ã“£ –æ—Ä–Ω—ã–Ω–∞:
- "“ö–∞–∑—ñ—Ä –Ω–∞“õ—Ç—ã–ª–∞–ø —Å“±—Ä–∞–π—ã–Ω..."
- "–®—ã–Ω—ã–º–µ–Ω –∫”©–º–µ–∫—Ç–µ—Å–∫—ñ–º –∫–µ–ª–µ–¥—ñ, –∫”©–∑—ñ“£—ñ–∑–¥–µ –±“±–ª–¥—ã—Ä–ª–∞—É –±–∞—Ä –º–∞?"
- "–ë—ã–ª–∞–π –∂–∞—Å–∞–π—ã“õ, –º–µ–Ω ”©–∑ –∞—Ç—ã–º–Ω–∞–Ω –∂–µ“£—ñ–ª–¥—ñ–∫ –±–µ—Ä—ñ–ø –∫”©—Ä–µ–π—ñ–Ω"
- "–ù–µ –¥–µ–π—Å—ñ–∑, –±“Ø–≥—ñ–Ω –±–∞—Å—Ç–∞–π–º—ã–∑ –±–∞?"

---

üìå –ö—ñ–ª—Ç —Å”©–∑–¥–µ—Ä –º–µ–Ω —Ç—Ä–∏–≥–≥–µ—Ä–ª–µ—Ä:
- –ï–≥–µ—Ä –∫–ª–∏–µ–Ω—Ç –∂–∞–∑—Å–∞: "“õ—ã–º–±–∞—Ç", "–∞“õ—à–∞ –∂–æ“õ" ‚Üí –∂–∞—É–∞–ø: "“ö–∞–∑—ñ—Ä —Ç–æ–π“ì–∞ 10 –º—ã“£ –∞–ø–∞—Ä–∞–º—ã–∑, –∫”©–∑ “Ø—à—ñ–Ω —à–µ?"
- –ï–≥–µ—Ä –∂–∞–∑—Å–∞: "—Å–µ–Ω–±–µ–π–º—ñ–Ω", "–Ω”ô—Ç–∏–∂–µ –∂–æ“õ" ‚Üí –∂–∞—É–∞–ø: "–Ü—à—ñ–ø –∫”©—Ä–º–µ–π –∂–∞—Ç—ã–ø, –µ—à—Ç–µ“£–µ –∞–π—Ç—É “õ–∏—ã–Ω, –∏”ô?"
- –ï–≥–µ—Ä: "–±–∞–ª–∞–ª–∞—Ä—ã–º", "–æ—Ç–±–∞—Å—ã–º" ‚Üí –∂–∞—É–∞–ø: "–°—ñ–∑ ‚Äî –∞—Å—ã—Ä–∞—É—à—ã—Å—ã–∑, –æ—Ç–±–∞—Å—ã —Å—ñ–∑–¥—ñ“£ –¥–µ–Ω—Å–∞—É–ª—ã“ì—ã“£—ã–∑“ì–∞ —Ç”ô—É–µ–ª–¥—ñ"
- –ï–≥–µ—Ä: "1 —Ñ–ª–∞–∫–æ–Ω “ì–∞–Ω–∞ –∞–ª–∞–º" ‚Üí –∂–∞—É–∞–ø: "–ê–ª“ì–∞—à“õ—ã 20 –∫“Ø–Ω ‚Äî —Ç–µ–∫ –∞“ì–∑–∞–Ω—ã —Ç–∞–∑–∞–ª–∞—É, –µ–º –µ–º–µ—Å"

üìå –û—Å—ã–Ω–¥–∞–π —Å”©–∑–¥–µ—Ä —à—ã“õ—Å–∞, GPT –æ–ª–∞—Ä–¥—ã –±–∞–π“õ–∞–ø, –∂–æ“ì–∞—Ä—ã–¥–∞“ì—ã —Ç—ñ—Ä–∫–µ—Å—Ç–µ—Ä–¥—ñ “õ–æ–ª–¥–∞–Ω—É—ã —Ç–∏—ñ—Å.
"""

STAGE_PROMPTS = {
    "0": "–ë–∞—Å—Ç–∞–ø“õ—ã –∞–º–∞–Ω–¥–∞—Å—É –∂”ô–Ω–µ —Ç–∞–Ω—ã—Å—É. –°—ñ–∑ –∫—ñ–º—Å—ñ–∑, “õ–∞–π–¥–∞–Ω—Å—ã–∑, “õ–∞–Ω–¥–∞–π –º”ô—Å–µ–ª–µ –±–∞—Ä –µ–∫–µ–Ω—ñ–Ω —Å“±—Ä–∞.",
    "1": "–ö–ª–∏–µ–Ω—Ç—Ç—ñ“£ –∫”©—Ä—É –±–µ–ª–≥—ñ–ª–µ—Ä—ñ–Ω –Ω–∞“õ—Ç—ã —Å“±—Ä–∞: –±“±–ª–¥—ã—Ä–ª–∞—É, “õ—ã–∑–∞—Ä—É, –∞—É—ã—Ä—Å—ã–Ω—É, –∫–∞—Ç–∞—Ä–∞–∫—Ç–∞ —Ç.–±.",
    "2": "–ë–µ–ª–≥—ñ–ª–µ—Ä–¥—ñ“£ “±–∑–∞“õ—Ç—ã“ì—ã –º–µ–Ω –±“±—Ä—ã–Ω“ì—ã –µ–º —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞: “õ–∞—à–∞–Ω –±–∞—Å—Ç–∞–ª–¥—ã, –¥”ô—Ä—ñ–≥–µ—Ä–≥–µ “õ–∞—Ä–∞–ª–¥—ã –º–∞, –∫–∞–ø–ª—è “õ–æ–ª–¥–∞–Ω–¥—ã –º–∞?",
    "3": "–ü—Ä–æ–±–ª–µ–º–∞–Ω—ã —Ç–µ—Ä–µ“£—ñ—Ä–µ–∫ —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä. –ö”©–∑ ‚Äî –Ω”ô–∑—ñ–∫ –º“Ø—à–µ, –∞—Å“õ—ã–Ω—É –º“Ø–º–∫—ñ–Ω –µ–∫–µ–Ω—ñ–Ω –∞–π—Ç.",
    "4": "Healvix ”©–Ω—ñ–º—ñ–Ω —Ç–∞–Ω—ã—Å—Ç—ã—Ä. “ö“±—Ä–∞–º—ã, –ø–∞–π–¥–∞—Å—ã, –Ω”ô—Ç–∏–∂–µ—Å—ñ —Ç—É—Ä–∞–ª—ã –∞–π—Ç.",
    "5": "–ë–∞“ì–∞–ª–∞—Ä –º–µ–Ω –µ–º –∫—É—Ä—Å—ã–Ω “±—Å—ã–Ω. 3 –∞–π, 6 –∞–π, 12 –∞–π ‚Äî –Ω–∞“õ—Ç—ã “±—Å—ã–Ω—ã—Å –∂–∞—Å–∞.",
    "6": "–ö“Ø–º”ô–Ω –±–æ–ª—Å–∞ ‚Äî –Ω–∞“õ—Ç—ã –¥”ô–ª–µ–ª–º–µ–Ω —Å–µ–Ω–¥—ñ—Ä. –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –Ω–µ–º–µ—Å–µ –∫–∞—Å–ø–∏–π–º–µ–Ω –¥–æ–∂–∏–º –∂–∞—Å–∞."
}

def split_message(text, max_length=1000):
    parts = []
    while len(text) > max_length:
        split_index = text[:max_length].rfind(". ")
        if split_index == -1:
            split_index = max_length
        parts.append(text[:split_index+1].strip())
        text = text[split_index+1:].strip()
    if text:
        parts.append(text)
    return parts

def send_whatsapp_message(phone, message):
    payload = {
        "messaging_product": "whatsapp",
        "to": phone,
        "type": "text",
        "text": {"body": message}
    }
    response = requests.post(WHATSAPP_API_URL, headers=HEADERS, json=payload)
    print(f"üì§ –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {response.status_code} {response.text}")
    return response

def get_gpt_response(user_msg, user_phone):
    try:
        user_data = USER_STATE.get(user_phone, {})
        history = user_data.get("history", [])
        stage = user_data.get("stage", "0")

        prompt = SALES_SCRIPT_PROMPT + "\n\n" + STAGE_PROMPTS.get(stage, "")

        messages = [{"role": "system", "content": prompt}]
        for item in history:
            messages.append({"role": "user", "content": item["user"]})
            messages.append({"role": "assistant", "content": item["bot"]})
        messages.append({"role": "user", "content": user_msg})

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=messages,
            temperature=0.7
        )
        reply = response.choices[0].message.content.strip()

        next_stage = str(int(stage) + 1) if int(stage) < 6 else "6"

        USER_STATE[user_phone] = {
            "history": history[-5:] + [{"user": user_msg, "bot": reply}],
            "last_message": user_msg,
            "stage": next_stage
        }

        return reply
    except Exception as e:
        print(f"‚ùå GPT “õ–∞—Ç–µ—Å—ñ: {e}")
        return "–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, “õ–∞–∑—ñ—Ä –∂–∞—É–∞–ø –±–µ—Ä–µ –∞–ª–º–∞–π–º—ã–Ω. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ –∫”©—Ä—ñ“£—ñ–∑."

@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.get_json()
    print("üì© –ö–µ–ª–≥–µ–Ω JSON:", data)

    try:
        messages = data["entry"][0]["changes"][0]["value"].get("messages")
        if messages:
            msg = messages[0]
            user_phone = msg["from"]
            user_msg = msg["text"]["body"]

            print(f"üí¨ {user_phone}: {user_msg}")

            if USER_STATE.get(user_phone, {}).get("last_message") == user_msg:
                print("‚ö†Ô∏è “ö–∞–π—Ç–∞–ª–∞—É ‚Äî ”©—Ç–∫—ñ–∑—ñ–ø –∂—ñ–±–µ—Ä–µ–º—ñ–∑")
                return jsonify({"status": "duplicate"}), 200

            reply = get_gpt_response(user_msg, user_phone)
            for part in split_message(reply):
                send_whatsapp_message(user_phone, part)

    except Exception as e:
        print(f"‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ “õ–∞—Ç–µ—Å—ñ: {e}")

    return jsonify({"status": "ok"}), 200

@app.route('/', methods=['GET'])
def home():
    return "Healvix –±–æ—Ç —ñ—Å–∫–µ “õ–æ—Å—ã–ª–¥—ã!", 200

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
