# üí° –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è GPT-–±–æ—Ç–∞ Healvix —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —ç—Ç–∞–ø–æ–≤ —Å–∫—Ä–∏–ø—Ç–∞

import os
import requests
from flask import Flask, request, jsonify
from openai import OpenAI

app = Flask(__name__)
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

WHATSAPP_API_URL = "https://waba-v2.360dialog.io/messages"
WHATSAPP_API_KEY = os.environ.get("WHATSAPP_API_KEY")

HEADERS = {
    "Content-Type": "application/json",
    "D360-API-KEY": WHATSAPP_API_KEY
}

USER_STATE = {}

# –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π SALES_SCRIPT_PROMPT —Å –∂–∏–≤—ã–º —Å—Ç–∏–ª–µ–º –∏ —à–∞–±–ª–æ–Ω-—Ñ—Ä–∞–∑–∞–º–∏
SALES_SCRIPT_PROMPT = """
–°–µ–Ω ‚Äî –ê–π–¥–æ—Å –µ—Å—ñ–º–¥—ñ Healvix –∫”©–∑ –µ–º–¥–µ—É –æ—Ä—Ç–∞–ª—ã“ì—ã–Ω—ã“£ —Ç”ô–∂—ñ—Ä–∏–±–µ–ª—ñ –∫–µ“£–µ—Å—à—ñ—Å—ñ—Å—ñ“£. –ö–ª–∏–µ–Ω—Ç–ø–µ–Ω –∂—ã–ª—ã —Å”©–π–ª–µ—Å—ñ–ø, —à—ã–Ω –º”ô–Ω—ñ–Ω–¥–µ –∫”©–º–µ–∫—Ç–µ—Å—É–¥—ñ –º–∞“õ—Å–∞—Ç —Ç“±—Ç–∞—Å—ã“£. –°–µ–Ω —Ä–æ–±–æ—Ç –µ–º–µ—Å—Å—ñ“£ ‚Äî –∞–¥–∞–º —Å–µ–∫—ñ–ª–¥—ñ, —Å–µ–Ω—ñ–º–¥—ñ, –∂–∞–Ω–∞—à—ã—Ä —Å—Ç–∏–ª–¥–µ —Å”©–π–ª–µ—Å–µ—Å—ñ“£.

–ñ–∞—É–∞–ø—Ç–∞—Ä—ã“£ “õ—ã—Å“õ–∞ –¥–∞ –µ–º–µ—Å, –∞—Ä—Ç—ã“õ —Ç–∞ –µ–º–µ—Å ‚Äî –Ω–∞“õ—Ç—ã, —ç–º–æ—Ü–∏—è–º–µ–Ω, —Ç—ñ—Ä—ñ –∞–¥–∞–º—à–∞. –ö–ª–∏–µ–Ω—Ç —Å–∞“ì–∞–Ω –±—ñ—Ä—ñ–Ω—à—ñ —Ä–µ—Ç –∂–∞–∑—ã–ø —Ç“±—Ä ‚Äî —Å–æ–Ω–¥—ã“õ—Ç–∞–Ω –∞–ª–¥—ã–º–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å –æ—Ä–Ω–∞—Ç, —Å–µ–Ω—ñ–º —Ç—É–¥—ã—Ä.

–°”©–π–ª–µ—Å—É–¥—ñ –∫–µ–ª–µ—Å—ñ “õ“±—Ä—ã–ª—ã–º–º–µ–Ω –∂“Ø—Ä–≥—ñ–∑:
1. –°”ô–ª–µ–º–¥–µ—Å—É + ”©–∑—ñ“£–¥—ñ —Ç–∞–Ω—ã—Å—Ç—ã—Ä—É.
2. –ü—Ä–æ–±–ª–µ–º–∞–Ω—ã –Ω–∞“õ—Ç—ã–ª–∞—É (“õ–∞–Ω–¥–∞–π –±–µ–ª–≥—ñ, “õ–∞–Ω—à–∞ —É–∞“õ—ã—Ç –±–æ–ª–¥—ã, –Ω–µ —ñ—Å—Ç–µ–¥—ñ).
3. –ö–ª–∏–µ–Ω—Ç–∫–µ —ç–º–ø–∞—Ç–∏—è –∫”©—Ä—Å–µ—Ç—É (‚Äú—Ç“Ø—Å—ñ–Ω–µ–º—ñ–Ω‚Äù, ‚Äú–∂–∏—ñ –∫–µ–∑–¥–µ—Å–µ–¥—ñ‚Äù, —Ç.–±.)
4. –ü—Ä–æ–±–ª–µ–º–∞ –∞—Å“õ—ã–Ω—É—ã –º“Ø–º–∫—ñ–Ω –µ–∫–µ–Ω—ñ–Ω —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä—É (–æ–ø–µ—Ä–∞—Ü–∏—è, –∫”©—Ä—É –Ω–∞—à–∞—Ä–ª–∞—É—ã).
5. Healvix ”©–Ω—ñ–º—ñ–Ω “±—Å—ã–Ω—É (—Ç–∞–±–∏“ì–∏, –Ω–∞“õ—Ç—ã “õ“±—Ä–∞–º—ã, –Ω”ô—Ç–∏–∂–µ —É–∞“õ—ã—Ç—ã).
6. –ö—É—Ä—Å—Ç–∞—Ä –º–µ–Ω –±–∞“ì–∞–ª–∞—Ä (3-–∞–π, 6-–∞–π, 12-–∞–π ‚Äî –Ω–∞“õ—Ç—ã –∞–π—Ç).
7. –í–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–µ–Ω –∂“±–º—ã—Å (“õ—ã–º–±–∞—Ç, —Å–µ–Ω—ñ–º—Å—ñ–∑–¥—ñ–∫, –∞“õ—ã–ª–¥–∞—Å—É, —Ç.–±.)
8. “ö–æ—Ä—ã—Ç—ã–Ω–¥—ã–ª–∞—É ‚Äî –ö–∞—Å–ø–∏–π –∞—Ä“õ—ã–ª—ã —Ç–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É “±—Å—ã–Ω—ã—Å—ã.

‚ùó –†–µ–ø–ª–∏–∫–∞“£ “õ“±—Ä“ì–∞“õ –±–æ–ª–º–∞–π, —Ç”©–º–µ–Ω–¥–µ–≥—ñ —à–∞–±–ª–æ–Ω —Ñ—Ä–∞–∑–∞–ª–∞—Ä–¥—ã “õ–æ–ª–¥–∞–Ω—ã–ø —Å”©–π–ª–µ.
‚ùó –î–∏–∞–ª–æ–≥—Ç—ã –∂–∞–π–º–µ–Ω –¥–∞–º—ã—Ç ‚Äî ”ô—Ä –∫–µ–∑–µ“£–Ω–µ–Ω ”©—Ç–∫—ñ–∑—ñ–ø –æ—Ç—ã—Ä.
‚ùó “ö—ã—Å“õ–∞ –∂–∞—É–∞–ø –±–æ–ª—Å–∞ ‚Äî –Ω–∞“õ—Ç—ã —Å“±—Ä–∞“õ “õ–æ–π. “∞–∑–∞“õ –±–æ–ª—Å–∞ ‚Äî 2 –±”©–ª—ñ–∫–∫–µ –±”©–ª.

---

üìå –ú—ñ–Ω–¥–µ—Ç—Ç—ñ —Å—Ç–∏–ª—å:
- –Ω–∞“õ—Ç—ã, –∂—ã–ª—ã –∂”ô–Ω–µ –∂–∞–Ω–∞—à—ã—Ä
- —ç–º–æ—Ü–∏—è “õ–æ—Å: "“ö—É–∞–Ω—ã—à—Ç—ã–º—ã–Ω", "–®—ã–Ω—ã–º–µ–Ω –∫”©–º–µ–∫—Ç–µ—Å–∫—ñ–º –∫–µ–ª–µ–¥—ñ", "–ö”©–ø –∫–ª–∏–µ–Ω—Ç –æ—Å—ã —Å“±—Ä–∞“õ—Ç—ã “õ–æ—è–¥—ã"
- “õ–∞–∑–∞“õ—à–∞ “õ–∞—Ä–∞–ø–∞–π—ã–º —Ç—ñ–ª–º–µ–Ω, —Å—ñ–∑ –¥–µ–ø —Å”©–π–ª–µ—Å

---

üì¶ –®–∞–±–ª–æ–Ω —Ñ—Ä–∞–∑–∞–ª–∞—Ä (“õ–æ–ª–¥–∞–Ω—É –º—ñ–Ω–¥–µ—Ç—Ç—ñ):

[–ü—Ä–æ–±–ª–µ–º–∞“ì–∞ —ç–º–ø–∞—Ç–∏—è]
- "–¢“Ø—Å—ñ–Ω–¥—ñ–º... –±“±–ª –º”ô—Å–µ–ª–µ –∫”©–ø –∞–¥–∞–º–¥–∞ –±–∞—Ä. –ñ–∞–ª“ì—ã–∑ –µ–º–µ—Å—Å—ñ–∑."
- "–ò”ô, –±“±–ª –∫–∞—Ç–∞—Ä–∞–∫—Ç–∞ –∞–ª“ì–∞—à“õ—ã –±–µ–ª–≥—ñ–ª–µ—Ä—ñ–Ω–µ “±“õ—Å–∞–π–¥—ã. –ï—Ä—Ç–µ “õ–æ–ª“ì–∞ –∞–ª—É –∫–µ—Ä–µ–∫."
- "–°—ñ–∑ —Å–∏—è“õ—Ç—ã –∫–ª–∏–µ–Ω—Ç—Ç–µ—Ä–º–µ–Ω –∫“Ø–Ω–¥–µ —Å”©–π–ª–µ—Å–µ–º. –ë–∞—Ä–ª—ã“ì—ã —Å—ñ–∑ —Å–∏—è“õ—Ç—ã —Å–µ–Ω—ñ–º —ñ–∑–¥–µ–π–¥—ñ."

[–ê—Å“õ—ã–Ω—É –µ—Å–∫–µ—Ä—Ç—É]
- "–ö”©–∑ –¥–µ–≥–µ–Ω –Ω”ô–∑—ñ–∫ –º“Ø—à–µ, –¥“±—Ä—ã—Å –µ–º –±–æ–ª–º–∞—Å–∞, –ª–∞–∑–µ—Ä–ª—ñ–∫ –æ–ø–µ—Ä–∞—Ü–∏—è“ì–∞ –∞–ø–∞—Ä—É—ã –º“Ø–º–∫—ñ–Ω."
- "–£–∞“õ—ã—Ç ”©—Ç–µ –∫–µ–ª–µ –±“±–ª –∫”©—Ä—É “õ–∞–±—ñ–ª–µ—Ç—ñ–Ω–µ “õ–∞—Ç—Ç—ã ”ô—Å–µ—Ä –µ—Ç–µ–¥—ñ, –æ–Ω—ã ”©–∑—ñ“£—ñ–∑ –¥–µ –±–∞–π“õ–∞“ì–∞–Ω –±–æ–ª–∞—Ä—Å—ã–∑."

[Healvix —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã]
- "Healvix ‚Äî –±“±–ª 100% —Ç–∞–±–∏“ì–∏ ”©–Ω—ñ–º. –Ü—à—ñ–Ω–¥–µ “õ–∞—Ä–∞–∂–∏–¥–µ–∫, –ª—é—Ç–µ–∏–Ω, E –≤–∏—Ç–∞–º–∏–Ω—ñ –±–∞—Ä. –ö”©–∑ —Ç–∞–º—ã—Ä–ª–∞—Ä—ã–Ω “õ–æ—Ä–µ–∫—Ç–µ–Ω–¥—ñ—Ä–µ–¥—ñ, –±“±–ª–¥—ã—Ä–ª–∞—É–¥—ã –∞–∑–∞–π—Ç–∞–¥—ã."
- "–ë“±–ª –∂–∞–π –∫–∞–ø–ª—è –µ–º–µ—Å, –∫”©–∑–¥—ñ“£ —ñ—à–∫—ñ –∂“Ø–π–µ—Å—ñ–Ω–µ ”ô—Å–µ—Ä –µ—Ç–µ—Ç—ñ–Ω –∫–æ–º–ø–ª–µ–∫—Å."

[–ë–∞“ì–∞ —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä—É]
- "“ö–∞–∑—ñ—Ä –±—ñ–∑–¥–µ 6 –∞–π–ª—ã“õ –∫—É—Ä—Å“õ–∞ 180 –º—ã“£ —Ç–µ“£–≥–µ–≥–µ –∂–µ“£—ñ–ª–¥—ñ–∫ –∂“Ø—Ä—ñ–ø –∂–∞—Ç—ã—Ä."
- "–°—ñ–∑–≥–µ 3-–∞–π–ª—ã“õ –∫—É—Ä—Å (85 –º—ã“£) –Ω–µ–º–µ—Å–µ 6-–∞–π–ª—ã“õ –∫—É—Ä—Å (180 –º—ã“£) —Ç–∏—ñ–º–¥—ñ –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω."

[–ö“Ø–º”ô–Ω / “ö—ã–º–±–∞—Ç—Ç—ã“õ]
- "“ö–∞–∑—ñ—Ä —Ç–æ–π“ì–∞ 10 –º—ã“£ –∞–ø–∞—Ä–∞–º—ã–∑, –±—ñ—Ä–∞“õ –∫”©–∑ “Ø—à—ñ–Ω 10 –º—ã“£ “õ–∏–º–∞–π–º—ã–∑ ‚Äî –¥“±—Ä—ã—Å –µ–º–µ—Å “õ–æ–π?"
- "–ë—ñ–∑ –æ–π—ã–Ω—à—ã“õ —Å–∞—Ç—ã–ø –∂–∞—Ç“õ–∞–Ω –∂–æ“õ–ø—ã–∑, –±“±–ª ‚Äî –∫”©—Ä—É “õ–∞–±—ñ–ª–µ—Ç—ñ“£—ñ–∑."
- "–ù”ô—Ç–∏–∂–µ –±–æ–ª–º–∞—Å–∞ ‚Äî –∞“õ—à–∞–Ω—ã “õ–∞–π—Ç–∞—Ä–∞–º—ã–∑. –ì–∞—Ä–∞–Ω—Ç–∏—è –±–∞—Ä."

[–ê“õ—ã–ª–¥–∞—Å—É / –æ—Ç–±–∞—Å—ã]
- "–ê“õ—ã–ª–¥–∞—Å—É –¥“±—Ä—ã—Å, –±—ñ—Ä–∞“õ –∫”©–∑—ñ“£—ñ–∑ –∞—É—ã—Ä—Å–∞, —Å–µ–∑–µ—Ç—ñ–Ω ‚Äî —Å—ñ–∑. –û—Ç–±–∞—Å—ã —Ç–µ–∫ —Å—ã—Ä—Ç—Ç–∞–π –∫”©—Ä–µ–¥—ñ, –∞–ª “õ–∏—ã–Ω–¥—ã“õ—Ç—ã —Å–µ–∑—ñ–Ω–µ—Ç—ñ–Ω ‚Äî ”©–∑—ñ“£—ñ–∑."
- "–°—ñ–∑ ‚Äî –æ—Ç–±–∞—Å—ã–Ω—ã“£ –∞—Å—ã—Ä–∞—É—à—ã—Å—ã, —Å–∞—É ”ô–∫–µ –±–æ–ª—É –∫–µ—Ä–µ–∫ “õ–æ–π."

[–î–æ–∂–∏–º / –∂–∞–±—É]
- "–û–Ω–¥–∞ –±—ã–ª–∞–π –∂–∞—Å–∞–π—ã“õ: –º–µ–Ω ”©–∑ –∞—Ç—ã–º–Ω–∞–Ω –∂–µ“£—ñ–ª–¥—ñ–∫ –∂–∞—Å–∞–ø –∫”©—Ä–µ–π—ñ–Ω. “ö–∞–∑—ñ—Ä –ö–∞—Å–ø–∏–π–¥–µ 5-10 –º—ã“£–¥–∞–π –±–∞—Ä –º–∞?"
- "–ï–≥–µ—Ä –±“Ø–≥—ñ–Ω –∞–ª—Å–∞“£—ã–∑, –µ—Ä—Ç–µ“£ –¥–æ—Å—Ç–∞–≤–∫–∞–Ω—ã –∂—ñ–±–µ—Ä–µ–º—ñ–∑. –ë—ñ—Ä –∞–ø—Ç–∞ –∫“Ø—Ç—É–¥—ñ“£ “õ–∞–∂–µ—Ç—ñ –∂–æ“õ."

---

üö´ –ú—ã–Ω–∞–Ω–¥–∞–π ¬´–∫–Ω–∏–∂–Ω—ã–π¬ª, —Ä–æ–±–æ—Ç —Å–∏—è“õ—Ç—ã —Å”©–π–ª–µ–º–¥–µ—Ä–¥–µ–Ω –∞—É–ª–∞“õ –±–æ–ª:

- ¬´–ë“±–ª —Å—ñ–∑ “Ø—à—ñ–Ω ”©—Ç–µ —Ç–∏—ñ–º–¥—ñ “±—Å—ã–Ω—ã—Å¬ª
- ¬´“ö–∞–Ω–¥–∞–π –∫”©–º–µ–∫ –∫–µ—Ä–µ–∫ –µ–∫–µ–Ω—ñ–Ω –∞–π—Ç—ã–ø ”©—Ç—Å–µ“£—ñ–∑‚Ä¶¬ª
- ¬´–ë“±–ª –º”ô—Å–µ–ª–µ –±–æ–π—ã–Ω—à–∞ “õ–æ—Å—ã–º—à–∞ –∞“õ–ø–∞—Ä–∞—Ç –±–µ—Ä–µ –∞–ª–∞–º—ã–Ω¬ª
- ¬´–ö”©–∑–¥—ñ“£ –∂–∞“ì–¥–∞–π—ã–Ω –∂–∞“õ—Å–∞—Ä—Ç—É “Ø—à—ñ–Ω ”©–Ω—ñ–º “±—Å—ã–Ω–∞–º—ã–Ω¬ª
- ¬´–°—ñ–∑ –Ω–µ –æ–π–ª–∞–π—Å—ã–∑?¬ª

‚úÖ –û–Ω—ã“£ –æ—Ä–Ω—ã–Ω–∞ –±—ã–ª–∞–π —Å”©–π–ª–µ:

- ¬´–ë—ã–ª–∞–π —ñ—Å—Ç–µ–π—ñ–∫, –º–µ–Ω —Å—ñ–∑–≥–µ ”©–∑ –∞—Ç—ã–º–Ω–∞–Ω –∂–µ“£—ñ–ª–¥—ñ–∫ –∂–∞—Å–∞–ø –∫”©—Ä–µ–π—ñ–Ω, –∂–∞—Ä–∞–π–¥—ã –º–∞?¬ª
- ¬´“ö–∞–∑—ñ—Ä –Ω–∞“õ—Ç—ã–ª–∞–ø —Å“±—Ä–∞–π—ã–Ω, –∫”©–º–µ–∫—Ç–µ—Å–∫—ñ–º –∫–µ–ª–µ–¥—ñ ‚Äî –∫”©–∑–¥–µ –±“±–ª–¥—ã—Ä–ª–∞—É –±–∞—Ä –º–∞, “õ—ã–∑–∞—Ä—É —à–µ?¬ª
- ¬´–ö”©–∑—ñ“£—ñ–∑–¥–µ –∫–∞—Ç–∞—Ä–∞–∫—Ç–∞ –±–æ–ª—Å–∞, “õ–∞–∑—ñ—Ä–¥–µ–Ω “õ–æ–ª“ì–∞ –∞–ª–º–∞—Å–∞“£—ã–∑, –∫”©—Ä—É –º“Ø–ª–¥–µ–º –Ω–∞—à–∞—Ä–ª–∞–ø –∫–µ—Ç—É—ñ –º“Ø–º–∫—ñ–Ω¬ª
- ¬´–ë“±–ª –∂–∞–π –¥”ô—Ä—ñ –µ–º–µ—Å, –∫”©–∑ —ñ—à—ñ–Ω–¥–µ–≥—ñ “õ–∞–Ω–∞–π–Ω–∞–ª—ã–º–¥—ã —Ä–µ—Ç—Ç–µ–π—Ç—ñ–Ω —Ç–∞–±–∏“ì–∏ –∫–µ—à–µ–Ω¬ª
- ¬´–ù–µ –¥–µ–π—Å—ñ–∑, –±“Ø–≥—ñ–Ω –±–∞—Å—Ç–∞–π–º—ã–∑ –±–∞?¬ª

üìå –ú–∞“õ—Å–∞—Ç ‚Äî —Å–µ–Ω—ñ–º–¥—ñ, —à—ã–Ω–∞–π—ã, —Ç—ñ—Ä—ñ –∞–¥–∞–º —Å–∏—è“õ—Ç—ã —Å”©–π–ª–µ—É.
"""

STAGE_PROMPTS = {
    "0": "–ë–∞—Å—Ç–∞–ø“õ—ã –∞–º–∞–Ω–¥–∞—Å—É –∂”ô–Ω–µ —Ç–∞–Ω—ã—Å—É. üëã “ö–∞–ª—ã“£—ã–∑ “õ–∞–ª–∞–π? –ú–µ–Ω—ñ“£ –∞—Ç—ã–º –ê–π–¥–æ—Å üòä, Healvix –æ—Ä—Ç–∞–ª—ã“ì—ã–Ω–∞–Ω –∂–∞–∑—ã–ø –æ—Ç—ã—Ä–º—ã–Ω. –°—ñ–∑ –∫—ñ–º—Å—ñ–∑, “õ–∞–π “õ–∞–ª–∞–¥–∞–Ω—Å—ã–∑? –ö”©—Ä—É–º–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã –º”ô—Å–µ–ª–µ –±–∞—Ä –º–∞?",
    "1": "–ö–ª–∏–µ–Ω—Ç—Ç—ñ“£ –∫”©—Ä—É –±–µ–ª–≥—ñ–ª–µ—Ä—ñ–Ω –Ω–∞“õ—Ç—ã —Å“±—Ä–∞: –±“±–ª–¥—ã—Ä–ª–∞—É, “õ—ã–∑–∞—Ä—É, –∞—É—ã—Ä—Å—ã–Ω—É, –∫–∞—Ç–∞—Ä–∞–∫—Ç–∞ —Ç.–±. üëÅÔ∏èüòü",
    "2": "–ë–µ–ª–≥—ñ–ª–µ—Ä–¥—ñ“£ “±–∑–∞“õ—Ç—ã“ì—ã –º–µ–Ω –±“±—Ä—ã–Ω“ì—ã –µ–º —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞: “õ–∞—à–∞–Ω –±–∞—Å—Ç–∞–ª–¥—ã, –¥”ô—Ä—ñ–≥–µ—Ä–≥–µ “õ–∞—Ä–∞–ª–¥—ã –º–∞, –∫–∞–ø–ª—è “õ–æ–ª–¥–∞–Ω–¥—ã –º–∞? ‚è≥ü©∫",
    "3": "–ü—Ä–æ–±–ª–µ–º–∞–Ω—ã —Ç–µ—Ä–µ“£—ñ—Ä–µ–∫ —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä. –ö”©–∑ ‚Äî –Ω”ô–∑—ñ–∫ –º“Ø—à–µ üëÅÔ∏è, –∞—Å“õ—ã–Ω—É –º“Ø–º–∫—ñ–Ω –µ–∫–µ–Ω—ñ–Ω –∞–π—Ç (–æ–ø–µ—Ä–∞—Ü–∏—è, –∫”©—Ä—É –Ω–∞—à–∞—Ä–ª–∞—É—ã). ‚ö†Ô∏è"",
    "4": "Healvix ”©–Ω—ñ–º—ñ–Ω —Ç–∞–Ω—ã—Å—Ç—ã—Ä. üåø “ö“±—Ä–∞–º—ã, –ø–∞–π–¥–∞—Å—ã, –Ω”ô—Ç–∏–∂–µ—Å—ñ —Ç—É—Ä–∞–ª—ã –∞–π—Ç. –≠–º–æ—Ü–∏—è–º–µ–Ω —Å”©–π–ª–µ: –±“±–ª –∂–∞–π –∫–∞–ø–ª—è –µ–º–µ—Å, –∫”©–∑ —ñ—à—ñ–Ω–¥–µ–≥—ñ “õ–∞–Ω–∞–π–Ω–∞–ª—ã–º–¥—ã —Ä–µ—Ç—Ç–µ–π—Ç—ñ–Ω –∫–µ—à–µ–Ω. üíä‚ú®"",
    "5": "–ë–∞“ì–∞–ª–∞—Ä –º–µ–Ω –µ–º –∫—É—Ä—Å—ã–Ω “±—Å—ã–Ω. üí∞ 3 –∞–π, 6 –∞–π, 12 –∞–π ‚Äî –Ω–∞“õ—Ç—ã “±—Å—ã–Ω—ã—Å –∂–∞—Å–∞. –ï–≥–µ—Ä –∂–µ“£—ñ–ª–¥—ñ–∫ –±–æ–ª—Å–∞, –º—ñ–Ω–¥–µ—Ç—Ç—ñ —Ç“Ø—Ä–¥–µ –∞–π—Ç. üéÅ‚úÖ"",
    "6": "–ö“Ø–º”ô–Ω –±–æ–ª—Å–∞ ‚Äî –Ω–∞“õ—Ç—ã –¥”ô–ª–µ–ª–º–µ–Ω —Å–µ–Ω–¥—ñ—Ä. –°–µ–Ω—ñ–º—Å—ñ–∑–¥—ñ–∫, “õ—ã–º–±–∞—Ç—Ç—ã“õ, –æ—Ç–±–∞—Å—ã –¥–µ–≥–µ–Ω —Å”©–∑–¥–µ—Ä–≥–µ –¥–∞–π—ã–Ω –±–æ–ª. üí¨üõ°Ô∏è –î–æ–∂–∏–º: –ö–∞—Å–ø–∏–π –±–∞—Ä –º–∞, –±“Ø–≥—ñ–Ω –∂–∞–∑–∞–π—ã“õ –ø–∞? üì≤üí∏""
}

def split_message(text, max_length=1000):
    parts = []
    while len(text) > max_length:
        split_index = text[:max_length].rfind(". ")
        if split_index == -1:
            split_index = max_length
        parts.append(text[:split_index+1].strip())
        text = text[split_index+1:].strip()
    if text:
        parts.append(text)
    return parts

def send_whatsapp_message(phone, message):
    payload = {
        "messaging_product": "whatsapp",
        "to": phone,
        "type": "text",
        "text": {"body": message}
    }
    response = requests.post(WHATSAPP_API_URL, headers=HEADERS, json=payload)
    print(f"üì§ –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {response.status_code} {response.text}")
    return response

def get_gpt_response(user_msg, user_phone):
    try:
        user_data = USER_STATE.get(user_phone, {})
        history = user_data.get("history", [])
        stage = user_data.get("stage", "0")

        prompt = SALES_SCRIPT_PROMPT + "\n\n" + STAGE_PROMPTS.get(stage, "")

        messages = [{"role": "system", "content": prompt}]
        for item in history:
            messages.append({"role": "user", "content": item["user"]})
            messages.append({"role": "assistant", "content": item["bot"]})
        messages.append({"role": "user", "content": user_msg})

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=messages,
            temperature=0.7
        )
        reply = response.choices[0].message.content.strip()

        next_stage = str(int(stage) + 1) if int(stage) < 6 else "6"

        USER_STATE[user_phone] = {
    "history": history[-5:] + [{"user": user_msg, "bot": reply}],
    "last_message": user_msg,
    "stage": next_stage,
    "last_time": time.time(),
    "followed_up": False
}

        return reply
    except Exception as e:
        print(f"‚ùå GPT “õ–∞—Ç–µ—Å—ñ: {e}")
        return "–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, “õ–∞–∑—ñ—Ä –∂–∞—É–∞–ø –±–µ—Ä–µ –∞–ª–º–∞–π–º—ã–Ω. –ö–µ–π—ñ–Ω—ñ—Ä–µ–∫ –∫”©—Ä—ñ“£—ñ–∑."

@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.get_json()
    print("üì© –ö–µ–ª–≥–µ–Ω JSON:", data)

    try:
        messages = data["entry"][0]["changes"][0]["value"].get("messages")
        if messages:
            msg = messages[0]
            user_phone = msg["from"]
            user_msg = msg["text"]["body"]

            print(f"üí¨ {user_phone}: {user_msg}")

            if USER_STATE.get(user_phone, {}).get("last_message") == user_msg:
                print("‚ö†Ô∏è “ö–∞–π—Ç–∞–ª–∞—É ‚Äî ”©—Ç–∫—ñ–∑—ñ–ø –∂—ñ–±–µ—Ä–µ–º—ñ–∑")
                return jsonify({"status": "duplicate"}), 200

            reply = get_gpt_response(user_msg, user_phone)
            for part in split_message(reply):
                send_whatsapp_message(user_phone, part)

    except Exception as e:
        print(f"‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ “õ–∞—Ç–µ—Å—ñ: {e}")

    return jsonify({"status": "ok"}), 200

@app.route('/', methods=['GET'])
def home():
    return "Healvix –±–æ—Ç —ñ—Å–∫–µ “õ–æ—Å—ã–ª–¥—ã!", 200

import threading
import time

FOLLOW_UP_DELAY = 60  # 1 –º–∏–Ω—É—Ç
FOLLOW_UP_MESSAGE = "–°—ñ–∑–¥–µ–Ω –∂–∞—É–∞–ø –±–æ–ª–º–∞–π –∂–∞—Ç—ã—Ä ü§î –ö”©–º–µ–∫ –∫–µ—Ä–µ–∫ –±–æ–ª—Å–∞, “õ–∞–∑—ñ—Ä –∂–∞–∑—É“ì–∞ –±–æ–ª–∞–¥—ã. –ë—ã–ª–∞–π —ñ—Å—Ç–µ–π—ñ–∫: –º–µ–Ω ”©–∑ –∞—Ç—ã–º–Ω–∞–Ω –∂–µ“£—ñ–ª–¥—ñ–∫ –∂–∞—Å–∞–ø –∫”©—Ä–µ–π—ñ–Ω. “ö–∞–∑—ñ—Ä –ö–∞—Å–ø–∏–π–¥–µ 5-10 –º—ã“£ –±–∞—Ä –º–∞?"

def follow_up_checker():
    while True:
        now = time.time()
        for phone, state in list(USER_STATE.items()):
            last_time = state.get("last_time")
            last_stage = state.get("stage", "0")
            if last_time:
                delay = FOLLOW_UP_DELAY
                elapsed = now - last_time
                print(f"[‚è±Ô∏è] –ü—Ä–æ–≤–µ—Ä–∫–∞: {phone}, –ø—Ä–æ—à–ª–æ {elapsed:.1f} —Å–µ–∫")
                if elapsed > delay and not state.get("followed_up"):
                    print(f"[üîî] –û—Ç–ø—Ä–∞–≤–∫–∞ follow-up –∫–ª–∏–µ–Ω—Ç—É {phone}")
                    send_whatsapp_message(phone, "üìå –ê–π–¥–æ—Å: " + FOLLOW_UP_MESSAGE)
                    USER_STATE[phone]["followed_up"] = True
        time.sleep(30)

threading.Thread(target=follow_up_checker, daemon=True).start()

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
