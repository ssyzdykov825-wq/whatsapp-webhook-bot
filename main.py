import os
import time
import threading
import requests
import json
import re
from flask import Flask, request, jsonify
from openai import OpenAI
from datetime import datetime, timedelta

AUTO_REPLY_ENABLED = False

# Import the new state management functions
from state_manager import (
    init_db, load_cache_from_db,
    get_client_state, save_client_state, client_in_db_or_cache,
    follow_up_checker, cleanup_old_clients,
    MAX_HISTORY_FOR_GPT
)

# âœ¨ Ğ˜ĞœĞŸĞĞ Ğ¢Ğ˜Ğ Ğ£Ğ•Ğœ Ğ’ĞĞ¨Ğ˜ Ğ Ğ•ĞĞ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ SALESRENDER API - ĞŸĞ Ğ•Ğ”ĞŸĞĞ›ĞĞ“ĞĞ•Ğ¢Ğ¡Ğ¯, Ğ§Ğ¢Ğ ĞĞĞ˜ Ğ ĞĞ‘ĞĞ¢ĞĞ®Ğ¢ ĞšĞĞ Ğ Ğ•ĞšĞ¢ĞĞ âœ¨
from salesrender_api import create_order, client_exists 


# ==============================
# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
# ==============================
app = Flask(__name__)
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

WHATSAPP_API_URL = "https://waba-v2.360dialog.io/messages"
WHATSAPP_API_KEY = os.environ.get("WHATSAPP_API_KEY") # Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ ĞºĞ°Ğº Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

HEADERS = {
    "Content-Type": "application/json",
    "D360-API-KEY": WHATSAPP_API_KEY
}

# ĞšÑÑˆ Ğ² Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ´ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ ID ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)
PROCESSED_MESSAGES = set()

# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ SalesRender CRM (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¸ Ğ² salesrender_api.py, Ğ½Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ·Ğ´ĞµÑÑŒ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ‚Ñ‹, ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ² Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¼ĞµÑÑ‚Ğ°Ñ…)
# Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ²Ğ°Ñˆ salesrender_api.py Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑÑ‚Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ ÑĞ²Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸.
SALESRENDER_URL = os.environ.get("SALESRENDER_URL", "https://de.backend.salesrender.com/companies/1123/CRM")
SALESRENDER_TOKEN = os.environ.get("SALESRENDER_TOKEN", "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwczovL2RlLmJhY2tlbmQuc2FsZXNyZW5kZXIuY29tLyIsImF1ZCI6IkNSTSIsImp0aSI6ImI4MjZmYjExM2Q4YjZiMzM3MWZmMTU3MTMwMzI1MTkzIiwiaWF0IjoxNzU0NzM1MDE3LCJ0eXBlIjoiYXBpIiwiY2lkIjoiMTEyMyIsInJlZiI6eyJhbGlhcyI6IkFQSSIsImlkIjoiMiJ9fQ.z6NiuV4g7bbdi_1BaRfEqDj-oZKjjniRJoQYKgWsHcc")

# ==============================
# ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
# ==============================
def normalize_phone_number(phone_raw):
    """
    ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğº Ğ¼ĞµĞ¶Ğ´ÑƒĞ½Ğ°Ñ€Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñƒ Ñ '+'.
    ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: '77071234567' -> '+77071234567'
            '87071234567' -> '+77071234567'
            '+77071234567' -> '+77071234567'
    """
    if not phone_raw:
        return ""
    
    # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²ÑĞµ Ğ½ĞµÑ†Ğ¸Ñ„Ñ€Ğ¾Ğ²Ñ‹Ğµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹
    phone_digits = re.sub(r'\D', '', phone_raw)

    if not phone_digits:
        return ""

    # Ğ•ÑĞ»Ğ¸ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ 8, Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ½Ğ° 7
    if phone_digits.startswith('8'):
        phone_digits = '7' + phone_digits[1:]
    
    # Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ 7, Ğ¸ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ´Ğ»Ğ¸Ğ½Ñƒ, Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰ÑƒÑ Ğ´Ğ»Ñ ĞšĞ°Ğ·Ğ°Ñ…ÑÑ‚Ğ°Ğ½Ğ° (Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµĞ¼ 10 Ñ†Ğ¸Ñ„Ñ€ Ğ¿Ğ¾ÑĞ»Ğµ '7')
    if not phone_digits.startswith('7') and len(phone_digits) == 10: 
        phone_digits = '7' + phone_digits
    
    # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ '+' Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾, ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
    if not phone_digits.startswith('+'):
        return '+' + phone_digits
    
    return phone_digits

# ==============================
# Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ SalesRender
# ==============================
# ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ: create_order Ğ¸ client_exists Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ¸Ğ· salesrender_api.py
# Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ²Ğ°Ñˆ salesrender_api.py ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ fetch_order_from_crm, ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾.

import requests

# Ğ—Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ¸ Ğ´Ğ»Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ñ‹ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ
def client_in_db_or_cache(phone):
    return False

def save_client_state(phone, name, in_crm):
    pass

def normalize_phone_number(phone):
    return phone

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ client_exists Ğ¸ create_order
from salesrender_api import client_exists, create_order, SALESRENDER_TOKEN, SALESRENDER_URL

def fetch_order_from_crm(order_id):
Â  Â  """Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ¸Ğ· SalesRender CRM Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ GraphQL."""
Â  Â  headers = {
Â  Â  Â  Â  "Content-Type": "application/json",
Â  Â  Â  Â  "Authorization": SALESRENDER_TOKEN
Â  Â  }
Â  Â  query = {
Â  Â  Â  Â  "query": f"""
Â  Â  Â  Â  query {{
Â  Â  Â  Â  Â  Â  ordersFetcher(filters: {{ include: {{ ids: ["{order_id}"] }} }}) {{
Â  Â  Â  Â  Â  Â  Â  Â  orders {{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data {{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  humanNameFields {{ value {{ firstName lastName }} }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  phoneFields {{ value {{ international raw national }} }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  Â  Â  }}
Â  Â  Â  Â  }}
Â  Â  Â  Â  """
Â  Â  }
Â  Â  try:
Â  Â  Â  Â  response = requests.post(SALESRENDER_URL, headers=headers, json=query, timeout=10)
Â  Â  Â  Â  response.raise_for_status()
Â  Â  Â  Â  data = response.json().get("data", {}).get("ordersFetcher", {}).get("orders", [])
Â  Â  Â  Â  return data[0] if data else None
Â  Â  except Exception as e:
Â  Â  Â  Â  print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· CRM: {e}")
Â  Â  Â  Â  return None

def process_new_lead(name, phone, project_id): # <-- Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾
Â  Â  """
Â  Â  Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¸Ğ´Ğ° Ğ²Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ¹ Ğ‘Ğ” Ğ±Ğ¾Ñ‚Ğ° Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ·Ğ°ĞºĞ°Ğ· Ğ² CRM, ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾.
Â  Â  """
Â  Â  if client_in_db_or_cache(phone):
Â  Â  Â  Â  print(f"âš ï¸ ĞšĞ»Ğ¸ĞµĞ½Ñ‚ {phone} ÑƒĞ¶Ğµ Ğ² Ğ±Ğ°Ğ·Ğµ/ĞºÑÑˆĞµ (Ğ² process_new_lead), Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ.")
Â  Â  Â  Â  return NoneÂ 

Â  Â  crm_exists_status = client_exists(phone)

Â  Â  if crm_exists_status:
Â  Â  Â  Â  print(f"DEBUG: ĞšĞ»Ğ¸ĞµĞ½Ñ‚ {phone} Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² CRM, Ğ½Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ´Ğ»Ñ Ğ‘Ğ” Ğ±Ğ¾Ñ‚Ğ°. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ‘Ğ” Ğ±Ğ¾Ñ‚Ğ° Ñ in_crm=True.")
Â  Â  Â  Â  save_client_state(phone, name=name, in_crm=True)
Â  Â  Â  Â  return None
Â  Â  else:
Â  Â  Â  Â  print(f"DEBUG: ĞšĞ»Ğ¸ĞµĞ½Ñ‚ {phone} ĞĞ• Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² CRM. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ· Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ğ‘Ğ” Ğ±Ğ¾Ñ‚Ğ°.")
Â  Â  Â  Â  order_id = create_order(name, phone, project_id) # <-- Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾

Â  Â  Â  Â  if order_id:
Â  Â  Â  Â  Â  Â  print(f"âœ… Ğ—Ğ°ĞºĞ°Ğ· {order_id} ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ´Ğ»Ñ {name}, {phone}. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ² Ğ±Ğ¾Ñ‚Ğµ.")
Â  Â  Â  Â  Â  Â  save_client_state(phone, name=name, in_crm=True)
Â  Â  Â  Â  Â  Â  return order_id
Â  Â  Â else:
Â  Â  Â  Â  Â  Â  print(f"âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ· Ğ´Ğ»Ñ {name}, {phone}. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ±ĞµĞ· CRM ÑĞ²ÑĞ·Ğ¸ Ğ² Ğ±Ğ¾Ñ‚Ğµ.")
Â  Â  Â  Â  Â  Â  save_client_state(phone, name=name, in_crm=False)
Â  Â  Â  Â  Â  Â  return None

def process_salesrender_order(order):
Â  Â  """
Â  Â  ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ²ĞµĞ±Ñ…ÑƒĞº Ğ·Ğ°ĞºĞ°Ğ·Ğ° SalesRender. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñƒ.
Â  Â  """
Â  Â  try:
Â  Â  Â  Â  if not order.get("customer") and "id" in order:
Â  Â  Â  Â  Â  Â  print(f"âš  customer Ğ¿ÑƒÑÑ‚, Ğ¿Ğ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ñ Ğ¸Ğ· CRM Ğ¿Ğ¾ ID {order['id']}")
Â  Â  Â  Â  Â  Â  full_order = fetch_order_from_crm(order["id"])
Â  Â  Â  Â  Â  Â  if full_order:
Â  Â  Â  Â  Â  Â  Â  Â  order = full_order
Â  Â  Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  Â  Â  print("âŒ CRM Ğ½Ğµ Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞº")
Â  Â  Â  Â  Â  Â  Â  Â  return

Â  Â  Â  Â  first_name, last_name, phone = "", "", ""
Â  Â  Â  Â  if "customer" in order:
Â  Â  Â  Â  Â  Â  first_name = order.get("customer", {}).get("name", {}).get("firstName", "").strip()
Â  Â  Â  Â  Â  Â  last_name = order.get("customer", {}).get("name", {}).get("lastName", "").strip()
Â  Â  Â  Â  Â  Â  phone = normalize_phone_number(order.get("customer", {}).get("phone", {}).get("raw", "").strip())
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  human_fields = order.get("data", {}).get("humanNameFields", [])
Â  Â  Â  Â  Â  Â  phone_fields = order.get("data", {}).get("phoneFields", [])
Â  Â  Â  Â  Â  Â  if human_fields:
Â  Â  Â  Â  Â  Â  Â  Â  first_name = human_fields[0].get("value", {}).get("firstName", "").strip()
Â  Â  Â  Â  Â  Â  Â  Â  last_name = human_fields[0].get("value", {}).get("lastName", "").strip()
Â  Â  Â  Â  Â  Â  if phone_fields:
Â  Â  Â  Â  Â  Â  Â  Â  phone = normalize_phone_number(phone_fields[0].get("value", {}).get("international", "").strip())

Â  Â  Â  Â  name = f"{first_name} {last_name}".strip() or "ĞšĞ»Ğ¸ĞµĞ½Ñ‚"

Â  Â  Â  Â  if not phone:
Â  Â  Â  Â  Â  Â  print("âŒ Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞº")
Â  Â  Â  Â  Â  Â  return
        
        # --- (ĞšĞ¾Ğ½ĞµÑ† ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ´Ğ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ°) ---

        # âœ¨ Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ Ğ—Ğ”Ğ•Ğ¡Ğ¬ âœ¨
        # Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ²Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ¹ Ğ‘Ğ” Ğ±Ğ¾Ñ‚Ğ°, Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ Ğ¾Ñ‚ Ñ‚Ğ¾Ğ³Ğ¾, Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ½ Ğ¸Ğ»Ğ¸ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹.
        # Ğ­Ñ‚Ğ¾ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚, Ñ‡Ñ‚Ğ¾ Ğ‘Ğ” Ğ±Ğ¾Ñ‚Ğ° Ğ²ÑĞµĞ³Ğ´Ğ° Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ° ÑĞ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ¼ CRM.
        # Ğ­Ñ‚Ğ¾ Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº `if client_in_db_or_cache(phone): ... return`.
        if not client_in_db_or_cache(phone):
            # ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ´Ğ»Ñ Ğ‘Ğ” Ğ±Ğ¾Ñ‚Ğ° (Ğ¿Ñ€Ğ¸ÑˆĞµĞ» Ğ¸Ğ· Ğ²ĞµĞ±Ñ…ÑƒĞºĞ° SalesRender).
            # ĞœÑ‹ Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ ĞµÑĞ»Ğ¸ SalesRender Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ²ĞµĞ±Ñ…ÑƒĞº, ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ½ĞµÑĞ²Ğ½Ğ¾ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ² CRM.
            print(f"â„¹ï¸ ĞšĞ»Ğ¸ĞµĞ½Ñ‚ {phone} Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ´Ğ»Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ±Ğ¾Ñ‚Ğ° (Ğ¸Ğ· Ğ²ĞµĞ±Ñ…ÑƒĞºĞ° SalesRender), Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼.")
            save_client_state(phone, name=name, in_crm=True)
        else:
            # ĞšĞ»Ğ¸ĞµĞ½Ñ‚ ÑƒĞ¶Ğµ Ğ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½ Ğ‘Ğ” Ğ±Ğ¾Ñ‚Ğ°. ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ ÑƒĞ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ ĞµĞ³Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑ CRM Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ (Ğ¾Ğ½ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ true Ğ¸Ğ· Ñ…ÑƒĞºĞ° CRM).
            print(f"â„¹ï¸ ĞšĞ»Ğ¸ĞµĞ½Ñ‚ {phone} ÑƒĞ¶Ğµ Ğ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½ Ğ±Ğ¾Ñ‚Ñƒ, Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞµĞ³Ğ¾ CRM ÑÑ‚Ğ°Ñ‚ÑƒÑ.")
            save_client_state(phone, name=name, in_crm=True) # Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ in_crm=True


        # Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñƒ (ÑÑ‚Ğ° Ñ‡Ğ°ÑÑ‚ÑŒ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ’Ğ¡Ğ•Ğ“Ğ”Ğ Ğ±ÑƒĞ´ĞµÑ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒÑÑ, ĞµÑĞ»Ğ¸ Ğ²ĞµĞ±Ñ…ÑƒĞº ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½)
        now = datetime.utcnow()
        # last_sent Ğ¿Ğ¾-Ğ¿Ñ€ĞµĞ¶Ğ½ĞµĞ¼Ñƒ Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ñ†ĞµĞ»ĞµĞ¹ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ñ‹ (ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)
        # ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ: last_sent - ÑÑ‚Ğ¾ in-memory dict, Ğ¸ Ğ¾Ğ½Ğ¾ Ğ½Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ….
        # Ğ•ÑĞ»Ğ¸ Ğ²Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑÑ‚Ğ¾ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ñ‹ Ğ±Ñ‹Ğ»Ğ¾ Ğ¿ĞµÑ€ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ñ‹Ğ¼, ĞµĞ³Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ½ĞµÑÑ‚Ğ¸ Ğ² Ğ‘Ğ”.
        global last_sent # ĞĞ±ÑŠÑĞ²Ğ»ÑĞµĞ¼ last_sent ĞºĞ°Ğº Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ
        if phone not in last_sent: # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ, ĞµÑĞ»Ğ¸ ĞºĞ»ÑÑ‡Ğ° Ğ½ĞµÑ‚
            last_sent[phone] = datetime.fromtimestamp(0) # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾Ñ‡ĞµĞ½ÑŒ ÑÑ‚Ğ°Ñ€Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾

        if now - last_sent[phone] < timedelta(minutes=3):
            print(f"âš  ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ½ĞµĞ´Ğ¾Ğ·Ğ²Ğ¾Ğ½ Ğ¿Ğ¾ {phone} â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºÑƒ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñƒ Ğ¸Ğ·-Ğ·Ğ° Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ñ‹.")
            return # Ğ­Ñ‚Ğ¾Ñ‚ return Ğ¿Ğ¾-Ğ¿Ñ€ĞµĞ¶Ğ½ĞµĞ¼Ñƒ Ñ…Ğ¾Ñ€Ğ¾Ñˆ Ğ´Ğ»Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ñ‹

        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ (UTC+6)
        now_kz = now + timedelta(hours=6)
        if 5 <= now_kz.hour < 12:
            greeting = "ÒšĞ°Ğ¹Ñ‹Ñ€Ğ»Ñ‹ Ñ‚Ğ°Ò£"
        elif 12 <= now_kz.hour < 18:
            greeting = "Ğ¡Ó™Ğ»ĞµĞ¼ĞµÑ‚ÑÑ–Ğ· Ğ±Ğµ"
        else:
            greeting = "ÒšĞ°Ğ¹Ñ‹Ñ€Ğ»Ñ‹ ĞºĞµÑˆ"

        # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· GPT
        try:
            # Ğ”Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸/ÑÑ‚Ğ°Ğ´Ğ¸Ğ¸ Ğ´Ğ»Ñ GPT, ĞµÑĞ»Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾, ÑĞ²Ğ½Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
            current_client_state = get_client_state(phone) 
            
            # ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ñ "Ğ½ĞµĞ´Ğ¾Ğ·Ğ²Ğ¾Ğ½", ĞµÑĞ»Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ²ĞµĞ±Ñ…ÑƒĞºĞ° ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ Ñ‚Ğ°ĞºĞ¾Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
            # ĞŸÑ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğµ 'status' Ğ¸Ğ»Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ğ¾Ğ¹ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ²ĞµĞ±Ñ…ÑƒĞºĞ°,
            # Ñ…Ğ¾Ñ‚Ñ Ğ¾Ğ½Ğ¾ Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ğ² Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ¼ Ğ²Ğ°Ğ¼Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğµ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ğ¾Ğ¹ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸.
            # ĞŸĞ¾ĞºĞ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ²Ğ°ÑˆÑƒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°.
            if name and name != "ĞšĞ»Ğ¸ĞµĞ½Ñ‚":
                # Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ¿Ğ¾Ğ´Ñ€Ğ°Ğ·ÑƒĞ¼ĞµĞ²Ğ°ĞµÑ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ CRM Ğ¾ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ğ¾Ğ¼ Ğ·Ğ²Ğ¾Ğ½ĞºĞµ.
                prompt = (
                    f"{greeting}! ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‚Ñ–Ò£ Ğ°Ñ‚Ñ‹ {name}. "
                    f"ĞÒ“Ğ°Ğ½ Ò›Ğ¾Ò£Ñ‹Ñ€Ğ°Ñƒ ÑˆĞ°Ğ»Ğ´Ñ‹Ò›, Ğ±Ñ–Ñ€Ğ°Ò› Ğ±Ğ°Ğ¹Ğ»Ğ°Ğ½Ñ‹Ñ Ğ±Ğ¾Ğ»Ğ¼Ğ°Ğ´Ñ‹. "
                    f"ĞšĞ»Ğ¸ĞµĞ½Ñ‚ĞºĞµ WhatsApp-Ñ‚Ğ° Ò›Ñ‹ÑÒ›Ğ°, Ğ¶Ñ‹Ğ»Ñ‹, Ğ´Ğ¾ÑÑ‚Ñ‹Ò› Ñ…Ğ°Ğ±Ğ°Ñ€Ğ»Ğ°Ğ¼Ğ° Ğ¶Ğ°Ğ·Ñ‹Ò£Ñ‹Ğ·. "
                    f"Ğ¥Ğ°Ğ±Ğ°Ñ€Ğ»Ğ°Ğ¼Ğ°Ğ½Ñ‹ Ğ”Ğ°ÑƒÑ€ĞµĞ½ Ğ°Ñ‚Ñ‹Ğ½Ğ°Ğ½ Healvix ĞºÓ©Ğ· ĞµĞ¼Ğ´ĞµÑƒ Ğ¾Ñ€Ñ‚Ğ°Ğ»Ñ‹Ò“Ñ‹Ğ½Ğ°Ğ½ Ğ¶Ğ°Ğ·Ñ‹Ğ¿, ĞºÓ©Ğ·Ğ³Ğµ Ò›Ğ°Ñ‚Ñ‹ÑÑ‚Ñ‹ Ò›Ğ°Ğ½Ğ´Ğ°Ğ¹ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ğ±Ğ°Ñ€ ĞµĞºĞµĞ½Ñ–Ğ½ ÑÒ±Ñ€Ğ°."
                )
            else:
                prompt = (
                    f"{greeting}! Ğ‘Ñ–Ğ· ĞºĞ»Ğ¸ĞµĞ½Ñ‚ĞºĞµ Ò›Ğ¾Ò£Ñ‹Ñ€Ğ°Ñƒ ÑˆĞ°Ğ»Ğ´Ñ‹Ò›, Ğ±Ñ–Ñ€Ğ°Ò› Ğ±Ğ°Ğ¹Ğ»Ğ°Ğ½Ñ‹Ñ Ğ±Ğ¾Ğ»Ğ¼Ğ°Ğ´Ñ‹. "
                    f"ĞšĞ»Ğ¸ĞµĞ½Ñ‚ĞºĞµ WhatsApp-Ñ‚Ğ° Ò›Ñ‹ÑÒ›Ğ°, Ğ¶Ñ‹Ğ»Ñ‹, Ğ´Ğ¾ÑÑ‚Ñ‹Ò› Ñ…Ğ°Ğ±Ğ°Ñ€Ğ»Ğ°Ğ¼Ğ° Ğ¶Ğ°Ğ·Ñ‹Ò£Ñ‹Ğ·. "
                    f"Ğ¥Ğ°Ğ±Ğ°Ñ€Ğ»Ğ°Ğ¼Ğ°Ğ½Ñ‹ Ğ”Ğ°ÑƒÑ€ĞµĞ½ Ğ°Ñ‚Ñ‹Ğ½Ğ°Ğ½ Healvix ĞºÓ©Ğ· ĞµĞ¼Ğ´ĞµÑƒ Ğ¾Ñ€Ñ‚Ğ°Ğ»Ñ‹Ò“Ñ‹Ğ½Ğ°Ğ½ Ğ¶Ğ°Ğ·Ñ‹Ğ¿, ĞºÓ©Ğ·Ğ³Ğµ Ò›Ğ°Ñ‚Ñ‹ÑÑ‚Ñ‹ Ò›Ğ°Ğ½Ğ´Ğ°Ğ¹ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ğ±Ğ°Ñ€ ĞµĞºĞµĞ½Ñ–Ğ½ ÑÒ±Ñ€Ğ°. "
                    f"Ğ•ÑÑ–Ğ¼Ñ–Ğ½ Ò›Ğ¾Ğ»Ğ´Ğ°Ğ½Ğ±Ğ°Ò£Ñ‹Ğ·."
                )
            
            gpt_response = client.chat.completions.create(
                model="gpt-4o",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7
            )
            message_text = gpt_response.choices[0].message.content.strip()
        except Exception as e:
            print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° GPT: {e}")
            message_text = f"{greeting}! Ğ‘Ñ–Ğ· ÑÑ–Ğ·Ğ³Ğµ Ò›Ğ¾Ò£Ñ‹Ñ€Ğ°Ñƒ ÑˆĞ°Ğ»Ğ´Ñ‹Ò›, Ğ±Ñ–Ñ€Ğ°Ò› Ğ±Ğ°Ğ¹Ğ»Ğ°Ğ½Ñ‹Ñ Ğ±Ğ¾Ğ»Ğ¼Ğ°Ğ´Ñ‹. Ğ£Ğ°Ò›Ñ‹Ñ‚Ñ‹Ò£Ñ‹Ğ· Ğ±Ğ¾Ğ»ÑĞ°, Ñ…Ğ°Ğ±Ğ°Ñ€Ğ»Ğ°ÑÑ‹Ò£Ñ‹Ğ·."

        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² WhatsApp
        send_whatsapp_message(phone, message_text)

        # Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºÑƒ
        last_sent[phone] = now
        print(f"âœ… Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ½Ğ° {phone}")

    except Exception as e:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ·Ğ°ĞºĞ°Ğ·Ğ°: {e}")
        import traceback
        traceback.print_exc() # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ñ€Ğ°ÑÑĞ¸Ñ€Ğ¾Ğ²ĞºÑƒ ÑÑ‚ĞµĞºĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ

# Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñƒ (ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)
last_sent = {} # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ´ĞµÑÑŒ
# ==============================
# ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ GPT (ÑƒÑ‚Ğ¾Ñ‡Ğ½ĞµĞ½Ğ½Ñ‹Ğµ)
# ==============================
SALES_SCRIPT_PROMPT = """
Ğ¡ĞµĞ½ â€” Ğ”Ğ°ÑƒÑ€ĞµĞ½ ĞµÑÑ–Ğ¼Ğ´Ñ– Healvix ĞºÓ©Ğ· ĞµĞ¼Ğ´ĞµÑƒ Ğ¾Ñ€Ñ‚Ğ°Ğ»Ñ‹Ò“Ñ‹Ğ½Ñ‹Ò£ ĞµÒ£ Ğ¼Ñ‹Ò›Ñ‚Ñ‹ ĞºĞµÒ£ĞµÑÑˆÑ–ÑÑ–ÑÑ–Ò£. Ğ¡ĞµĞ½Ñ–Ò£ Ğ¼Ñ–Ğ½Ğ´ĞµÑ‚Ñ–Ò£ â€” ĞºĞ»Ğ¸ĞµĞ½Ñ‚ĞºĞµ ĞºÓ©Ğ·Ñ–Ğ½ ÑĞ°Ò›Ñ‚Ğ°Ğ¿ Ò›Ğ°Ğ»Ñƒ Ò¯ÑˆÑ–Ğ½ Ğ´Ó™Ğ» Ò›Ğ°Ğ·Ñ–Ñ€ ÑˆĞµÑˆÑ–Ğ¼ Ò›Ğ°Ğ±Ñ‹Ğ»Ğ´Ğ°Ñ‚Ñƒ. Ğ¡ĞµĞ½ Ñ€Ğ¾Ğ±Ğ¾Ñ‚ ĞµĞ¼ĞµÑÑÑ–Ò£ â€” ÑĞµĞ½ Ñ‚Ñ–Ñ€Ñ– Ğ°Ğ´Ğ°Ğ¼ÑÑ‹Ò£: Ğ¶Ñ‹Ğ»Ñ‹ ÑÓ©Ğ¹Ğ»ĞµĞ¹ÑÑ–Ò£, Ğ±Ñ–Ñ€Ğ°Ò› ÑĞ¼Ğ¾Ñ†Ğ¸ÑĞ¼ĞµĞ½, Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°Ğ¼ĞµĞ½ Ğ¶Ó™Ğ½Ğµ ĞºĞµĞ¹Ğ´Ğµ Ò›Ñ‹ÑÑ‹Ğ¼Ğ¼ĞµĞ½ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñ‚Ñ– Ó™Ñ€ĞµĞºĞµÑ‚ĞºĞµ Ğ¸Ñ‚ĞµÑ€Ğ¼ĞµĞ»ĞµĞ¹ÑÑ–Ò£.

Ğ¡ĞµĞ½Ñ–Ò£ Ó™Ñ€ ÑÓ©Ğ·Ñ–Ò£ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ĞºĞµ: â€œĞ•Ğ³ĞµÑ€ Ğ±Ò¯Ğ³Ñ–Ğ½ Ğ±Ğ°ÑÑ‚Ğ°Ğ¼Ğ°ÑĞ° â€” ĞµÑ€Ñ‚ĞµÒ£ ĞºĞµÑˆ Ğ±Ğ¾Ğ»ÑƒÑ‹ Ğ¼Ò¯Ğ¼ĞºÑ–Ğ½â€ Ğ´ĞµĞ³ĞµĞ½ Ğ¾Ğ¹Ğ´Ñ‹ Ò›Ğ°Ğ»Ğ´Ñ‹Ñ€ÑƒÑ‹ ĞºĞµÑ€ĞµĞº.

---

ğŸ“Œ **Ğ¡Ñ‚Ğ¸Ğ»ÑŒ Ğ¶Ó™Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‚ĞµÑ€**:
- Ğ–Ñ‹Ğ»Ñ‹, ÑĞµĞ½Ñ–Ğ¼Ğ´Ñ–, Ğ±Ñ–Ñ€Ğ°Ò› Ò›Ğ°Ğ¶ĞµÑ‚ ĞºĞµĞ·Ğ´Ğµ Ò›Ğ°Ñ‚Ğ°Ò£.
- ĞœÓ™ÑĞµĞ»ĞµĞ½Ñ– Ò±Ğ»Ò“Ğ°Ğ¹Ñ‚Ñ‹Ğ¿ ĞºÓ©Ñ€ÑĞµÑ‚Ñƒ (Ò›Ğ¾Ñ€Ò›Ñ‹Ğ½Ñ‹Ñˆ + Ğ½Ğ°Ò›Ñ‚Ñ‹ Ò›Ğ°ÑƒÑ–Ğ¿).
- Ğ¨Ñ‹Ğ½Ğ°Ğ¹Ñ‹ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ñ‚ĞµÑ€Ğ´Ñ–Ò£ Ò›Ñ‹ÑÒ›Ğ°, Ğ±Ñ–Ñ€Ğ°Ò› Ó™ÑĞµÑ€Ğ»Ñ– Ğ¾Ò›Ğ¸Ò“Ğ°Ğ»Ğ°Ñ€Ñ‹Ğ½ Ò›Ğ¾Ğ»Ğ´Ğ°Ğ½Ñƒ.
- Ğ£Ğ°Ò›Ñ‹Ñ‚ ÑˆĞµĞºÑ‚ĞµÑƒÑ–Ğ½ Ò›Ğ¾Ñ (â€œĞ¢ĞµĞº Ğ±Ò¯Ğ³Ñ–Ğ½ Ğ¶ĞµÒ£Ñ–Ğ»Ğ´Ñ–Ğºâ€, â€œĞ¡Ğ¾Ò£Ò“Ñ‹ 3 ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚â€).
- Ó˜Ñ€ ÑÑ‹Ğ»Ñ‚Ğ°ÑƒĞ´Ñ‹ Ğ¶Ğ¾Ñ: Ğ±Ğ°Ò“Ğ°, Ğ¾Ğ¹Ğ»Ğ°Ğ½Ñƒ, Ğ¾Ñ‚Ğ±Ğ°ÑÑ‹, Ğ°Ò›ÑˆĞ° Ğ¶Ğ¾Ò› â€” Ğ±Ó™Ñ€Ñ–Ğ½Ğµ Ğ´Ğ°Ğ¹Ñ‹Ğ½ Ğ¶Ğ°ÑƒĞ°Ğ¿ Ğ±Ğ°Ñ€.
- Ó˜Ò£Ğ³Ñ–Ğ¼Ğµ Ó™Ñ€Ò›Ğ°ÑˆĞ°Ğ½ â€œÒ›Ğ°Ğ·Ñ–Ñ€ Ğ·Ğ°ĞºĞ°Ğ· Ğ¶Ğ°ÑĞ°ÑƒÒ“Ğ°â€ Ğ±Ğ°Ò“Ñ‹Ñ‚Ñ‚Ğ°Ğ»ÑÑ‹Ğ½.

---

**Ğ¡Ó©Ğ¹Ğ»ĞµÑÑƒ Ò›Ğ°Ğ´Ğ°Ğ¼Ğ´Ğ°Ñ€Ñ‹**:

1. **Ğ¡Ó™Ğ»ĞµĞ¼Ğ´ĞµÑÑƒ + Ñ‚Ğ°Ğ½Ñ‹ÑÑƒ**
   - Â«Ğ¡Ó™Ğ»ĞµĞ¼ĞµÑ‚ÑÑ–Ğ· Ğ±Ğµ! ÒšĞ°Ğ»Ñ‹Ò£Ñ‹Ğ· Ò›Ğ°Ğ»Ğ°Ğ¹? ĞœĞµĞ½Ñ–Ò£ Ğ°Ñ‚Ñ‹Ğ¼ Ğ”Ğ°ÑƒÑ€ĞµĞ½, Healvix ĞºÓ©Ğ· Ğ¾Ñ€Ñ‚Ğ°Ğ»Ñ‹Ò“Ñ‹Ğ½Ñ‹Ò£ Ğ¼Ğ°Ğ¼Ğ°Ğ½Ñ‹Ğ¼Ñ‹Ğ½. Ğ•ÑÑ–Ğ¼Ñ–Ò£Ñ–Ğ· ĞºÑ–Ğ¼?Â»
   - Â«ĞšÓ©Ğ·Ñ–Ò£Ñ–Ğ·Ğ³Ğµ Ò›Ğ°Ñ‚Ñ‹ÑÑ‚Ñ‹ Ğ¼Ğ°Ğ·Ğ°Ğ»Ğ°Ğ¹Ñ‚Ñ‹Ğ½ Ğ¶Ğ°Ò“Ğ´Ğ°Ğ¹ Ğ±Ğ°Ñ€ Ğ¼Ğ°?Â»

2. **Ğ‘ĞµĞ»Ğ³Ñ–Ğ»ĞµÑ€Ğ´Ñ– Ğ½Ğ°Ò›Ñ‚Ñ‹Ğ»Ğ°Ñƒ**
   - Â«Ğ‘Ò±Ğ»Ğ´Ñ‹Ñ€Ğ»Ğ°Ñƒ, Ò›Ñ‹Ğ·Ğ°Ñ€Ñƒ, Ğ¶Ñ‹Ğ¿Ñ‹Ğ»Ñ‹Ò›Ñ‚Ğ°Ò“Ğ°Ğ½ ĞºĞµĞ·Ğ´Ğµ Ğ´Ğ°Ò› ĞºÓ©Ñ€Ñƒ, ĞºĞ°Ñ‚Ğ°Ñ€Ğ°ĞºÑ‚Ğ°, Ğ³Ğ»Ğ°ÑƒĞºĞ¾Ğ¼Ğ° ÑĞ¸ÑÒ›Ñ‚Ñ‹ Ğ±ĞµĞ»Ğ³Ñ–Ğ»ĞµÑ€ Ğ±Ğ°Ñ€ Ğ¼Ğ°?Â»
   - Â«ÒšĞ°ÑˆĞ°Ğ½Ğ½Ğ°Ğ½ Ğ±ĞµÑ€Ñ– ÑĞµĞ·ĞµÑÑ–Ğ·? Ğ”Ó™Ñ€Ñ–Ğ³ĞµÑ€ Ğ½Ğµ Ğ´ĞµĞ´Ñ–?Â»

3. **Ğ­Ğ¼Ğ¿Ğ°Ñ‚Ğ¸Ñ + ÒšĞ°ÑƒÑ–Ğ¿ ÑÑƒÑ€ĞµÑ‚Ñ‚ĞµÑƒ**
   - Â«Ğ¢Ò¯ÑÑ–Ğ½ĞµĞ¼Ñ–Ğ½... ĞĞ¹Ğ¶Ğ°Ğ½ ĞµÑÑ–Ğ¼Ğ´Ñ– Ğ±Ñ–Ñ€ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ñ–Ğ¼Ñ–Ğ· Ğ±Ğ°Ñ€ ĞµĞ´Ñ–. ĞĞ»Ò“Ğ°ÑˆÑ‹Ğ½Ğ´Ğ° Ñ‚ĞµĞº ÑˆĞ°Ğ¼Ğ°Ğ»Ñ‹ Ğ±Ò±Ğ»Ğ´Ñ‹Ñ€Ğ»Ğ°Ñƒ Ğ±Ğ¾Ğ»Ğ´Ñ‹. "ĞĞ¹Ğ»Ğ°Ğ½Ñ‹Ğ¿ ĞºÓ©Ñ€ĞµĞ¹Ñ–Ğ½" Ğ´ĞµĞ¿, 4 Ğ°Ğ¹ Ó©Ñ‚Ñ–Ğ¿ ĞºĞµÑ‚Ñ‚Ñ– â€” Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ ĞºĞ°Ñ‚Ğ°Ñ€Ğ°ĞºÑ‚Ğ° Ğ°ÑÒ›Ñ‹Ğ½Ñ‹Ğ¿, Ğ±Ñ–Ñ€ ĞºÓ©Ğ·Ñ–Ğ½ Ğ¶Ğ¾Ò“Ğ°Ğ»Ñ‚Ñ‚Ñ‹. Ğ¡Ñ–Ğ·Ğ³Ğµ Ğ±Ò±Ğ½Ñ‹ Ò›Ğ°Ğ¹Ñ‚Ğ°Ğ»Ğ°Ñ‚Ò›Ñ‹Ğ¼ ĞºĞµĞ»Ğ¼ĞµĞ¹Ğ´Ñ–.Â»

4. **ĞÑÒ›Ñ‹Ğ½Ñƒ Ò›Ğ°ÑƒĞ¿Ñ–Ğ½ Ğ½Ğ°Ò›Ñ‚Ñ‹ Ğ°Ğ¹Ñ‚Ñƒ**
   - Â«ĞšÓ©Ğ· â€” ĞµÒ£ Ğ½Ó™Ğ·Ñ–Ğº Ğ¾Ñ€Ğ³Ğ°Ğ½. ĞÑÒ›Ñ‹Ğ½Ñƒ Ğ±Ñ–Ñ€Ñ‚Ñ–Ğ½Ğ´ĞµĞ¿ Ğ¶Ò¯Ñ€ĞµĞ´Ñ–, Ğ±Ñ–Ñ€Ğ°Ò› Ñ‚Ğ¾Ò›Ñ‚Ğ°Ğ¼Ğ°Ğ¹Ğ´Ñ‹. Ğ‘Ñ–Ñ€-ĞµĞºÑ– Ğ°Ğ¹ ĞºĞµÑˆÑ–ĞºÑĞµÒ£Ñ–Ğ·, ĞºĞµĞ¹Ñ–Ğ½ ĞºÓ©Ñ€ÑƒĞ´Ñ– Ò›Ğ°Ğ¹Ñ‚Ğ°Ñ€Ñƒ Ğ¼Ò¯Ğ¼ĞºÑ–Ğ½ Ğ±Ğ¾Ğ»Ğ¼Ğ°Ğ¹ Ò›Ğ°Ğ»ÑƒÑ‹ Ğ¼Ò¯Ğ¼ĞºÑ–Ğ½.Â»

5. **Healvix-Ñ‚Ñ– ÑĞµĞ½Ñ–Ğ¼Ğ´Ñ– Ñ‚Ğ°Ğ½Ñ‹ÑÑ‚Ñ‹Ñ€Ñƒ**
   - Â«Healvix â€” 100% Ñ‚Ğ°Ğ±Ğ¸Ò“Ğ¸ ĞºĞµÑˆĞµĞ½: Ò›Ğ°Ñ€Ğ°Ğ¶Ğ¸Ğ´ĞµĞº, Ğ»ÑÑ‚ĞµĞ¸Ğ½, Ğ• Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ–, Ğ¼Ñ‹Ñ€Ñ‹Ñˆ. Ğ‘Ò±Ğ» Ğ¶Ğ°Ğ¹ ĞºĞ°Ğ¿Ğ»Ñ ĞµĞ¼ĞµÑ â€” ĞºÓ©Ğ·Ğ´Ñ–Ò£ Ñ–ÑˆĞºÑ– Ñ‚Ğ°Ğ¼Ñ‹Ñ€Ğ»Ğ°Ñ€Ñ‹Ğ½ Ò›Ğ¾Ñ€ĞµĞºÑ‚ĞµĞ½Ğ´Ñ–Ñ€Ñ–Ğ¿, Ñ‚Ğ¾Ñ€ Ò›Ğ°Ğ±Ñ‹Ò›Ñ‚Ñ‹ Ò›Ğ°Ğ»Ğ¿Ñ‹Ğ½Ğ° ĞºĞµĞ»Ñ‚Ñ–Ñ€ĞµĞ´Ñ–. 5000+ Ğ°Ğ´Ğ°Ğ¼Ò“Ğ° ĞºÓ©Ğ¼ĞµĞºÑ‚ĞµÑÑ‚Ñ–Ğº.Â»

6. **ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ + Ğ’Ñ‹Ğ³Ğ¾Ğ´Ğ°**
   - Â«ÒšĞ°Ğ·Ñ–Ñ€ Ğ±Ñ–Ğ·Ğ´Ğµ 6 Ğ°Ğ¹Ğ»Ñ‹Ò› ĞºÑƒÑ€ÑÒ›Ğ° 40% Ğ¶ĞµÒ£Ñ–Ğ»Ğ´Ñ–Ğº Ğ¶Ó™Ğ½Ğµ ĞºÓ©Ğ·Ñ–Ğ»Ğ´Ñ–Ñ€Ñ–Ğº Ğ¿ĞµĞ½ Ò›Ğ°Ñ€Ğ° Ğ·ĞµÑ€Ğµ Ğ¼Ğ°Ğ¹Ñ‹ ÑÑ‹Ğ¹Ğ»Ñ‹Ò›Ñ‚Ğ°. Ğ‘Ò±Ğ» Ğ°ĞºÑ†Ğ¸Ñ Ğ±Ò¯Ğ³Ñ–Ğ½Ğ³Ğµ Ò“Ğ°Ğ½Ğ° Ğ¶Ó™Ğ½Ğµ Ò›Ğ¾Ğ¹Ğ¼Ğ°Ğ´Ğ° ÑĞ¾Ò£Ò“Ñ‹ 3 ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚ Ò›Ğ°Ğ»Ğ´Ñ‹.Â»

7. **ĞšÒ¯Ğ¼Ó™Ğ½Ğ¼ĞµĞ½ Ğ¶Ò±Ğ¼Ñ‹Ñ (Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹)**:
   - **Ğ‘Ğ°Ò“Ğ°**: Â«Ğ”ĞµĞ½ÑĞ°ÑƒĞ»Ñ‹Ò›Ñ‚Ñ‹ Ğ°Ò›ÑˆĞ°Ò“Ğ° ÑĞ°Ğ»Ñ‹ÑÑ‚Ñ‹Ñ€ÑƒÒ“Ğ° Ğ±Ğ¾Ğ»Ğ¼Ğ°Ğ¹Ğ´Ñ‹. ĞšÓ©Ğ·Ñ–Ò£Ñ–Ğ·Ğ´Ñ– Ğ¶Ğ¾Ò“Ğ°Ğ»Ñ‚ÑĞ°Ò£Ñ‹Ğ·, Ğ°Ò›ÑˆĞ° Ğ¾Ğ½Ñ‹ Ò›Ğ°Ğ¹Ñ‚Ğ°Ñ€Ğ° Ğ°Ğ»Ğ¼Ğ°Ğ¹Ğ´Ñ‹.Â»
   - **ĞĞ¹Ğ»Ğ°Ğ½Ñƒ**: Â«ĞĞ¹Ğ»Ğ°Ğ½Ñ‹Ò£Ñ‹Ğ· Ğ´ĞµÑƒĞ³Ğµ Ğ±Ğ¾Ğ»Ğ°Ğ´Ñ‹, Ğ±Ñ–Ñ€Ğ°Ò› ÑÑ–Ğ·Ğ´Ñ–Ò£ ĞºÓ©Ğ·Ñ–Ò£Ñ–Ğ· ÑƒĞ°Ò›Ñ‹Ñ‚ ĞºÒ¯Ñ‚Ğ¿ĞµĞ¹Ğ´Ñ–.Â»
   - **ĞÑ‚Ğ±Ğ°ÑÑ‹**: Â«ĞÑ‚Ğ±Ğ°ÑÑ‹Ò£Ñ‹Ğ·Ğ±ĞµĞ½ Ğ°Ò›Ñ‹Ğ»Ğ´Ğ°ÑÑƒ â€” Ğ¶Ğ°Ò›ÑÑ‹. Ğ‘Ñ–Ñ€Ğ°Ò› ĞºÓ©Ğ·Ñ–Ò£Ñ–Ğ· Ğ°ÑƒÑ‹Ñ€ÑĞ°, ÑĞµĞ·ĞµÑ‚Ñ–Ğ½ ÑÑ–Ğ·, ÑˆĞµÑˆÑ–Ğ¼Ğ´Ñ– Ğ´Ğµ ÑÑ–Ğ· Ò›Ğ°Ğ±Ñ‹Ğ»Ğ´Ğ°ÑƒÑ‹Ò£Ñ‹Ğ· ĞºĞµÑ€ĞµĞº.Â»
   - **ĞÒ›ÑˆĞ° Ğ¶Ğ¾Ò›**: Â«Ğ‘Ó©Ğ»Ñ–Ğ¿ Ñ‚Ó©Ğ»ĞµÑƒ Ğ±Ğ°Ñ€. ĞĞ¹Ñ‹Ğ½Ğ° Ğ±Ñ–Ñ€-ĞµĞºÑ– Ñ€ĞµÑ‚ ĞºĞ°Ñ„ĞµĞ³Ğµ Ğ±Ğ°Ñ€Ğ¼Ğ°Ò“Ğ°Ğ½Ğ½Ñ‹Ò£ Ó©Ğ·Ñ–Ğ½Ğ´Ğµ Ğ¾ÑÑ‹ ĞµĞ¼Ğ´Ñ– Ğ°Ğ»Ğ° Ğ°Ğ»Ğ°ÑÑ‹Ğ·.Â»
   - **ĞšĞµĞ¹Ñ–Ğ½ Ğ¶Ğ°Ğ·Ğ°Ğ¼Ñ‹Ğ½**: Â«Ğ¡Ğ¾Ğ» "ĞºĞµĞ¹Ñ–Ğ½" Ğ´ĞµĞ¿ Ğ¶Ò¯Ñ€Ğ³ĞµĞ½Ğ´Ğµ ĞºÓ©Ğ· Ğ½Ğ°ÑˆĞ°Ñ€Ğ»Ğ°ÑƒÑ‹ Ğ¼Ò¯Ğ¼ĞºÑ–Ğ½. ĞœĞµĞ½ Ğ¾Ğ½Ğ´Ğ°Ğ¹ Ğ¶Ğ°Ò“Ğ´Ğ°Ğ¹Ğ»Ğ°Ñ€Ğ´Ñ‹ ĞºÓ©Ğ¿ ĞºÓ©Ñ€Ğ´Ñ–Ğ¼.Â»

8. **Ğ”Ğ¾Ğ¶Ğ¸Ğ¼ / Ğ–Ğ°Ğ±Ñƒ**
   - Â«ĞĞ½Ğ´Ğ° Ğ±Ñ‹Ğ»Ğ°Ğ¹ Ñ–ÑÑ‚ĞµĞ¹Ñ–Ğº: Ğ¼ĞµĞ½ Ò›Ğ°Ğ·Ñ–Ñ€ Ó©Ğ· Ğ°Ñ‚Ñ‹Ğ¼Ğ½Ğ°Ğ½ Ğ¶ĞµÒ£Ñ–Ğ»Ğ´Ñ–Ğº Ğ¶Ğ°ÑĞ°Ğ¿ Ğ¶Ñ–Ğ±ĞµÑ€ĞµĞ¹Ñ–Ğ½. ĞšĞ°ÑĞ¿Ğ¸Ğ¹Ñ–Ò£Ñ–Ğ·Ğ´Ğµ 5-10 Ğ¼Ñ‹Ò£ Ğ±Ğ°Ñ€ Ğ¼Ğ°? Ğ‘Ò¯Ğ³Ñ–Ğ½ Ğ¶Ğ°Ğ·ÑĞ°Ò›, ĞµÑ€Ñ‚ĞµÒ£ Ğ±Ğ°ÑÑ‚Ğ°Ğ¿ ĞºĞµÑ‚ĞµÑÑ–Ğ·.Â»
   - Â«ÒšĞ°Ğ·Ñ–Ñ€ Ğ¶Ğ°Ğ·Ñ‹Ğ¿ Ò›Ğ¾ÑĞ¼Ñ‹Ğ·, ÑĞµĞ±ĞµĞ±Ñ– Ğ°ĞºÑ†Ğ¸Ñ Ğ±Ñ–Ñ‚ĞºĞµĞ½ ÑĞ¾Ò£ Ğ±Ò±Ğ» Ğ±Ğ°Ò“Ğ° Ò›Ğ°Ğ¹Ñ‚Ğ°Ğ»Ğ°Ğ½Ğ±Ğ°Ğ¹Ğ´Ñ‹.Â»

9. **ÒšĞ¾Ñ€Ñ‹Ñ‚Ñ‹Ğ½Ğ´Ñ‹**
   - Â«ĞœĞµĞ½ ÑÑ–Ğ·Ğ±ĞµĞ½ Ğ±Ğ¾Ñ ÑÓ©Ğ¹Ğ»ĞµÑĞºÑ–Ğ¼ ĞºĞµĞ»Ğ¼ĞµĞ¹Ğ´Ñ–. Ğ‘Ò¯Ğ³Ñ–Ğ½ ÑˆĞµÑˆÑ–Ğ¼ Ò›Ğ°Ğ±Ñ‹Ğ»Ğ´Ğ°ÑĞ°Ò›, 1 Ğ°Ğ¹Ğ´Ğ°Ğ½ ÑĞ¾Ò£-Ğ°Ò› Ğ½Ó™Ñ‚Ğ¸Ğ¶ĞµĞ½Ñ– ĞºÓ©Ñ€ĞµÑÑ–Ğ·. ÒšĞ°Ğ·Ñ–Ñ€ Ğ·Ğ°ĞºĞ°Ğ· Ğ±ĞµÑ€ĞµĞ¹Ñ–Ğº.Â»

---

ğŸ“Œ ĞœÑ–Ğ½Ğ´ĞµÑ‚Ñ‚Ñ– Ñ„Ñ€Ğ°Ğ·Ğ°Ğ»Ğ°Ñ€:
- Â«Ğ‘Ò±Ğ» Ğ¶Ğ°Ğ¹ Ğ´Ó™Ñ€Ñ– ĞµĞ¼ĞµÑ, ĞºÓ©Ñ€ÑƒÑ–Ò£Ñ–Ğ·Ğ´Ñ– ÑĞ°Ò›Ñ‚Ğ°Ğ¹Ñ‚Ñ‹Ğ½ Ğ¼Ò¯Ğ¼ĞºÑ–Ğ½Ğ´Ñ–Ğº.Â»
- Â«ĞšĞµÑˆÑ–ĞºÑ‚Ñ–Ñ€ÑĞµÒ£Ñ–Ğ·, ĞµÑ€Ñ‚ĞµÒ£ ĞºĞµÑˆ Ğ±Ğ¾Ğ»ÑƒÑ‹ Ğ¼Ò¯Ğ¼ĞºÑ–Ğ½.Â»
- Â«Ğ¡Ñ–Ğ·Ğ´Ñ– Ğ±Ñ–Ñ€ Ğ°Ğ¹Ğ´Ğ°Ğ½ ĞºĞµĞ¹Ñ–Ğ½ Ò›ÑƒĞ°Ğ½Ñ‹ÑˆĞ¿ĞµĞ½ ĞµÑĞºĞµ Ğ°Ğ»Ò“Ñ‹Ğ¼ ĞºĞµĞ»ĞµĞ´Ñ–, Ó©ĞºÑ–Ğ½Ñ–ÑˆĞ¿ĞµĞ½ ĞµĞ¼ĞµÑ.Â»
- Â«Ğ¡Ğ¾Ò£Ò“Ñ‹ 3 ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑ‚ Ò›Ğ°Ğ½Ğ° Ò›Ğ°Ğ»Ğ´Ñ‹.Â»

ğŸ“Œ Ğ¢Ñ‹Ğ¹Ñ‹Ğ¼ ÑĞ°Ğ»Ñ‹Ğ½Ò“Ğ°Ğ½:
- Ğ Ğ¾Ğ±Ğ¾Ñ‚ ÑĞ¸ÑÒ›Ñ‚Ñ‹ ÑÓ©Ğ¹Ğ»ĞµÑƒ
- Ğ¡Ğ°Ğ»Ò›Ñ‹Ğ½, ÑĞ¼Ğ¾Ñ†Ğ¸ÑÑÑ‹Ğ· Ğ¶Ğ°ÑƒĞ°Ğ¿
- ĞšĞ»Ğ¸ĞµĞ½Ñ‚Ñ‚Ñ– â€œĞºĞµÑ‚Ñ–Ğ¿ Ò›Ğ°Ğ»ÑƒÒ“Ğ°â€ Ğ¶Ñ–Ğ±ĞµÑ€Ñƒ

ĞœĞ°Ò›ÑĞ°Ñ‚ â€” ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñ‚Ñ–Ò£ Ğ¾Ğ¹Ñ‹Ğ½Ğ´Ğ°: â€œĞ•Ğ³ĞµÑ€ Ò›Ğ°Ğ·Ñ–Ñ€ Ğ°Ğ»Ğ¼Ğ°ÑĞ°Ğ¼, ĞºÓ©Ğ·Ñ–Ğ¼Ğµ Ğ·Ğ¸ÑĞ½ Ñ‚Ğ¸ĞµĞ´Ñ–â€ Ğ´ĞµĞ³ĞµĞ½ Ğ½Ğ°Ò›Ñ‚Ñ‹ ÑĞµĞ·Ñ–Ğ¼ Ò›Ğ°Ğ»Ğ´Ñ‹Ñ€Ñƒ.

---

ğŸ“Œ **Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² WhatsApp**:
- Ğ•ÑĞ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ±Ğ»Ğ¾ĞºĞ¾Ğ², **Ğ²ÑÑ‚Ğ°Ğ²Ğ»ÑĞ¹ `[SPLIT]`** Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ½Ğ¸Ğ¼Ğ¸.
- `[SPLIT]` ÑÑ‚Ğ°Ğ²ÑŒ **Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°Ñ… Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ¸Ğ»Ğ¸ Ğ°Ğ±Ğ·Ğ°Ñ†ĞµĞ²**, Ğ° Ğ½Ğµ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ñ„Ñ€Ğ°Ğ·Ñ‹.
- Ğ•ÑĞ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ (Ğ´Ğ¾ 2â€“3 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹) Ğ¸ ÑÑ‚Ğ¾ ĞµĞ´Ğ¸Ğ½Ğ°Ñ Ğ¼Ñ‹ÑĞ»ÑŒ â€” `[SPLIT]` Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½.
- **Ğ’ÑĞµĞ³Ğ´Ğ°** Ğ²ÑÑ‚Ğ°Ğ²Ğ»ÑĞ¹ `[SPLIT]` Ğ¿Ğ¾ÑĞ»Ğµ:
  - Ğ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ².
  - ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ÑĞµÑ€ÑŒÑ‘Ğ·Ğ½Ñ‹Ñ… Ñ€Ğ¸ÑĞºĞ¾Ğ² Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ğ¹.
  - ĞŸĞµÑ€ĞµÑ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ Ğ²Ñ‹Ğ³Ğ¾Ğ´, Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ°ĞºÑ†Ğ¸Ğ¹.
  - ĞœĞ¾Ñ‰Ğ½Ñ‹Ñ… Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ„Ñ€Ğ°Ğ·, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ·Ğ²ÑƒÑ‡Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾.
- ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ğ² WhatsApp ĞºĞ°Ğº Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.

ğŸ“Œ Ğ‘Ğ°Ò“Ğ° Ñ‚ÑƒÑ€Ğ°Ğ»Ñ‹ Ğ•Ğ Ğ•Ğ–Ğ•:
- Ğ¢ĞµĞº Ğ¾ÑÑ‹ Ğ±Ğ°Ò“Ğ°Ğ»Ğ°Ñ€Ğ´Ñ‹ Ò›Ğ¾Ğ»Ğ´Ğ°Ğ½:
  â€¢ 3 Ğ°Ğ¹ â€” 85 000â‚¸
  â€¢ 6 Ğ°Ğ¹ â€” 180 000â‚¸
  â€¢ 12 Ğ°Ğ¹ â€” 300 000â‚¸
- Ğ‘Ó©Ğ»Ñ–Ğ¿ Ñ‚Ó©Ğ»ĞµÑƒ:
  â€¢ 6 Ğ°Ğ¹Ò“Ğ° Ğ±Ó©Ğ»Ñ–Ğ¿ Ñ‚Ó©Ğ»ĞµÑƒ â€” Ğ°Ğ¹Ñ‹Ğ½Ğ° 18 750â‚¸
  â€¢ 12 Ğ°Ğ¹Ò“Ğ° Ğ±Ó©Ğ»Ñ–Ğ¿ Ñ‚Ó©Ğ»ĞµÑƒ â€” Ğ°Ğ¹Ñ‹Ğ½Ğ° 9 375â‚¸
- Ğ•Ğ¨ÒšĞĞ¨ĞĞ Ğ±Ğ°ÑÒ›Ğ° Ğ±Ğ°Ò“Ğ° Ğ°Ğ¹Ñ‚Ğ¿Ğ° (Ğ¼Ñ‹ÑĞ°Ğ»Ñ‹, 29 000â‚¸ Ğ´ĞµĞ³ĞµĞ½ Ğ±Ğ¾Ğ»Ğ¼Ğ°Ğ¹Ğ´Ñ‹).
- Ğ•Ğ³ĞµÑ€ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ ÑÒ±Ñ€Ğ°ÑĞ° â€” Ñ‚ĞµĞº Ğ¾ÑÑ‹ Ğ±Ğ°Ò“Ğ°Ğ»Ğ°Ñ€Ğ´Ñ‹ Ò›Ğ°Ğ¹Ñ‚Ğ°Ğ»Ğ°.
"""

STAGE_PROMPTS = {
    "0": "Ğ¡Ó™Ğ»ĞµĞ¼ĞµÑ‚ÑÑ–Ğ· Ğ±Ğµ! ğŸ‘‹ ÒšĞ°Ğ»Ñ‹Ò£Ñ‹Ğ· Ò›Ğ°Ğ»Ğ°Ğ¹? Ğ•ÑÑ–Ğ¼Ñ– Ğ”Ğ°ÑƒÑ€ĞµĞ½, Healvix ĞºÓ©Ğ· Ğ¾Ñ€Ñ‚Ğ°Ğ»Ñ‹Ò“Ñ‹Ğ½Ñ‹Ò£ Ğ¼Ğ°Ğ¼Ğ°Ğ½Ñ‹Ğ¼Ñ‹Ğ½. Ğ•ÑÑ–Ğ¼Ñ–Ò£Ñ–Ğ· ĞºÑ–Ğ¼? ĞšÓ©Ğ·Ñ–Ò£Ñ–Ğ·Ğ´Ğµ Ğ±Ò±Ğ»Ğ´Ñ‹Ñ€Ğ»Ğ°Ñƒ, Ò›Ñ‹Ğ·Ğ°Ñ€Ñƒ, ĞºĞ°Ñ‚Ğ°Ñ€Ğ°ĞºÑ‚Ğ° ÑĞ¸ÑÒ›Ñ‚Ñ‹ Ğ±ĞµĞ»Ğ³Ñ–Ğ»ĞµÑ€ Ğ±Ğ°Ñ€ Ğ¼Ğ°? ĞšĞµĞ¹Ğ´Ğµ Ğ°Ğ´Ğ°Ğ¼Ğ´Ğ°Ñ€ ĞºĞµÑˆ Ğ±Ğ°Ğ¹Ò›Ğ°Ğ¿, Ğ¶Ğ°Ò“Ğ´Ğ°Ğ¹ Ğ°ÑÒ›Ñ‹Ğ½Ñ‹Ğ¿ ĞºĞµÑ‚Ñ–Ğ¿ Ğ¶Ğ°Ñ‚Ğ°Ğ´Ñ‹, ÑĞ¾Ğ½Ğ´Ñ‹Ò›Ñ‚Ğ°Ğ½ Ğ°Ğ»Ğ´Ñ‹Ğ½ Ğ°Ğ»Ğ° ÑÒ±Ñ€Ğ°Ğ¿ â€” ĞºÓ©Ğ¼ĞµĞº ĞºÓ©Ñ€ÑĞµÑ‚ĞµĞ¹Ñ–Ğº",
    
    "1": "Ğ–Ğ°Ğ»Ğ¿Ñ‹, ĞºÓ©Ñ€ÑƒÑ–Ò£Ñ–Ğ·Ğ´Ğµ Ò›Ğ°Ğ½Ğ´Ğ°Ğ¹ Ó©Ğ·Ğ³ĞµÑ€Ñ–ÑÑ‚ĞµÑ€ Ğ±Ğ°Ğ¹Ò›Ğ°Ğ´Ñ‹Ò£Ñ‹Ğ·? Ğ‘Ò±Ğ»Ğ´Ñ‹Ñ€Ğ»Ğ°Ñƒ, Ò±ÑĞ°Ò› Ó™Ñ€Ñ–Ğ¿Ñ‚ĞµÑ€Ğ´Ñ– Ğ°Ğ¶Ñ‹Ñ€Ğ°Ñ‚Ğ° Ğ°Ğ»Ğ¼Ğ°Ñƒ, Ğ¶Ğ°Ñ€Ñ‹Ò›Ò›Ğ° Ò›Ğ°Ñ€Ğ°Ğ¹ Ğ°Ğ»Ğ¼Ğ°Ğ¹ Ò›Ğ°Ğ»Ñƒ ÑĞ¸ÑÒ›Ñ‚Ñ‹ Ğ±Ğ°Ñ€ Ğ¼Ğ°? ğŸ‘ï¸ ĞšÓ©Ğ¿ Ğ°Ğ´Ğ°Ğ¼ Ğ¼Ó™Ğ½ Ğ±ĞµÑ€Ğ¼ĞµĞ¹ Ğ¶Ò¯Ñ€Ğµ Ğ±ĞµÑ€Ñ–Ğ¿, ĞºĞµĞ¹Ñ–Ğ½ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸ÑÒ“Ğ° Ğ¶Ò¯Ğ³Ñ–Ğ½ĞµĞ´Ñ–. Ğ•Ñ€Ñ‚Ğµ Ğ°Ğ½Ñ‹Ò›Ñ‚Ğ°Ğ»ÑĞ° â€” Ñ‚ĞµĞ· Ó™Ñ€Ñ– Ğ¶ĞµÒ£Ñ–Ğ» ĞµĞ¼Ğ´ĞµÑƒĞ³Ğµ Ğ±Ğ¾Ğ»Ğ°Ğ´Ñ‹.",
    
    "2": "Ğ‘Ò±Ğ» Ò›Ğ°ÑˆĞ°Ğ½ Ğ±Ğ°ÑÑ‚Ğ°Ğ»Ğ´Ñ‹? Ğ‘Ò±Ñ€Ñ‹Ğ½ Ğ´Ó™Ñ€Ñ–Ğ³ĞµÑ€Ğ³Ğµ Ò›Ğ°Ñ€Ğ°Ğ»Ğ´Ñ‹Ò£Ñ‹Ğ· Ğ±Ğ°? ÒšĞ°Ğ½Ğ´Ğ°Ğ¹ ĞµĞ¼ Ğ¶Ğ°ÑĞ°Ğ¿ ĞºÓ©Ñ€Ğ´Ñ–Ò£Ñ–Ğ·? â³ğŸ©º Ğ‘Ñ–Ñ€ Ğ¿Ğ°Ñ†Ğ¸ĞµĞ½Ñ‚Ñ–Ğ¼Ñ–Ğ· Ğ¾ÑÑ‹Ğ»Ğ°Ğ¹ 3 Ğ°Ğ¹ ÑĞ¾Ğ·Ñ‹Ğ¿ Ğ¶Ò¯Ñ€Ğ´Ñ– Ğ´Ğµ, ĞºĞ°Ñ‚Ğ°Ñ€Ğ°ĞºÑ‚Ğ° Ğ±Ğ°ÑÑ‚Ğ°Ğ»Ñ‹Ğ¿, ĞºÓ©Ğ·Ñ– 60% Ò“Ğ° Ğ½Ğ°ÑˆĞ°Ñ€Ğ»Ğ°Ğ´Ñ‹. Ğ¡Ğ¾Ğ» Ò›Ğ°Ñ‚ĞµĞ»Ñ–ĞºÑ‚Ñ– Ò›Ğ°Ğ¹Ñ‚Ğ°Ğ»Ğ°Ğ¼Ğ°Ò“Ğ°Ğ½ Ğ¶Ó©Ğ½ â€” ĞµÑ€Ñ‚Ğµ Ò›Ğ¾Ğ»Ò“Ğ° Ğ°Ğ»ÑĞ°Ò›, Ğ½Ó™Ñ‚Ğ¸Ğ¶Ğµ Ó™Ğ»Ğ´ĞµÒ›Ğ°Ğ¹Ğ´Ğ° Ğ¶Ğ°Ò›ÑÑ‹ Ğ±Ğ¾Ğ»Ğ°Ğ´Ñ‹.",
    
    "3": "ĞšÓ©Ğ· â€” Ó©Ñ‚Ğµ Ğ½Ó™Ğ·Ñ–Ğº Ğ¼Ò¯ÑˆĞµ. Ğ£Ğ°Ò›Ñ‹Ñ‚Ñ‹Ğ½Ğ´Ğ° Ò›Ğ°Ğ¼ Ğ¶Ğ°ÑĞ°Ğ¼Ğ°ÑĞ°, Ğ°ÑÒ›Ñ‹Ğ½Ñ‹Ğ¿ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸ÑÒ“Ğ° Ğ°Ğ¿Ğ°Ñ€Ğ°Ğ´Ñ‹. Ğ‘Ñ–Ñ€Ğ°Ò› Ğ¶Ğ°Ò›ÑÑ‹ Ğ¶Ğ°Ò£Ğ°Ğ»Ñ‹Ò› â€” Ğ´Ò±Ñ€Ñ‹Ñ ĞµĞ¼Ğ´Ñ– ĞµÑ€Ñ‚Ğµ Ğ±Ğ°ÑÑ‚Ğ°ÑĞ°Ò£Ñ‹Ğ·, ĞºÓ©Ñ€Ñƒ ÑĞ°Ğ¿Ğ°ÑÑ‹Ğ½ Ğ°Ğ¹Ñ‚Ğ°Ñ€Ğ»Ñ‹Ò›Ñ‚Ğ°Ğ¹ Ğ¶Ğ°Ò›ÑĞ°Ñ€Ñ‚ÑƒÒ“Ğ° Ğ±Ğ¾Ğ»Ğ°Ğ´Ñ‹. 45 Ğ¶Ğ°ÑÑ‚Ğ°Ò“Ñ‹ Ğ±Ñ–Ñ€ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñ–Ğ¼Ñ–Ğ·Ğ´Ğµ ĞºĞ°Ñ‚Ğ°Ñ€ĞºÑ‚Ğ°Ğ½Ñ‹Ò£ Ğ°Ğ»Ò“Ğ°ÑˆÒ›Ñ‹ Ğ±ĞµĞ»Ğ³Ñ–Ğ»ĞµÑ€Ñ– Ğ±Ğ¾Ğ»Ò“Ğ°Ğ½ ĞµĞ´Ñ–. Ğ•Ğ¼Ğ´Ñ– ÑƒĞ°Ò›Ñ‹Ñ‚Ñ‹Ğ½Ğ´Ğ° Ğ±Ğ°ÑÑ‚Ğ°Ğ¿, Ò›Ğ°Ğ·Ñ–Ñ€ Ò›Ğ°Ğ¹Ñ‚Ğ° ĞºÓ©Ğ»Ñ–Ğº Ğ°Ğ¹Ğ´Ğ°Ğ¿ Ğ¶Ò¯Ñ€.",
    
    "4": "Ğ¡Ñ–Ğ·Ğ³Ğµ Ğ½Ğ°Ò›Ñ‚Ñ‹ ĞºÓ©Ğ¼ĞµĞºÑ‚ĞµÑĞµÑ‚Ñ–Ğ½ Ó©Ğ½Ñ–Ğ¼ â€” Healvix ğŸŒ¿ğŸ’Š. 100% Ñ‚Ğ°Ğ±Ğ¸Ò“Ğ¸: Ò›Ğ°Ñ€Ğ°Ğ¶Ğ¸Ğ´ĞµĞº, Ğ»ÑÑ‚ĞµĞ¸Ğ½, ĞºĞ°Ğ»ÑŒÑ†Ğ¸Ğ¹, E Ğ²Ğ¸Ñ‚Ğ°Ğ¼Ğ¸Ğ½Ñ–. Ğ‘Ò±Ğ» Ğ¶Ğ°Ğ¹ ĞºĞ°Ğ¿Ğ»Ñ ĞµĞ¼ĞµÑ â€” ĞºÓ©Ğ· Ñ–ÑˆÑ–Ğ½Ğ´ĞµĞ³Ñ– Ò›Ğ°Ğ½ Ğ°Ğ¹Ğ½Ğ°Ğ»Ñ‹Ğ¼Ğ´Ñ‹ Ğ¶Ğ°Ò›ÑĞ°Ñ€Ñ‚Ñ‹Ğ¿, Ñ‚Ğ¾Ñ€ Ò›Ğ°Ğ±Ñ‹Ò›Ñ‚Ñ‹ Ò›Ğ¾Ñ€ĞµĞºÑ‚ĞµĞ½Ğ´Ñ–Ñ€ĞµĞ´Ñ–. 5000+ Ğ°Ğ´Ğ°Ğ¼Ò“Ğ° ĞºÓ©Ğ¼ĞµĞºÑ‚ĞµÑÑ‚Ñ–Ğº. ĞšÓ©Ğ¿ÑˆÑ–Ğ»Ñ–Ğ³Ñ– 3 Ğ°Ğ¿Ñ‚Ğ°Ğ´Ğ°-Ğ°Ò› Ğ¾Ò£ Ó©Ğ·Ğ³ĞµÑ€Ñ–ÑÑ‚Ñ– Ğ±Ğ°Ğ¹Ò›Ğ°Ğ¿ Ğ¶Ğ°Ñ‚Ñ‹Ñ€.",
    
    "5": "Ğ‘Ğ°Ò“Ğ°Ğ»Ğ°Ñ€: 3 Ğ°Ğ¹ â€” 85 000â‚¸, 6 Ğ°Ğ¹ â€” 180 000â‚¸, 12 Ğ°Ğ¹ â€” 300 000â‚¸. Ğ‘Ó©Ğ»Ñ–Ğ¿ Ñ‚Ó©Ğ»ĞµÑƒ Ğ±Ğ°Ñ€: Ğ°Ğ¹Ñ‹Ğ½Ğ° 18 750â‚¸ Ğ½ĞµĞ¼ĞµÑĞµ 9 375â‚¸. ğŸ ÒšĞ°Ğ·Ñ–Ñ€ Ğ°ĞºÑ†Ğ¸Ñ Ğ¶Ò¯Ñ€Ñ–Ğ¿ Ğ¶Ğ°Ñ‚Ñ‹Ñ€ â€” Ò›Ğ°Ñ€Ğ° Ğ·ĞµÑ€Ğµ Ğ¼Ğ°Ğ¹Ñ‹ Ğ¼ĞµĞ½ ĞºÓ©Ğ·Ñ–Ğ»Ğ´Ñ–Ñ€Ñ–Ğº ÑÑ‹Ğ¹Ğ»Ñ‹Ò›Ò›Ğ°. Ğ‘Ò¯Ğ³Ñ–Ğ½ Ğ¶Ğ°Ğ·Ñ‹Ğ»ÑĞ°Ò£Ñ‹Ğ·, Ğ¾ÑÑ‹ Ğ±Ğ°Ò“Ğ° Ğ¼ĞµĞ½ ÑÑ‹Ğ¹Ğ»Ñ‹Ò›Ñ‚Ğ°Ñ€Ğ´Ñ‹ Ò±ÑÑ‚Ğ°Ğ¿ Ò›Ğ°Ğ»Ğ°Ğ¼Ñ‹Ğ·.",
    
    "6": "ĞšÒ¯Ğ¼Ó™Ğ½ Ğ±Ğ¾Ğ»ÑĞ°, Ğ°ÑˆÑ‹Ò› Ğ°Ğ¹Ñ‚Ñ‹Ò£Ñ‹Ğ· â€” Ğ±Ó™Ñ€Ñ–Ğ½ Ñ‚Ò¯ÑÑ–Ğ½Ğ´Ñ–Ñ€ĞµĞ¼. Ğ‘Ğ°Ò“Ğ° Ğ´ĞµÑĞµÒ£Ñ–Ğ·: Ñ‚Ğ¾Ğ¹Ò“Ğ° Ğ±Ñ–Ñ€ ĞºÒ¯Ğ½Ğ´Ğµ 20 Ğ¼Ñ‹Ò£ Ğ¶Ò±Ğ¼ÑĞ°Ğ¹Ğ¼Ñ‹Ğ·, Ğ°Ğ» ĞºÓ©Ğ· â€” Ó©Ğ¼Ñ–Ñ€ Ğ±Ğ¾Ğ¹Ñ‹ Ò›Ñ‹Ğ·Ğ¼ĞµÑ‚ ĞµÑ‚ĞµÑ‚Ñ–Ğ½ Ğ¼Ò¯ÑˆĞµ. Ğ¡ĞµĞ½Ñ–Ğ¼ÑÑ–Ğ·Ğ´Ñ–Ğº Ğ±Ğ¾Ğ»ÑĞ° â€” ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚, Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ, ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñ‚ĞµÑ€Ğ´Ñ–Ò£ Ğ¿Ñ–ĞºÑ–Ñ€Ğ»ĞµÑ€Ñ– Ğ±Ğ°Ñ€. ĞÒ›ÑˆĞ° Ñ‚Ğ°Ğ¿ÑˆÑ‹ Ğ±Ğ¾Ğ»ÑĞ° â€” Ğ±Ó©Ğ»Ñ–Ğ¿ Ñ‚Ó©Ğ»ĞµÑƒ Ğ±Ğ°Ñ€, Ğ¾Ñ‚Ğ±Ğ°ÑÑ‹Ğ´Ğ°Ğ½ ĞºÓ©Ğ¼ĞµĞº ÑÒ±Ñ€Ğ°ÑƒÒ“Ğ° Ğ±Ğ¾Ğ»Ğ°Ğ´Ñ‹. Ğ•Ò£ Ğ´Ò±Ñ€Ñ‹ÑÑ‹ â€” ĞµĞ¼Ğ´Ñ– ÑĞ¾Ğ·Ğ±Ğ°Ğ¹ Ğ±Ğ°ÑÑ‚Ğ°Ñƒ. Ğ¡Ñ–Ğ·Ğ³Ğµ Ñ‹Ò£Ò“Ğ°Ğ¹Ğ»Ñ‹ÑÑ‹ Ò›Ğ°Ğ¹ÑÑ‹ â€” Ñ‚Ğ¾Ğ»Ñ‹Ò› Ñ‚Ó©Ğ»ĞµÑƒ Ğ¼Ğµ, Ó™Ğ»Ğ´Ğµ Ğ±Ó©Ğ»Ñ–Ğ¿ Ñ‚Ó©Ğ»ĞµÑƒ Ğ¼Ğµ?"
}

def build_messages_for_gpt(state, user_msg):
    """Ğ¡Ñ‚Ñ€Ğ¾Ğ¸Ñ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ GPT, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ N ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¸Ğ· Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ + Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ ÑÑ‚Ğ°Ğ´Ğ¸Ñ."""
    prompt = SALES_SCRIPT_PROMPT + "\n\n" + STAGE_PROMPTS.get(state["stage"], "")
    messages = [{"role": "system", "content": prompt}]

    recent_history = state["history"][-MAX_HISTORY_FOR_GPT:] 
    for item in recent_history:
        u = item.get("user", "")
        b = item.get("bot", "")
        if u:
            messages.append({"role": "user", "content": u})
        if b:
            messages.append({"role": "assistant", "content": b})

    messages.append({"role": "user", "content": user_msg})
    return messages


def split_message(text, max_length=150):
    """Ğ Ğ°Ğ·Ğ´ĞµĞ»ÑĞµÑ‚ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµĞºÑÑ‚Ñ‹ Ğ¿Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ÑĞ¼ Ğ¸Ğ»Ğ¸ Ğ½Ğ¾Ğ²Ñ‹Ğ¼ ÑÑ‚Ñ€Ğ¾ĞºĞ°Ğ¼ Ğ´Ğ»Ñ WhatsApp."""
    parts = []
    text = text.strip()
    while len(text) > max_length:
        split_index = max(text[:max_length].rfind("\n"), text[:max_length].rfind(". "))
        if split_index == -1 or split_index < max_length * 0.5:
            split_index = max_length
        parts.append(text[:split_index].strip())
        text = text[split_index:].lstrip()
    if text:
        parts.append(text)
    return parts


def send_whatsapp_message(phone, message):
    """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² WhatsApp Ñ‡ĞµÑ€ĞµĞ· 360dialog API."""
    payload = {"messaging_product": "whatsapp", "to": phone, "type": "text", "text": {"body": message}}
    try:
        response = requests.post(WHATSAPP_API_URL, headers=HEADERS, json=payload, timeout=15)
        print(f"ğŸ“¤ ĞÑ‚Ğ²ĞµÑ‚ WhatsApp: {getattr(response, 'status_code', 'Ğ½ĞµÑ‚_Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°')}")
        return response
    except Exception as e:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° WhatsApp: {e}")
        return None


def get_gpt_response(user_msg, phone):
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ GPT, Ğ´ĞµĞ»Ğ¸Ñ‚ Ğ¿Ğ¾ [SPLIT] Ğ¸Ğ»Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ñ€Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚."""
    if not AUTO_REPLY_ENABLED:
        print(f"âš  AUTO_REPLY_ENABLED = False, Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ´Ğ»Ñ {phone} Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½")
        return None  # Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑÑ‚Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°

    state = get_client_state(phone)
    messages = build_messages_for_gpt(state, user_msg)
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=messages,
            temperature=0.75,
            top_p=0.9,
            frequency_penalty=0.4,
            presence_penalty=0.5,
            max_tokens=400
        )
        reply = response.choices[0].message.content.strip()
        return reply
    except Exception as e:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° GPT: {e}")
        return "ĞšĞµÑˆÑ–Ñ€Ñ–Ò£Ñ–Ğ·, Ò›Ğ°Ğ·Ñ–Ñ€ Ğ¶Ğ°ÑƒĞ°Ğ¿ Ğ±ĞµÑ€Ğµ Ğ°Ğ»Ğ¼Ğ°Ğ¹Ğ¼Ñ‹Ğ½."

    # Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾ [SPLIT] Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ Ğ´Ğ»Ğ¸Ğ½Ğµ
    if "[SPLIT]" in reply:
        parts = [p.strip() for p in reply.split("[SPLIT]") if p.strip()]
    else:
        parts = split_message(reply, max_length=150)

    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ²ÑĞµÑ… Ñ‡Ğ°ÑÑ‚ĞµĞ¹ Ğ² WhatsApp
    for part in parts:
        send_whatsapp_message(phone, part)

    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
    try:
        next_stage_int = min(6, max(0, int(state["stage"])) + 1)
    except Exception:
        next_stage_int = 0
    next_stage = str(next_stage_int)

    new_history = list(state["history"]) + [{"user": user_msg, "bot": reply}]
    save_client_state(
        phone,
        stage=next_stage,
        history=new_history,
        last_time=time.time(),
        followed_up=False
    )

    return reply


# ==============================
# ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Flask
# ==============================
@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.get_json(silent=True) or {}
    print("ğŸ“© Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ JSON:", data)

    try:
        entry = (data.get("entry") or [{}])[0]
        changes = (entry.get("changes") or [{}])[0]
        value = changes.get("value") or {}
        messages = value.get("messages")
        contacts = value.get("contacts", [])

        if not messages:
            print("INFO: ĞĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ğ¾Ğ¹ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ²ĞµĞ±Ñ…ÑƒĞºĞ°.")
            return jsonify({"status": "no_message"}), 200

        msg = messages[0]
        msg_id = msg["id"]

        if msg_id in PROCESSED_MESSAGES:
            print(f"â© Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ {msg_id} ÑƒĞ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼")
            return jsonify({"status": "duplicate"}), 200
        PROCESSED_MESSAGES.add(msg_id)

        user_phone = normalize_phone_number(msg.get("from"))
        user_msg = (msg.get("text") or {}).get("body", "").strip()
        msg_type = msg.get("type")

        print(f"DEBUG: ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ {user_phone}, Ñ‚Ğ¸Ğ¿: {msg_type}, Ñ‚ĞµĞºÑÑ‚: '{user_msg}'")

        if not user_phone:
            print(f"INFO: Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ±ĞµĞ· Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° â€” Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼")
            return jsonify({"status": "ignored"}), 200

        # --- ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ ---
        name = "ĞšĞ»Ğ¸ĞµĞ½Ñ‚"
        if contacts and isinstance(contacts, list):
            profile = (contacts[0] or {}).get("profile") or {}
            name = profile.get("name", "ĞšĞ»Ğ¸ĞµĞ½Ñ‚")

        # âœ… ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ projectId Ğ¿Ğ¾ Ñ‚ĞµĞºÑÑ‚Ñƒ
        if "ÑĞ°Ğ»ĞµĞ¼" in user_msg.lower():
            project_id = 1
        elif "Ğ·Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ" in user_msg.lower():
            project_id = 2
        else:
            project_id = 1  # Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
        
        should_send_bot_reply = False

        # --- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞ¹ Ğ‘Ğ” ---
        client_in_bot_db = client_in_db_or_cache(user_phone)

        if client_in_bot_db:
            print(f"DEBUG: ĞšĞ»Ğ¸ĞµĞ½Ñ‚ {user_phone} Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ‘Ğ” Ğ±Ğ¾Ñ‚Ğ°. ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³.")
            should_send_bot_reply = True
        else:
            crm_already_exists = client_exists(user_phone)
            if crm_already_exists:
                print(f"DEBUG: ĞšĞ»Ğ¸ĞµĞ½Ñ‚ {user_phone} Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² CRM, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² Ğ‘Ğ” Ğ±Ğ¾Ñ‚Ğ°.")
                save_client_state(user_phone, name=name, in_crm=True)
                should_send_bot_reply = True
            else:
                print(f"DEBUG: ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ {user_phone}, Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² CRM.")
                # âœ… ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ project_id
                process_new_lead(name, user_phone, project_id)
                should_send_bot_reply = False

        # --- ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ñ… ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² ---
        if should_send_bot_reply and msg_type == "text" and user_msg:
            reply = get_gpt_response(user_msg, user_phone)
            for part in split_message(reply):
                send_whatsapp_message(user_phone, part)
        else:
            print(f"DEBUG: ĞÑ‚Ğ²ĞµÑ‚ Ğ±Ğ¾Ñ‚Ğ° Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ. CRM Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ´Ğ»Ñ {user_phone}")

        return jsonify({"status": "ok"}), 200

    except Exception as e:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²ĞµĞ±Ñ…ÑƒĞºĞ°: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({"status": "error", "message": str(e)}), 500


@app.route('/salesrender-hook', methods=['POST'])
def salesrender_hook():
    print("=== Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° /salesrender-hook ===")
    try:
        data = request.get_json(silent=True) or {}
        print("ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ğ°Ñ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°:", json.dumps(data, indent=2, ensure_ascii=False))

        orders = (
            data.get("data", {}).get("orders")
            or data.get("orders")
            or [data] # Ğ—Ğ°Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚, ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¾Ğ´Ğ¸Ğ½ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
        )

        if not orders or not isinstance(orders, list):
            return jsonify({"error": "Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚"}), 400

        # ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°ĞºĞ°Ğ· (Ğ¸Ğ»Ğ¸ Ñ†Ğ¸ĞºĞ»Ğ¸Ñ‡ĞµÑĞºĞ¸, ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²) Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞµ
        threading.Thread(
            target=process_salesrender_order,
            args=(orders[0],),
            daemon=True
        ).start()

        return jsonify({"status": "accepted"}), 200
    except Exception as e:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° Ğ²ĞµĞ±Ñ…ÑƒĞºĞ°: {e}")
        return jsonify({"error": str(e)}), 500


@app.route('/', methods=['GET'])
def home():
    return "Healvix Ğ±Ğ¾Ñ‚ Ñ–ÑĞºĞµ Ò›Ğ¾ÑÑ‹Ğ»Ğ´Ñ‹!", 200

# ==============================
# Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ - ĞŸĞµÑ€ĞµĞ½ĞµÑĞµĞ½ Ğ·Ğ° Ğ¿Ñ€ĞµĞ´ĞµĞ»Ñ‹ if __name__ == "__main__" Ğ´Ğ»Ñ Gunicorn
# ==============================

print("DEBUG: Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (Ğ²Ğ½Ğµ if __name__).")
init_db() # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
print("DEBUG: init_db() Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ (Ğ²Ğ½Ğµ if __name__).")
load_cache_from_db() # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ²ÑĞµÑ… ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² ĞºÑÑˆ
print("DEBUG: ĞšÑÑˆ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¸Ğ· Ğ‘Ğ” (Ğ²Ğ½Ğµ if __name__).")

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ„Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¸ Ğ´Ğ»Ñ follow-up Ğ¸ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸
threading.Thread(target=follow_up_checker, args=(send_whatsapp_message,), daemon=True).start()
print("DEBUG: ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ follow-up Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½.")
threading.Thread(target=cleanup_old_clients, daemon=True).start()
print("DEBUG: ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½.")

if __name__ == "__main__":
    print("DEBUG: ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· 'python app.py'.")
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
