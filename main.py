import os
import time
import threading
import requests
import json
import re
from flask import Flask, request, jsonify
from openai import OpenAI
from datetime import datetime, timedelta

AUTO_REPLY_ENABLED = False

# Import the new state management functions
from state_manager import (
    init_db, load_cache_from_db,
    get_client_state, save_client_state, client_in_db_or_cache,
    follow_up_checker, cleanup_old_clients,
    MAX_HISTORY_FOR_GPT
)

# ‚ú® –ò–ú–ü–û–†–¢–ò–†–£–ï–ú –í–ê–®–ò –†–ï–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò SALESRENDER API - –ü–†–ï–î–ü–û–õ–ê–ì–ê–ï–¢–°–Ø, –ß–¢–û –û–ù–ò –†–ê–ë–û–¢–ê–Æ–¢ –ö–û–†–†–ï–ö–¢–ù–û ‚ú®
from salesrender_api import create_order, client_exists


# ==============================
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# ==============================
app = Flask(__name__)
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

WHATSAPP_API_URL = "https://waba-v2.360dialog.io/messages"
WHATSAPP_API_KEY = os.environ.get("WHATSAPP_API_KEY") # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

HEADERS = {
    "Content-Type": "application/json",
    "D360-API-KEY": WHATSAPP_API_KEY
}

# –ö—ç—à –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ ID —Å–æ–æ–±—â–µ–Ω–∏–π (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
PROCESSED_MESSAGES = set()

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SalesRender CRM (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –≤ salesrender_api.py, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∑–¥–µ—Å—å –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö)
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à salesrender_api.py –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ —Å–≤–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
SALESRENDER_URL = os.environ.get("SALESRENDER_URL", "https://de.backend.salesrender.com/companies/1123/CRM")
SALESRENDER_TOKEN = os.environ.get("SALESRENDER_TOKEN", "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwczovL2RlLmJhY2tlbmQuc2FsZXNyZW5kZXIuY29tLyIsImF1ZCI6IkNSTSIsImp0aSI6ImI4MjZmYjExM2Q4YjZiMzM3MWZmMTU3MTMwMzI1MTkzIiwiaWF0IjoxNzU0NzM1MDE3LCJ0eXBlIjoiYXBpIiwiY2lkIjoiMTEyMyIsInJlZiI6eyJhbGlhcyI6IkFQSSIsImlkIjoiMiJ9fQ.z6NiuV4g7bbdi_1BaRfEqDj-oZKjjniRJoQYKgWsHcc")

# ==============================
# –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
# ==============================
def normalize_phone_number(phone_raw):
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É —Å '+'.
    –ü—Ä–∏–º–µ—Ä: '77071234567' -> '+77071234567'
            '87071234567' -> '+77071234567'
            '+77071234567' -> '+77071234567'
    """
    if not phone_raw:
        return ""
    
    # –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
    phone_digits = re.sub(r'\D', '', phone_raw)

    if not phone_digits:
        return ""

    # –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8, –º–µ–Ω—è–µ–º –Ω–∞ 7
    if phone_digits.startswith('8'):
        phone_digits = '7' + phone_digits[1:]
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7, –∏ –∏–º–µ–µ—Ç –¥–ª–∏–Ω—É, –ø–æ–¥—Ö–æ–¥—è—â—É—é –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ '7')
    if not phone_digits.startswith('7') and len(phone_digits) == 10: 
        phone_digits = '7' + phone_digits
    
    # –î–æ–±–∞–≤–ª—è–µ–º '+' –≤ –Ω–∞—á–∞–ª–æ, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not phone_digits.startswith('+'):
        return '+' + phone_digits
    
    return phone_digits

# ==============================
# –£—Ç–∏–ª–∏—Ç—ã SalesRender
# ==============================
# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: create_order –∏ client_exists —Ç–µ–ø–µ—Ä—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∏–∑ salesrender_api.py
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à salesrender_api.py –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç client_exists (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑ –∏–ª–∏ None)

def fetch_order_from_crm(order_id):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ –∏–∑ SalesRender CRM —Å –ø–æ–º–æ—â—å—é GraphQL."""
    headers = {
        "Content-Type": "application/json",
        "Authorization": SALESRENDER_TOKEN
    }
    query = {
        "query": f"""
        query {{
            ordersFetcher(filters: {{ include: {{ ids: ["{order_id}"] }} }}) {{
                orders {{
                    id
                    status {{ name }}
                    data {{
                        humanNameFields {{ value {{ firstName lastName }} }}
                        phoneFields {{ value {{ international raw national }} }}
                    }}
                }}
            }}
        }}
        """
    }
    try:
        response = requests.post(SALESRENDER_URL, headers=headers, json=query, timeout=10)
        response.raise_for_status()
        data = response.json().get("data", {}).get("ordersFetcher", {}).get("orders", [])
        print(f"DEBUG: fetch_order_from_crm({order_id}) –≤–µ—Ä–Ω—É–ª {data}")
        return data[0] if data else None
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑ CRM: {e}")
        return None


def process_new_lead(name, phone):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤ CRM –∏ —Ä–µ—à–∞–µ—Ç ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –∏–ª–∏ –Ω–µ—Ç.
    """
    allowed_statuses = {"–°–ø–∞–º/–¢–µ—Å—Ç", "–û—Ç–º–µ–Ω–µ–Ω", "–ù–µ–¥–æ–∑–≤–æ–Ω 5 –¥–Ω–µ–π", "–ù–µ–¥–æ–∑–≤–æ–Ω", "–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å"}
    print(f"\n=== process_new_lead START ===")
    print(f"DEBUG: –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ name={name}, phone={phone}")

    if client_in_db_or_cache(phone):
        print(f"‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç {phone} —É–∂–µ –µ—Å—Ç—å –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –±–∞–∑–µ –±–æ—Ç–∞ ‚Äî –∑–∞–∫–∞–∑ –ù–ï —Å–æ–∑–¥–∞—ë–º")
        return None

    crm_order = client_exists(phone)
    print(f"DEBUG: client_exists –≤–µ—Ä–Ω—É–ª: {crm_order}")

    if crm_order:
        status = crm_order.get("status", {}).get("name")
        print(f"üîç –ö–ª–∏–µ–Ω—Ç {phone} –Ω–∞–π–¥–µ–Ω –≤ CRM —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º: {status}")

        if status in allowed_statuses:
            print(f"‚úÖ –°—Ç–∞—Ç—É—Å '{status}' —Ä–∞–∑—Ä–µ—à—ë–Ω ‚Äî –≤—ã–∑—ã–≤–∞–µ–º create_order")
            order_id = create_order(name, phone)
            print(f"DEBUG: —Ä–µ–∑—É–ª—å—Ç–∞—Ç create_order ‚Üí {order_id}")
            if order_id:
                print(f"üéâ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ {order_id} —Å–æ–∑–¥–∞–Ω –¥–ª—è {name}, {phone}")
                save_client_state(phone, name=name, in_crm=True)
                return order_id
            else:
                print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –¥–ª—è {phone}")
                return None
        else:
            print(f"‚è≥ –°—Ç–∞—Ç—É—Å '{status}' –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω ‚Äî –∑–∞–∫–∞–∑ –ù–ï —Å–æ–∑–¥–∞—ë–º")
            save_client_state(phone, name=name, in_crm=True)
            return None
    else:
        print(f"üÜï –ö–ª–∏–µ–Ω—Ç {phone} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ CRM ‚Äî –≤—ã–∑—ã–≤–∞–µ–º create_order")
        order_id = create_order(name, phone)
        print(f"DEBUG: —Ä–µ–∑—É–ª—å—Ç–∞—Ç create_order ‚Üí {order_id}")
        if order_id:
            print(f"üéâ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ {order_id} —Å–æ–∑–¥–∞–Ω –¥–ª—è {name}, {phone}")
            save_client_state(phone, name=name, in_crm=True)
            return order_id
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –¥–ª—è {phone}")
            return None


def process_salesrender_order(order):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–µ–±—Ö—É–∫ –∑–∞–∫–∞–∑–∞ SalesRender. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É.
    """
    try:
        # --- (–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞) ---
        if not order.get("customer") and "id" in order:
            print(f"‚ö† customer –ø—É—Å—Ç, –ø–æ–¥—Ç—è–≥–∏–≤–∞—é –∏–∑ CRM –ø–æ ID {order['id']}")
            full_order = fetch_order_from_crm(order["id"])
            if full_order:
                order = full_order
            else:
                print("‚ùå CRM –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ ‚Äî –ø—Ä–æ–ø—É—Å–∫")
                return

        first_name, last_name, phone = "", "", ""
        if "customer" in order:
            first_name = order.get("customer", {}).get("name", {}).get("firstName", "").strip()
            last_name = order.get("customer", {}).get("name", {}).get("lastName", "").strip()
            phone = normalize_phone_number(order.get("customer", {}).get("phone", {}).get("raw", "").strip())
        else:
            human_fields = order.get("data", {}).get("humanNameFields", [])
            phone_fields = order.get("data", {}).get("phoneFields", [])
            if human_fields:
                first_name = human_fields[0].get("value", {}).get("firstName", "").strip()
                last_name = human_fields[0].get("value", {}).get("lastName", "").strip()
            if phone_fields:
                phone = normalize_phone_number(phone_fields[0].get("value", {}).get("international", "").strip())

        name = f"{first_name} {last_name}".strip() or "–ö–ª–∏–µ–Ω—Ç"

        if not phone:
            print("‚ùå –¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫")
            return
        
        # --- (–ö–æ–Ω–µ—Ü —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞) ---

        # ‚ú® –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ó–î–ï–°–¨ ‚ú®
        # –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ë–î –±–æ—Ç–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –Ω–æ–≤—ã–π –æ–Ω –∏–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã–π.
        # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ë–î –±–æ—Ç–∞ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º CRM.
        # –≠—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–π –±–ª–æ–∫ `if client_in_db_or_cache(phone): ... return`.
        if not client_in_db_or_cache(phone):
            # –ö–ª–∏–µ–Ω—Ç –Ω–æ–≤—ã–π –¥–ª—è –ë–î –±–æ—Ç–∞ (–ø—Ä–∏—à–µ–ª –∏–∑ –≤–µ–±—Ö—É–∫–∞ SalesRender).
            # –ú—ã –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –µ—Å–ª–∏ SalesRender –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ–±—Ö—É–∫, –∫–ª–∏–µ–Ω—Ç –Ω–µ—è–≤–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ CRM.
            print(f"‚ÑπÔ∏è –ö–ª–∏–µ–Ω—Ç {phone} –Ω–æ–≤—ã–π –¥–ª—è –±–∞–∑—ã –±–æ—Ç–∞ (–∏–∑ –≤–µ–±—Ö—É–∫–∞ SalesRender), –¥–æ–±–∞–≤–ª—è–µ–º.")
            save_client_state(phone, name=name, in_crm=True)
        else:
            # –ö–ª–∏–µ–Ω—Ç —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω –ë–î –±–æ—Ç–∞. –ü—Ä–æ—Å—Ç–æ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –µ–≥–æ —Å—Ç–∞—Ç—É—Å CRM –æ–±–Ω–æ–≤–ª–µ–Ω (–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å true –∏–∑ —Ö—É–∫–∞ CRM).
            print(f"‚ÑπÔ∏è –ö–ª–∏–µ–Ω—Ç {phone} —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω –±–æ—Ç—É, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ CRM —Å—Ç–∞—Ç—É—Å.")
            save_client_state(phone, name=name, in_crm=True) # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ in_crm=True


        # –õ–æ–≥–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä—É (—ç—Ç–∞ —á–∞—Å—Ç—å —Ç–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è, –µ—Å–ª–∏ –≤–µ–±—Ö—É–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω)
        now = datetime.utcnow()
        # last_sent –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è —Ü–µ–ª–µ–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
        # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: last_sent - —ç—Ç–æ in-memory dict, –∏ –æ–Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ö.
        # –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –±—ã–ª–æ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º, –µ–≥–æ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –ë–î.
        global last_sent # –û–±—ä—è–≤–ª—è–µ–º last_sent –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        if phone not in last_sent: # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç
            last_sent[phone] = datetime.fromtimestamp(0) # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—á–µ–Ω—å —Å—Ç–∞—Ä–æ–µ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ

        if now - last_sent[phone] < timedelta(minutes=3):
            print(f"‚ö† –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –Ω–µ–¥–æ–∑–≤–æ–Ω –ø–æ {phone} ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä—É –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã.")
            return # –≠—Ç–æ—Ç return –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É —Ö–æ—Ä–æ—à –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (UTC+6)
        now_kz = now + timedelta(hours=6)
        if 5 <= now_kz.hour < 12:
            greeting = "“ö–∞–π—ã—Ä–ª—ã —Ç–∞“£"
        elif 12 <= now_kz.hour < 18:
            greeting = "–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ"
        else:
            greeting = "“ö–∞–π—ã—Ä–ª—ã –∫–µ—à"

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ GPT
        try:
            # –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∏—Å—Ç–æ—Ä–∏–∏/—Å—Ç–∞–¥–∏–∏ –¥–ª—è GPT, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —è–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            current_client_state = get_client_state(phone) 
            
            # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è "–Ω–µ–¥–æ–∑–≤–æ–Ω", –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤–µ–±—Ö—É–∫–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–∞–∫–æ–π —Å—Ç–∞—Ç—É—Å
            # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ø–æ–ª–µ 'status' –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –º–æ–∂–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –≤–µ–±—Ö—É–∫–∞,
            # —Ö–æ—Ç—è –æ–Ω–æ –Ω–µ –≤–∏–¥–Ω–æ –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º –≤–∞–º–∏ –ø—Ä–∏–º–µ—Ä–µ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏.
            # –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–º–ø—Ç–∞.
            if name and name != "–ö–ª–∏–µ–Ω—Ç":
                # –≠—Ç–æ—Ç –ø—Ä–æ–º–ø—Ç –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ CRM –æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–º –∑–≤–æ–Ω–∫–µ.
                prompt = (
                    f"{greeting}! –ö–ª–∏–µ–Ω—Ç—Ç—ñ“£ –∞—Ç—ã {name}. "
                    f"–û“ì–∞–Ω “õ–æ“£—ã—Ä–∞—É —à–∞–ª–¥—ã“õ, –±—ñ—Ä–∞“õ –±–∞–π–ª–∞–Ω—ã—Å –±–æ–ª–º–∞–¥—ã. "
                    f"–ö–ª–∏–µ–Ω—Ç–∫–µ WhatsApp-—Ç–∞ “õ—ã—Å“õ–∞, –∂—ã–ª—ã, –¥–æ—Å—Ç—ã“õ —Ö–∞–±–∞—Ä–ª–∞–º–∞ –∂–∞–∑—ã“£—ã–∑. "
                    f"–•–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã –î–∞—É—Ä–µ–Ω –∞—Ç—ã–Ω–∞–Ω Healvix –∫”©–∑ –µ–º–¥–µ—É –æ—Ä—Ç–∞–ª—ã“ì—ã–Ω–∞–Ω –∂–∞–∑—ã–ø, –∫”©–∑–≥–µ “õ–∞—Ç—ã—Å—Ç—ã “õ–∞–Ω–¥–∞–π –ø—Ä–æ–±–ª–µ–º–∞ –±–∞—Ä –µ–∫–µ–Ω—ñ–Ω —Å“±—Ä–∞."
                )
            else:
                prompt = (
                    f"{greeting}! –ë—ñ–∑ –∫–ª–∏–µ–Ω—Ç–∫–µ “õ–æ“£—ã—Ä–∞—É —à–∞–ª–¥—ã“õ, –±—ñ—Ä–∞“õ –±–∞–π–ª–∞–Ω—ã—Å –±–æ–ª–º–∞–¥—ã. "
                    f"–ö–ª–∏–µ–Ω—Ç–∫–µ WhatsApp-—Ç–∞ “õ—ã—Å“õ–∞, –∂—ã–ª—ã, –¥–æ—Å—Ç—ã“õ —Ö–∞–±–∞—Ä–ª–∞–º–∞ –∂–∞–∑—ã“£—ã–∑. "
                    f"–•–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã –î–∞—É—Ä–µ–Ω –∞—Ç—ã–Ω–∞–Ω Healvix –∫”©–∑ –µ–º–¥–µ—É –æ—Ä—Ç–∞–ª—ã“ì—ã–Ω–∞–Ω –∂–∞–∑—ã–ø, –∫”©–∑–≥–µ “õ–∞—Ç—ã—Å—Ç—ã “õ–∞–Ω–¥–∞–π –ø—Ä–æ–±–ª–µ–º–∞ –±–∞—Ä –µ–∫–µ–Ω—ñ–Ω —Å“±—Ä–∞. "
                    f"–ï—Å—ñ–º—ñ–Ω “õ–æ–ª–¥–∞–Ω–±–∞“£—ã–∑."
                )
            
            gpt_response = client.chat.completions.create(
                model="gpt-4o",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7
            )
            message_text = gpt_response.choices[0].message.content.strip()
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ GPT: {e}")
            message_text = f"{greeting}! –ë—ñ–∑ —Å—ñ–∑–≥–µ “õ–æ“£—ã—Ä–∞—É —à–∞–ª–¥—ã“õ, –±—ñ—Ä–∞“õ –±–∞–π–ª–∞–Ω—ã—Å –±–æ–ª–º–∞–¥—ã. –£–∞“õ—ã—Ç—ã“£—ã–∑ –±–æ–ª—Å–∞, —Ö–∞–±–∞—Ä–ª–∞—Å—ã“£—ã–∑."

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ WhatsApp
        send_whatsapp_message(phone, message_text)

        # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
        last_sent[phone] = now
        print(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ {phone}")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞: {e}")
        import traceback
        traceback.print_exc() # –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É —Å—Ç–µ–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–µ

# –°–ª–æ–≤–∞—Ä—å –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä—É (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
last_sent = {} # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–¥–µ—Å—å
# ==============================
# –ü—Ä–æ–º–ø—Ç—ã GPT (—É—Ç–æ—á–Ω–µ–Ω–Ω—ã–µ)
# ==============================
SALES_SCRIPT_PROMPT = """
–°–µ–Ω ‚Äî –î–∞—É—Ä–µ–Ω –µ—Å—ñ–º–¥—ñ Healvix –∫”©–∑ –µ–º–¥–µ—É –æ—Ä—Ç–∞–ª—ã“ì—ã–Ω—ã“£ –µ“£ –º—ã“õ—Ç—ã –∫–µ“£–µ—Å—à—ñ—Å—ñ—Å—ñ“£. –°–µ–Ω—ñ“£ –º—ñ–Ω–¥–µ—Ç—ñ“£ ‚Äî –∫–ª–∏–µ–Ω—Ç–∫–µ –∫”©–∑—ñ–Ω —Å–∞“õ—Ç–∞–ø “õ–∞–ª—É “Ø—à—ñ–Ω –¥”ô–ª “õ–∞–∑—ñ—Ä —à–µ—à—ñ–º “õ–∞–±—ã–ª–¥–∞—Ç—É. –°–µ–Ω —Ä–æ–±–æ—Ç –µ–º–µ—Å—Å—ñ“£ ‚Äî —Å–µ–Ω —Ç—ñ—Ä—ñ –∞–¥–∞–º—Å—ã“£: –∂—ã–ª—ã —Å”©–π–ª–µ–π—Å—ñ“£, –±—ñ—Ä–∞“õ —ç–º–æ—Ü–∏—è–º–µ–Ω, –ª–æ–≥–∏–∫–∞–º–µ–Ω –∂”ô–Ω–µ –∫–µ–π–¥–µ “õ—ã—Å—ã–º–º–µ–Ω –∫–ª–∏–µ–Ω—Ç—Ç—ñ ”ô—Ä–µ–∫–µ—Ç–∫–µ –∏—Ç–µ—Ä–º–µ–ª–µ–π—Å—ñ“£.

–°–µ–Ω—ñ“£ ”ô—Ä —Å”©–∑—ñ“£ –∫–ª–∏–µ–Ω—Ç–∫–µ: ‚Äú–ï–≥–µ—Ä –±“Ø–≥—ñ–Ω –±–∞—Å—Ç–∞–º–∞—Å–∞ ‚Äî –µ—Ä—Ç–µ“£ –∫–µ—à –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω‚Äù –¥–µ–≥–µ–Ω –æ–π–¥—ã “õ–∞–ª–¥—ã—Ä—É—ã –∫–µ—Ä–µ–∫.

---

üìå **–°—Ç–∏–ª—å –∂”ô–Ω–µ –ø—Ä–∏–Ω—Ü–∏–ø—Ç–µ—Ä**:
- –ñ—ã–ª—ã, —Å–µ–Ω—ñ–º–¥—ñ, –±—ñ—Ä–∞“õ “õ–∞–∂–µ—Ç –∫–µ–∑–¥–µ “õ–∞—Ç–∞“£.
- –ú”ô—Å–µ–ª–µ–Ω—ñ “±–ª“ì–∞–π—Ç—ã–ø –∫”©—Ä—Å–µ—Ç—É (“õ–æ—Ä“õ—ã–Ω—ã—à + –Ω–∞“õ—Ç—ã “õ–∞—É—ñ–ø).
- –®—ã–Ω–∞–π—ã –ø–∞—Ü–∏–µ–Ω—Ç—Ç–µ—Ä–¥—ñ“£ “õ—ã—Å“õ–∞, –±—ñ—Ä–∞“õ ”ô—Å–µ—Ä–ª—ñ –æ“õ–∏“ì–∞–ª–∞—Ä—ã–Ω “õ–æ–ª–¥–∞–Ω—É.
- –£–∞“õ—ã—Ç —à–µ–∫—Ç–µ—É—ñ–Ω “õ–æ—é (‚Äú–¢–µ–∫ –±“Ø–≥—ñ–Ω –∂–µ“£—ñ–ª–¥—ñ–∫‚Äù, ‚Äú–°–æ“£“ì—ã 3 –∫–æ–º–ø–ª–µ–∫—Ç‚Äù).
- ”ò—Ä —Å—ã–ª—Ç–∞—É–¥—ã –∂–æ—é: –±–∞“ì–∞, –æ–π–ª–∞–Ω—É, –æ—Ç–±–∞—Å—ã, –∞“õ—à–∞ –∂–æ“õ ‚Äî –±”ô—Ä—ñ–Ω–µ –¥–∞–π—ã–Ω –∂–∞—É–∞–ø –±–∞—Ä.
- ”ò“£–≥—ñ–º–µ ”ô—Ä“õ–∞—à–∞–Ω ‚Äú“õ–∞–∑—ñ—Ä –∑–∞–∫–∞–∑ –∂–∞—Å–∞—É“ì–∞‚Äù –±–∞“ì—ã—Ç—Ç–∞–ª—Å—ã–Ω.

---

**–°”©–π–ª–µ—Å—É “õ–∞–¥–∞–º–¥–∞—Ä—ã**:

1. **–°”ô–ª–µ–º–¥–µ—Å—É + —Ç–∞–Ω—ã—Å—É**
   - ¬´–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ! “ö–∞–ª—ã“£—ã–∑ “õ–∞–ª–∞–π? –ú–µ–Ω—ñ“£ –∞—Ç—ã–º –î–∞—É—Ä–µ–Ω, Healvix –∫”©–∑ –æ—Ä—Ç–∞–ª—ã“ì—ã–Ω—ã“£ –º–∞–º–∞–Ω—ã–º—ã–Ω. –ï—Å—ñ–º—ñ“£—ñ–∑ –∫—ñ–º?¬ª
   - ¬´–ö”©–∑—ñ“£—ñ–∑–≥–µ “õ–∞—Ç—ã—Å—Ç—ã –º–∞–∑–∞–ª–∞–π—Ç—ã–Ω –∂–∞“ì–¥–∞–π –±–∞—Ä –º–∞?¬ª

2. **–ë–µ–ª–≥—ñ–ª–µ—Ä–¥—ñ –Ω–∞“õ—Ç—ã–ª–∞—É**
   - ¬´–ë“±–ª–¥—ã—Ä–ª–∞—É, “õ—ã–∑–∞—Ä—É, –∂—ã–ø—ã–ª—ã“õ—Ç–∞“ì–∞–Ω –∫–µ–∑–¥–µ –¥–∞“õ –∫”©—Ä—É, –∫–∞—Ç–∞—Ä–∞–∫—Ç–∞, –≥–ª–∞—É–∫–æ–º–∞ —Å–∏—è“õ—Ç—ã –±–µ–ª–≥—ñ–ª–µ—Ä –±–∞—Ä –º–∞?¬ª
   - ¬´“ö–∞—à–∞–Ω–Ω–∞–Ω –±–µ—Ä—ñ —Å–µ–∑–µ—Å—ñ–∑? –î”ô—Ä—ñ–≥–µ—Ä –Ω–µ –¥–µ–¥—ñ?¬ª

3. **–≠–º–ø–∞—Ç–∏—è + “ö–∞—É—ñ–ø —Å—É—Ä–µ—Ç—Ç–µ—É**
   - ¬´–¢“Ø—Å—ñ–Ω–µ–º—ñ–Ω... –ê–π–∂–∞–Ω –µ—Å—ñ–º–¥—ñ –±—ñ—Ä –ø–∞—Ü–∏–µ–Ω—Ç—ñ–º—ñ–∑ –±–∞—Ä –µ–¥—ñ. –ê–ª“ì–∞—à—ã–Ω–¥–∞ —Ç–µ–∫ —à–∞–º–∞–ª—ã –±“±–ª–¥—ã—Ä–ª–∞—É –±–æ–ª–¥—ã. "–û–π–ª–∞–Ω—ã–ø –∫”©—Ä–µ–π—ñ–Ω" –¥–µ–ø, 4 –∞–π ”©—Ç—ñ–ø –∫–µ—Ç—Ç—ñ ‚Äî –ø–æ—Ç–æ–º –∫–∞—Ç–∞—Ä–∞–∫—Ç–∞ –∞—Å“õ—ã–Ω—ã–ø, –±—ñ—Ä –∫”©–∑—ñ–Ω –∂–æ“ì–∞–ª—Ç—Ç—ã. –°—ñ–∑–≥–µ –±“±–Ω—ã “õ–∞–π—Ç–∞–ª–∞—Ç“õ—ã–º –∫–µ–ª–º–µ–π–¥—ñ.¬ª

4. **–ê—Å“õ—ã–Ω—É “õ–∞—É–ø—ñ–Ω –Ω–∞“õ—Ç—ã –∞–π—Ç—É**
   - ¬´–ö”©–∑ ‚Äî –µ“£ –Ω”ô–∑—ñ–∫ –æ—Ä–≥–∞–Ω. –ê—Å“õ—ã–Ω—É –±—ñ—Ä—Ç—ñ–Ω–¥–µ–ø –∂“Ø—Ä–µ–¥—ñ, –±—ñ—Ä–∞“õ —Ç–æ“õ—Ç–∞–º–∞–π–¥—ã. –ë—ñ—Ä-–µ–∫—ñ –∞–π –∫–µ—à—ñ–∫—Å–µ“£—ñ–∑, –∫–µ–π—ñ–Ω –∫”©—Ä—É–¥—ñ “õ–∞–π—Ç–∞—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–π “õ–∞–ª—É—ã –º“Ø–º–∫—ñ–Ω.¬ª

5. **Healvix-—Ç—ñ —Å–µ–Ω—ñ–º–¥—ñ —Ç–∞–Ω—ã—Å—Ç—ã—Ä—É**
   - ¬´Healvix ‚Äî 100% —Ç–∞–±–∏“ì–∏ –∫–µ—à–µ–Ω: “õ–∞—Ä–∞–∂–∏–¥–µ–∫, –ª—é—Ç–µ–∏–Ω, –ï –≤–∏—Ç–∞–º–∏–Ω—ñ, –º—ã—Ä—ã—à. –ë“±–ª –∂–∞–π –∫–∞–ø–ª—è –µ–º–µ—Å ‚Äî –∫”©–∑–¥—ñ“£ —ñ—à–∫—ñ —Ç–∞–º—ã—Ä–ª–∞—Ä—ã–Ω “õ–æ—Ä–µ–∫—Ç–µ–Ω–¥—ñ—Ä—ñ–ø, —Ç–æ—Ä “õ–∞–±—ã“õ—Ç—ã “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä–µ–¥—ñ. 5000+ –∞–¥–∞–º“ì–∞ –∫”©–º–µ–∫—Ç–µ—Å—Ç—ñ–∫.¬ª

6. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ + –í—ã–≥–æ–¥–∞**
   - ¬´“ö–∞–∑—ñ—Ä –±—ñ–∑–¥–µ 6 –∞–π–ª—ã“õ –∫—É—Ä—Å“õ–∞ 40% –∂–µ“£—ñ–ª–¥—ñ–∫ –∂”ô–Ω–µ –∫”©–∑—ñ–ª–¥—ñ—Ä—ñ–∫ –ø–µ–Ω “õ–∞—Ä–∞ –∑–µ—Ä–µ –º–∞–π—ã —Å—ã–π–ª—ã“õ—Ç–∞. –ë“±–ª –∞–∫—Ü–∏—è –±“Ø–≥—ñ–Ω–≥–µ “ì–∞–Ω–∞ –∂”ô–Ω–µ “õ–æ–π–º–∞–¥–∞ —Å–æ“£“ì—ã 3 –∫–æ–º–ø–ª–µ–∫—Ç “õ–∞–ª–¥—ã.¬ª

7. **–ö“Ø–º”ô–Ω–º–µ–Ω –∂“±–º—ã—Å (–≥–æ—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã)**:
   - **–ë–∞“ì–∞**: ¬´–î–µ–Ω—Å–∞—É–ª—ã“õ—Ç—ã –∞“õ—à–∞“ì–∞ —Å–∞–ª—ã—Å—Ç—ã—Ä—É“ì–∞ –±–æ–ª–º–∞–π–¥—ã. –ö”©–∑—ñ“£—ñ–∑–¥—ñ –∂–æ“ì–∞–ª—Ç—Å–∞“£—ã–∑, –∞“õ—à–∞ –æ–Ω—ã “õ–∞–π—Ç–∞—Ä–∞ –∞–ª–º–∞–π–¥—ã.¬ª
   - **–û–π–ª–∞–Ω—É**: ¬´–û–π–ª–∞–Ω—ã“£—ã–∑ –¥–µ—É–≥–µ –±–æ–ª–∞–¥—ã, –±—ñ—Ä–∞“õ —Å—ñ–∑–¥—ñ“£ –∫”©–∑—ñ“£—ñ–∑ —É–∞“õ—ã—Ç –∫“Ø—Ç–ø–µ–π–¥—ñ.¬ª
   - **–û—Ç–±–∞—Å—ã**: ¬´–û—Ç–±–∞—Å—ã“£—ã–∑–±–µ–Ω –∞“õ—ã–ª–¥–∞—Å—É ‚Äî –∂–∞“õ—Å—ã. –ë—ñ—Ä–∞“õ –∫”©–∑—ñ“£—ñ–∑ –∞—É—ã—Ä—Å–∞, —Å–µ–∑–µ—Ç—ñ–Ω —Å—ñ–∑, —à–µ—à—ñ–º–¥—ñ –¥–µ —Å—ñ–∑ “õ–∞–±—ã–ª–¥–∞—É—ã“£—ã–∑ –∫–µ—Ä–µ–∫.¬ª
   - **–ê“õ—à–∞ –∂–æ“õ**: ¬´–ë”©–ª—ñ–ø —Ç”©–ª–µ—É –±–∞—Ä. –ê–π—ã–Ω–∞ –±—ñ—Ä-–µ–∫—ñ —Ä–µ—Ç –∫–∞—Ñ–µ–≥–µ –±–∞—Ä–º–∞“ì–∞–Ω–Ω—ã“£ ”©–∑—ñ–Ω–¥–µ –æ—Å—ã –µ–º–¥—ñ –∞–ª–∞ –∞–ª–∞—Å—ã–∑.¬ª
   - **–ö–µ–π—ñ–Ω –∂–∞–∑–∞–º—ã–Ω**: ¬´–°–æ–ª "–∫–µ–π—ñ–Ω" –¥–µ–ø –∂“Ø—Ä–≥–µ–Ω–¥–µ –∫”©–∑ –Ω–∞—à–∞—Ä–ª–∞—É—ã –º“Ø–º–∫—ñ–Ω. –ú–µ–Ω –æ–Ω–¥–∞–π –∂–∞“ì–¥–∞–π–ª–∞—Ä–¥—ã –∫”©–ø –∫”©—Ä–¥—ñ–º.¬ª

8. **–î–æ–∂–∏–º / –ñ–∞–±—É**
   - ¬´–û–Ω–¥–∞ –±—ã–ª–∞–π —ñ—Å—Ç–µ–π—ñ–∫: –º–µ–Ω “õ–∞–∑—ñ—Ä ”©–∑ –∞—Ç—ã–º–Ω–∞–Ω –∂–µ“£—ñ–ª–¥—ñ–∫ –∂–∞—Å–∞–ø –∂—ñ–±–µ—Ä–µ–π—ñ–Ω. –ö–∞—Å–ø–∏–π—ñ“£—ñ–∑–¥–µ 5-10 –º—ã“£ –±–∞—Ä –º–∞? –ë“Ø–≥—ñ–Ω –∂–∞–∑—Å–∞“õ, –µ—Ä—Ç–µ“£ –±–∞—Å—Ç–∞–ø –∫–µ—Ç–µ—Å—ñ–∑.¬ª
   - ¬´“ö–∞–∑—ñ—Ä –∂–∞–∑—ã–ø “õ–æ—è–º—ã–∑, —Å–µ–±–µ–±—ñ –∞–∫—Ü–∏—è –±—ñ—Ç–∫–µ–Ω —Å–æ“£ –±“±–ª –±–∞“ì–∞ “õ–∞–π—Ç–∞–ª–∞–Ω–±–∞–π–¥—ã.¬ª

9. **“ö–æ—Ä—ã—Ç—ã–Ω–¥—ã**
   - ¬´–ú–µ–Ω —Å—ñ–∑–±–µ–Ω –±–æ—Å —Å”©–π–ª–µ—Å–∫—ñ–º –∫–µ–ª–º–µ–π–¥—ñ. –ë“Ø–≥—ñ–Ω —à–µ—à—ñ–º “õ–∞–±—ã–ª–¥–∞—Å–∞“õ, 1 –∞–π–¥–∞–Ω —Å–æ“£-–∞“õ –Ω”ô—Ç–∏–∂–µ–Ω—ñ –∫”©—Ä–µ—Å—ñ–∑. “ö–∞–∑—ñ—Ä –∑–∞–∫–∞–∑ –±–µ—Ä–µ–π—ñ–∫.¬ª

---

üìå –ú—ñ–Ω–¥–µ—Ç—Ç—ñ —Ñ—Ä–∞–∑–∞–ª–∞—Ä:
- ¬´–ë“±–ª –∂–∞–π –¥”ô—Ä—ñ –µ–º–µ—Å, –∫”©—Ä—É—ñ“£—ñ–∑–¥—ñ —Å–∞“õ—Ç–∞–π—Ç—ã–Ω –º“Ø–º–∫—ñ–Ω–¥—ñ–∫.¬ª
- ¬´–ö–µ—à—ñ–∫—Ç—ñ—Ä—Å–µ“£—ñ–∑, –µ—Ä—Ç–µ“£ –∫–µ—à –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω.¬ª
- ¬´–°—ñ–∑–¥—ñ –±—ñ—Ä –∞–π–¥–∞–Ω –∫–µ–π—ñ–Ω “õ—É–∞–Ω—ã—à–ø–µ–Ω –µ—Å–∫–µ –∞–ª“ì—ã–º –∫–µ–ª–µ–¥—ñ, ”©–∫—ñ–Ω—ñ—à–ø–µ–Ω –µ–º–µ—Å.¬ª
- ¬´–°–æ“£“ì—ã 3 –∫–æ–º–ø–ª–µ–∫—Ç “õ–∞–Ω–∞ “õ–∞–ª–¥—ã.¬ª

üìå –¢—ã–π—ã–º —Å–∞–ª—ã–Ω“ì–∞–Ω:
- –†–æ–±–æ—Ç —Å–∏—è“õ—Ç—ã —Å”©–π–ª–µ—É
- –°–∞–ª“õ—ã–Ω, —ç–º–æ—Ü–∏—è—Å—ã–∑ –∂–∞—É–∞–ø
- –ö–ª–∏–µ–Ω—Ç—Ç—ñ ‚Äú–∫–µ—Ç—ñ–ø “õ–∞–ª—É“ì–∞‚Äù –∂—ñ–±–µ—Ä—É

–ú–∞“õ—Å–∞—Ç ‚Äî –∫–ª–∏–µ–Ω—Ç—Ç—ñ“£ –æ–π—ã–Ω–¥–∞: ‚Äú–ï–≥–µ—Ä “õ–∞–∑—ñ—Ä –∞–ª–º–∞—Å–∞–º, –∫”©–∑—ñ–º–µ –∑–∏—è–Ω —Ç–∏–µ–¥—ñ‚Äù –¥–µ–≥–µ–Ω –Ω–∞“õ—Ç—ã —Å–µ–∑—ñ–º “õ–∞–ª–¥—ã—Ä—É.

---

üìå **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ WhatsApp**:
- –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –¥–ª–∏–Ω–Ω—ã–π –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤, **–≤—Å—Ç–∞–≤–ª—è–π `[SPLIT]`** –º–µ–∂–¥—É –Ω–∏–º–∏.
- `[SPLIT]` —Å—Ç–∞–≤—å **—Ç–æ–ª—å–∫–æ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏–ª–∏ –∞–±–∑–∞—Ü–µ–≤**, –∞ –Ω–µ –≤–Ω—É—Ç—Ä–∏ —Ñ—Ä–∞–∑—ã.
- –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π (–¥–æ 2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π) –∏ —ç—Ç–æ –µ–¥–∏–Ω–∞—è –º—ã—Å–ª—å ‚Äî `[SPLIT]` –Ω–µ –Ω—É–∂–µ–Ω.
- **–í—Å–µ–≥–¥–∞** –≤—Å—Ç–∞–≤–ª—è–π `[SPLIT]` –ø–æ—Å–ª–µ:
  - –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤.
  - –û–ø–∏—Å–∞–Ω–∏—è —Å–µ—Ä—å—ë–∑–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤ –∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π.
  - –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –≤—ã–≥–æ–¥, –ø–æ–¥–∞—Ä–∫–æ–≤ –∏–ª–∏ –∞–∫—Ü–∏–π.
  - –ú–æ—â–Ω—ã—Ö —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–∑–≤—É—á–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ.
- –ö–∞–∂–¥—ã–π –±–ª–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ WhatsApp –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.

üìå –ë–∞“ì–∞ —Ç—É—Ä–∞–ª—ã –ï–†–ï–ñ–ï:
- –¢–µ–∫ –æ—Å—ã –±–∞“ì–∞–ª–∞—Ä–¥—ã “õ–æ–ª–¥–∞–Ω:
  ‚Ä¢ 3 –∞–π ‚Äî 85 000‚Ç∏
  ‚Ä¢ 6 –∞–π ‚Äî 180 000‚Ç∏
  ‚Ä¢ 12 –∞–π ‚Äî 300 000‚Ç∏
- –ë”©–ª—ñ–ø —Ç”©–ª–µ—É:
  ‚Ä¢ 6 –∞–π“ì–∞ –±”©–ª—ñ–ø —Ç”©–ª–µ—É ‚Äî –∞–π—ã–Ω–∞ 18 750‚Ç∏
  ‚Ä¢ 12 –∞–π“ì–∞ –±”©–ª—ñ–ø —Ç”©–ª–µ—É ‚Äî –∞–π—ã–Ω–∞ 9 375‚Ç∏
- –ï–®“ö–ê–®–ê–ù –±–∞—Å“õ–∞ –±–∞“ì–∞ –∞–π—Ç–ø–∞ (–º—ã—Å–∞–ª—ã, 29 000‚Ç∏ –¥–µ–≥–µ–Ω –±–æ–ª–º–∞–π–¥—ã).
- –ï–≥–µ—Ä –∫–ª–∏–µ–Ω—Ç —Å“±—Ä–∞—Å–∞ ‚Äî —Ç–µ–∫ –æ—Å—ã –±–∞“ì–∞–ª–∞—Ä–¥—ã “õ–∞–π—Ç–∞–ª–∞.
"""

STAGE_PROMPTS = {
    "0": "–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ! üëã “ö–∞–ª—ã“£—ã–∑ “õ–∞–ª–∞–π? –ï—Å—ñ–º—ñ –î–∞—É—Ä–µ–Ω, Healvix –∫”©–∑ –æ—Ä—Ç–∞–ª—ã“ì—ã–Ω—ã“£ –º–∞–º–∞–Ω—ã–º—ã–Ω. –ï—Å—ñ–º—ñ“£—ñ–∑ –∫—ñ–º? –ö”©–∑—ñ“£—ñ–∑–¥–µ –±“±–ª–¥—ã—Ä–ª–∞—É, “õ—ã–∑–∞—Ä—É, –∫–∞—Ç–∞—Ä–∞–∫—Ç–∞ —Å–∏—è“õ—Ç—ã –±–µ–ª–≥—ñ–ª–µ—Ä –±–∞—Ä –º–∞? –ö–µ–π–¥–µ –∞–¥–∞–º–¥–∞—Ä –∫–µ—à –±–∞–π“õ–∞–ø, –∂–∞“ì–¥–∞–π –∞—Å“õ—ã–Ω—ã–ø –∫–µ—Ç—ñ–ø –∂–∞—Ç–∞–¥—ã, —Å–æ–Ω–¥—ã“õ—Ç–∞–Ω –∞–ª–¥—ã–Ω –∞–ª–∞ —Å“±—Ä–∞–ø ‚Äî –∫”©–º–µ–∫ –∫”©—Ä—Å–µ—Ç–µ–π—ñ–∫",
    
    "1": "–ñ–∞–ª–ø—ã, –∫”©—Ä—É—ñ“£—ñ–∑–¥–µ “õ–∞–Ω–¥–∞–π ”©–∑–≥–µ—Ä—ñ—Å—Ç–µ—Ä –±–∞–π“õ–∞–¥—ã“£—ã–∑? –ë“±–ª–¥—ã—Ä–ª–∞—É, “±—Å–∞“õ ”ô—Ä—ñ–ø—Ç–µ—Ä–¥—ñ –∞–∂—ã—Ä–∞—Ç–∞ –∞–ª–º–∞—É, –∂–∞—Ä—ã“õ“õ–∞ “õ–∞—Ä–∞–π –∞–ª–º–∞–π “õ–∞–ª—É —Å–∏—è“õ—Ç—ã –±–∞—Ä –º–∞? üëÅÔ∏è –ö”©–ø –∞–¥–∞–º –º”ô–Ω –±–µ—Ä–º–µ–π –∂“Ø—Ä–µ –±–µ—Ä—ñ–ø, –∫–µ–π—ñ–Ω –æ–ø–µ—Ä–∞—Ü–∏—è“ì–∞ –∂“Ø–≥—ñ–Ω–µ–¥—ñ. –ï—Ä—Ç–µ –∞–Ω—ã“õ—Ç–∞–ª—Å–∞ ‚Äî —Ç–µ–∑ ”ô—Ä—ñ –∂–µ“£—ñ–ª –µ–º–¥–µ—É–≥–µ –±–æ–ª–∞–¥—ã.",
    
    "2": "–ë“±–ª “õ–∞—à–∞–Ω –±–∞—Å—Ç–∞–ª–¥—ã? –ë“±—Ä—ã–Ω –¥”ô—Ä—ñ–≥–µ—Ä–≥–µ “õ–∞—Ä–∞–ª–¥—ã“£—ã–∑ –±–∞? “ö–∞–Ω–¥–∞–π –µ–º –∂–∞—Å–∞–ø –∫”©—Ä–¥—ñ“£—ñ–∑? ‚è≥ü©∫ –ë—ñ—Ä –ø–∞—Ü–∏–µ–Ω—Ç—ñ–º—ñ–∑ –æ—Å—ã–ª–∞–π 3 –∞–π —Å–æ–∑—ã–ø –∂“Ø—Ä–¥—ñ –¥–µ, –∫–∞—Ç–∞—Ä–∞–∫—Ç–∞ –±–∞—Å—Ç–∞–ª—ã–ø, –∫”©–∑—ñ 60% “ì–∞ –Ω–∞—à–∞—Ä–ª–∞–¥—ã. –°–æ–ª “õ–∞—Ç–µ–ª—ñ–∫—Ç—ñ “õ–∞–π—Ç–∞–ª–∞–º–∞“ì–∞–Ω –∂”©–Ω ‚Äî –µ—Ä—Ç–µ “õ–æ–ª“ì–∞ –∞–ª—Å–∞“õ, –Ω”ô—Ç–∏–∂–µ ”ô–ª–¥–µ“õ–∞–π–¥–∞ –∂–∞“õ—Å—ã –±–æ–ª–∞–¥—ã.",
    
    "3": "–ö”©–∑ ‚Äî ”©—Ç–µ –Ω”ô–∑—ñ–∫ –º“Ø—à–µ. –£–∞“õ—ã—Ç—ã–Ω–¥–∞ “õ–∞–º –∂–∞—Å–∞–º–∞—Å–∞, –∞—Å“õ—ã–Ω—ã–ø –æ–ø–µ—Ä–∞—Ü–∏—è“ì–∞ –∞–ø–∞—Ä–∞–¥—ã. –ë—ñ—Ä–∞“õ –∂–∞“õ—Å—ã –∂–∞“£–∞–ª—ã“õ ‚Äî –¥“±—Ä—ã—Å –µ–º–¥—ñ –µ—Ä—Ç–µ –±–∞—Å—Ç–∞—Å–∞“£—ã–∑, –∫”©—Ä—É —Å–∞–ø–∞—Å—ã–Ω –∞–π—Ç–∞—Ä–ª—ã“õ—Ç–∞–π –∂–∞“õ—Å–∞—Ä—Ç—É“ì–∞ –±–æ–ª–∞–¥—ã. 45 –∂–∞—Å—Ç–∞“ì—ã –±—ñ—Ä –∫–ª–∏–µ–Ω—Ç—ñ–º—ñ–∑–¥–µ –∫–∞—Ç–∞—Ä–∫—Ç–∞–Ω—ã“£ –∞–ª“ì–∞—à“õ—ã –±–µ–ª–≥—ñ–ª–µ—Ä—ñ –±–æ–ª“ì–∞–Ω –µ–¥—ñ. –ï–º–¥—ñ —É–∞“õ—ã—Ç—ã–Ω–¥–∞ –±–∞—Å—Ç–∞–ø, “õ–∞–∑—ñ—Ä “õ–∞–π—Ç–∞ –∫”©–ª—ñ–∫ –∞–π–¥–∞–ø –∂“Ø—Ä.",
    
    "4": "–°—ñ–∑–≥–µ –Ω–∞“õ—Ç—ã –∫”©–º–µ–∫—Ç–µ—Å–µ—Ç—ñ–Ω ”©–Ω—ñ–º ‚Äî Healvix üåøüíä. 100% —Ç–∞–±–∏“ì–∏: “õ–∞—Ä–∞–∂–∏–¥–µ–∫, –ª—é—Ç–µ–∏–Ω, –∫–∞–ª—å—Ü–∏–π, E –≤–∏—Ç–∞–º–∏–Ω—ñ. –ë“±–ª –∂–∞–π –∫–∞–ø–ª—è –µ–º–µ—Å ‚Äî –∫”©–∑ —ñ—à—ñ–Ω–¥–µ–≥—ñ “õ–∞–Ω –∞–π–Ω–∞–ª—ã–º–¥—ã –∂–∞“õ—Å–∞—Ä—Ç—ã–ø, —Ç–æ—Ä “õ–∞–±—ã“õ—Ç—ã “õ–æ—Ä–µ–∫—Ç–µ–Ω–¥—ñ—Ä–µ–¥—ñ. 5000+ –∞–¥–∞–º“ì–∞ –∫”©–º–µ–∫—Ç–µ—Å—Ç—ñ–∫. –ö”©–ø—à—ñ–ª—ñ–≥—ñ 3 –∞–ø—Ç–∞–¥–∞-–∞“õ –æ“£ ”©–∑–≥–µ—Ä—ñ—Å—Ç—ñ –±–∞–π“õ–∞–ø –∂–∞—Ç—ã—Ä.",
    
    "5": "–ë–∞“ì–∞–ª–∞—Ä: 3 –∞–π ‚Äî 85 000‚Ç∏, 6 –∞–π ‚Äî 180 000‚Ç∏, 12 –∞–π ‚Äî 300 000‚Ç∏. –ë”©–ª—ñ–ø —Ç”©–ª–µ—É –±–∞—Ä: –∞–π—ã–Ω–∞ 18 750‚Ç∏ –Ω–µ–º–µ—Å–µ 9 375‚Ç∏. üéÅ “ö–∞–∑—ñ—Ä –∞–∫—Ü–∏—è –∂“Ø—Ä—ñ–ø –∂–∞—Ç—ã—Ä ‚Äî “õ–∞—Ä–∞ –∑–µ—Ä–µ –º–∞–π—ã –º–µ–Ω –∫”©–∑—ñ–ª–¥—ñ—Ä—ñ–∫ —Å—ã–π–ª—ã“õ“õ–∞. –ë“Ø–≥—ñ–Ω –∂–∞–∑—ã–ª—Å–∞“£—ã–∑, –æ—Å—ã –±–∞“ì–∞ –º–µ–Ω —Å—ã–π–ª—ã“õ—Ç–∞—Ä–¥—ã “±—Å—Ç–∞–ø “õ–∞–ª–∞–º—ã–∑.",
    
    "6": "–ö“Ø–º”ô–Ω –±–æ–ª—Å–∞, –∞—à—ã“õ –∞–π—Ç—ã“£—ã–∑ ‚Äî –±”ô—Ä—ñ–Ω —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä–µ–º. –ë–∞“ì–∞ –¥–µ—Å–µ“£—ñ–∑: —Ç–æ–π“ì–∞ –±—ñ—Ä –∫“Ø–Ω–¥–µ 20 –º—ã“£ –∂“±–º—Å–∞–π–º—ã–∑, –∞–ª –∫”©–∑ ‚Äî ”©–º—ñ—Ä –±–æ–π—ã “õ—ã–∑–º–µ—Ç –µ—Ç–µ—Ç—ñ–Ω –º“Ø—à–µ. –°–µ–Ω—ñ–º—Å—ñ–∑–¥—ñ–∫ –±–æ–ª—Å–∞ ‚Äî —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, –≥–∞—Ä–∞–Ω—Ç–∏—è, –∫–ª–∏–µ–Ω—Ç—Ç–µ—Ä–¥—ñ“£ –ø—ñ–∫—ñ—Ä–ª–µ—Ä—ñ –±–∞—Ä. –ê“õ—à–∞ —Ç–∞–ø—à—ã –±–æ–ª—Å–∞ ‚Äî –±”©–ª—ñ–ø —Ç”©–ª–µ—É –±–∞—Ä, –æ—Ç–±–∞—Å—ã–¥–∞–Ω –∫”©–º–µ–∫ —Å“±—Ä–∞—É“ì–∞ –±–æ–ª–∞–¥—ã. –ï“£ –¥“±—Ä—ã—Å—ã ‚Äî –µ–º–¥—ñ —Å–æ–∑–±–∞–π –±–∞—Å—Ç–∞—É. –°—ñ–∑–≥–µ —ã“£“ì–∞–π–ª—ã—Å—ã “õ–∞–π—Å—ã ‚Äî —Ç–æ–ª—ã“õ —Ç”©–ª–µ—É –º–µ, ”ô–ª–¥–µ –±”©–ª—ñ–ø —Ç”©–ª–µ—É –º–µ?"
}

def build_messages_for_gpt(state, user_msg):
    """–°—Ç—Ä–æ–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è GPT, –∏—Å–ø–æ–ª—å–∑—É—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ + —Ç–µ–∫—É—â—É—é —Å—Ç–∞–¥–∏—é."""
    prompt = SALES_SCRIPT_PROMPT + "\n\n" + STAGE_PROMPTS.get(state["stage"], "")
    messages = [{"role": "system", "content": prompt}]

    recent_history = state["history"][-MAX_HISTORY_FOR_GPT:] 
    for item in recent_history:
        u = item.get("user", "")
        b = item.get("bot", "")
        if u:
            messages.append({"role": "user", "content": u})
        if b:
            messages.append({"role": "assistant", "content": b})

    messages.append({"role": "user", "content": user_msg})
    return messages


def split_message(text, max_length=150):
    """–†–∞–∑–¥–µ–ª—è–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º –∏–ª–∏ –Ω–æ–≤—ã–º —Å—Ç—Ä–æ–∫–∞–º –¥–ª—è WhatsApp."""
    parts = []
    text = text.strip()
    while len(text) > max_length:
        split_index = max(text[:max_length].rfind("\n"), text[:max_length].rfind(". "))
        if split_index == -1 or split_index < max_length * 0.5:
            split_index = max_length
        parts.append(text[:split_index].strip())
        text = text[split_index:].lstrip()
    if text:
        parts.append(text)
    return parts


def send_whatsapp_message(phone, message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ WhatsApp —á–µ—Ä–µ–∑ 360dialog API."""
    payload = {"messaging_product": "whatsapp", "to": phone, "type": "text", "text": {"body": message}}
    try:
        response = requests.post(WHATSAPP_API_URL, headers=HEADERS, json=payload, timeout=15)
        print(f"üì§ –û—Ç–≤–µ—Ç WhatsApp: {getattr(response, 'status_code', '–Ω–µ—Ç_–æ—Ç–≤–µ—Ç–∞')}")
        return response
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ WhatsApp: {e}")
        return None


def get_gpt_response(user_msg, phone):
    """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç GPT, –¥–µ–ª–∏—Ç –ø–æ [SPLIT] –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∏–≤–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç."""
    if not AUTO_REPLY_ENABLED:
        print(f"‚ö† AUTO_REPLY_ENABLED = False, –æ—Ç–≤–µ—Ç –¥–ª—è {phone} –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
        return None  # –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

    state = get_client_state(phone)
    messages = build_messages_for_gpt(state, user_msg)
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=messages,
            temperature=0.75,
            top_p=0.9,
            frequency_penalty=0.4,
            presence_penalty=0.5,
            max_tokens=400
        )
        reply = response.choices[0].message.content.strip()
        return reply
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ GPT: {e}")
        return "–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, “õ–∞–∑—ñ—Ä –∂–∞—É–∞–ø –±–µ—Ä–µ –∞–ª–º–∞–π–º—ã–Ω."

    # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ [SPLIT] –∏–ª–∏ –ø–æ –¥–ª–∏–Ω–µ
    if "[SPLIT]" in reply:
        parts = [p.strip() for p in reply.split("[SPLIT]") if p.strip()]
    else:
        parts = split_message(reply, max_length=150)

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ—Ö —á–∞—Å—Ç–µ–π –≤ WhatsApp
    for part in parts:
        send_whatsapp_message(phone, part)

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
    try:
        next_stage_int = min(6, max(0, int(state["stage"])) + 1)
    except Exception:
        next_stage_int = 0
    next_stage = str(next_stage_int)

    new_history = list(state["history"]) + [{"user": user_msg, "bot": reply}]
    save_client_state(
        phone,
        stage=next_stage,
        history=new_history,
        last_time=time.time(),
        followed_up=False
    )

    return reply


# ==============================
# –ú–∞—Ä—à—Ä—É—Ç—ã Flask
# ==============================
@app.route('/webhook', methods=['POST'])
def webhook():
    data = request.get_json(silent=True) or {}
    print("üì© –í—Ö–æ–¥—è—â–∏–π JSON:", data)

    try:
        entry = (data.get("entry") or [{}])[0]
        changes = (entry.get("changes") or [{}])[0]
        value = changes.get("value") or {}
        messages = value.get("messages")
        contacts = value.get("contacts", [])

        if not messages:
            print("INFO: –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –≤–µ–±—Ö—É–∫–∞.")
            return jsonify({"status": "no_message"}), 200

        msg = messages[0]
        msg_id = msg["id"]

        if msg_id in PROCESSED_MESSAGES:
            print(f"‚è© –°–æ–æ–±—â–µ–Ω–∏–µ {msg_id} —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
            return jsonify({"status": "duplicate"}), 200
        PROCESSED_MESSAGES.add(msg_id)

        user_phone = normalize_phone_number(msg.get("from")) 
        user_msg = (msg.get("text") or {}).get("body", "")  # –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
        msg_type = msg.get("type")

        print(f"DEBUG: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_phone}, —Ç–∏–ø: {msg_type}, —Ç–µ–∫—Å—Ç: {user_msg}")

        if not user_phone:
            print(f"INFO: –°–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –Ω–æ–º–µ—Ä–∞ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º")
            return jsonify({"status": "ignored"}), 200

        # --- –ü–æ–ª—É—á–∞–µ–º –∏–º—è ---
        name = "–ö–ª–∏–µ–Ω—Ç"
        if contacts and isinstance(contacts, list):
            profile = (contacts[0] or {}).get("profile") or {}
            name = profile.get("name", "–ö–ª–∏–µ–Ω—Ç")

        # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ë–î ---
        client_in_bot_db = client_in_db_or_cache(user_phone)
        should_send_bot_reply = False

        if client_in_bot_db:
            print(f"DEBUG: –ö–ª–∏–µ–Ω—Ç {user_phone} –Ω–∞–π–¥–µ–Ω –≤ –ë–î –±–æ—Ç–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∏–∞–ª–æ–≥.")
            should_send_bot_reply = True
        else:
            crm_already_exists = client_exists(user_phone)
            if crm_already_exists:
                print(f"DEBUG: –ö–ª–∏–µ–Ω—Ç {user_phone} –Ω–∞–π–¥–µ–Ω –≤ CRM, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ë–î –±–æ—Ç–∞.")
                save_client_state(user_phone, name=name, in_crm=True)
                should_send_bot_reply = True
            else:
                print(f"DEBUG: –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç {user_phone}, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤ CRM.")
                process_new_lead(name, user_phone)
                should_send_bot_reply = False

        # --- –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ ---
        if should_send_bot_reply and msg_type == "text" and user_msg.strip():
            reply = get_gpt_response(user_msg.strip(), user_phone)
            for part in split_message(reply):
                send_whatsapp_message(user_phone, part)
        else:
            print(f"DEBUG: –û—Ç–≤–µ—Ç –±–æ—Ç–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è. CRM –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è {user_phone}")

        return jsonify({"status": "ok"}), 200

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ–±—Ö—É–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({"status": "error", "message": str(e)}), 500


@app.route('/salesrender-hook', methods=['POST'])
def salesrender_hook():
    print("=== –í—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ /salesrender-hook ===")
    try:
        data = request.get_json(silent=True) or {}
        print("–ü–æ–ª–µ–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:", json.dumps(data, indent=2, ensure_ascii=False))

        orders = (
            data.get("data", {}).get("orders")
            or data.get("orders")
            or [data] # –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å–ª–∏ —ç—Ç–æ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞ –Ω–∞–ø—Ä—è–º—É—é
        )

        if not orders or not isinstance(orders, list):
            return jsonify({"error": "–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç"}), 400

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ (–∏–ª–∏ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–∫–∞–∑–æ–≤) –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        threading.Thread(
            target=process_salesrender_order,
            args=(orders[0],),
            daemon=True
        ).start()

        return jsonify({"status": "accepted"}), 200
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤–µ–±—Ö—É–∫–∞: {e}")
        return jsonify({"error": str(e)}), 500


@app.route('/', methods=['GET'])
def home():
    return "Healvix –±–æ—Ç —ñ—Å–∫–µ “õ–æ—Å—ã–ª–¥—ã!", 200

# ==============================
# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω –∑–∞ –ø—Ä–µ–¥–µ–ª—ã if __name__ == "__main__" –¥–ª—è Gunicorn
# ==============================

print("DEBUG: –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–≤–Ω–µ if __name__).")
init_db() # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
print("DEBUG: init_db() –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–æ (–≤–Ω–µ if __name__).")
load_cache_from_db() # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –∫—ç—à
print("DEBUG: –ö—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –ë–î (–≤–Ω–µ if __name__).")

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏ –¥–ª—è follow-up –∏ –æ—á–∏—Å—Ç–∫–∏
threading.Thread(target=follow_up_checker, args=(send_whatsapp_message,), daemon=True).start()
print("DEBUG: –ü–æ—Ç–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ follow-up –∑–∞–ø—É—â–µ–Ω.")
threading.Thread(target=cleanup_old_clients, daemon=True).start()
print("DEBUG: –ü–æ—Ç–æ–∫ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω.")

if __name__ == "__main__":
    print("DEBUG: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ä–µ–∂–∏–º–µ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ 'python app.py'.")
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
